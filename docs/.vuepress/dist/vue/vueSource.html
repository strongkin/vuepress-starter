<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、Vue源码解析--响应式原理 | TS文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress-starter/images/good.png">
    <meta name="description" content="TS文档翻译">
    
    <link rel="preload" href="/vuepress-starter/assets/css/0.styles.e83b6921.css" as="style"><link rel="preload" href="/vuepress-starter/assets/js/app.9588c189.js" as="script"><link rel="preload" href="/vuepress-starter/assets/js/9.d0fd5d46.js" as="script"><link rel="preload" href="/vuepress-starter/assets/js/1.a4aa22ef.js" as="script"><link rel="preload" href="/vuepress-starter/assets/js/121.0f334874.js" as="script"><link rel="prefetch" href="/vuepress-starter/assets/js/10.1cb852e8.js"><link rel="prefetch" href="/vuepress-starter/assets/js/100.65cd0683.js"><link rel="prefetch" href="/vuepress-starter/assets/js/101.c8a5a32b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/102.8f399e2e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/103.4715dab9.js"><link rel="prefetch" href="/vuepress-starter/assets/js/104.8574db5a.js"><link rel="prefetch" href="/vuepress-starter/assets/js/105.5b6012f3.js"><link rel="prefetch" href="/vuepress-starter/assets/js/106.937c2ca7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/107.2723dfeb.js"><link rel="prefetch" href="/vuepress-starter/assets/js/108.1a70fd13.js"><link rel="prefetch" href="/vuepress-starter/assets/js/109.885e5fd1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/11.06f12993.js"><link rel="prefetch" href="/vuepress-starter/assets/js/110.ec5f9a22.js"><link rel="prefetch" href="/vuepress-starter/assets/js/111.9f8250f1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/112.2fe3a771.js"><link rel="prefetch" href="/vuepress-starter/assets/js/113.959b4949.js"><link rel="prefetch" href="/vuepress-starter/assets/js/114.eb69acc0.js"><link rel="prefetch" href="/vuepress-starter/assets/js/115.ae588179.js"><link rel="prefetch" href="/vuepress-starter/assets/js/116.42a2f92e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/117.e6d799a4.js"><link rel="prefetch" href="/vuepress-starter/assets/js/118.c70c254e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/119.7d8b62e7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/12.4c5e8861.js"><link rel="prefetch" href="/vuepress-starter/assets/js/120.12709ea5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/13.bd9f0f1b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/14.7cc99ea0.js"><link rel="prefetch" href="/vuepress-starter/assets/js/15.4afc449e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/16.51afb6e9.js"><link rel="prefetch" href="/vuepress-starter/assets/js/17.2fc5316e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/18.0b0a5722.js"><link rel="prefetch" href="/vuepress-starter/assets/js/19.c820b68e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/2.27084988.js"><link rel="prefetch" href="/vuepress-starter/assets/js/20.eb870127.js"><link rel="prefetch" href="/vuepress-starter/assets/js/21.99237387.js"><link rel="prefetch" href="/vuepress-starter/assets/js/22.6f1a6770.js"><link rel="prefetch" href="/vuepress-starter/assets/js/23.86e35e17.js"><link rel="prefetch" href="/vuepress-starter/assets/js/24.8dfe7e9e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/25.d2ea21b1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/26.691591b2.js"><link rel="prefetch" href="/vuepress-starter/assets/js/27.997da69b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/28.febaebbd.js"><link rel="prefetch" href="/vuepress-starter/assets/js/29.6703e8e8.js"><link rel="prefetch" href="/vuepress-starter/assets/js/30.e95b0160.js"><link rel="prefetch" href="/vuepress-starter/assets/js/31.8eebb916.js"><link rel="prefetch" href="/vuepress-starter/assets/js/32.2650fb57.js"><link rel="prefetch" href="/vuepress-starter/assets/js/33.21a382e6.js"><link rel="prefetch" href="/vuepress-starter/assets/js/34.8743457f.js"><link rel="prefetch" href="/vuepress-starter/assets/js/35.d083b201.js"><link rel="prefetch" href="/vuepress-starter/assets/js/36.03e22d87.js"><link rel="prefetch" href="/vuepress-starter/assets/js/37.d42d7eb8.js"><link rel="prefetch" href="/vuepress-starter/assets/js/38.6d4c21ec.js"><link rel="prefetch" href="/vuepress-starter/assets/js/39.e50e674d.js"><link rel="prefetch" href="/vuepress-starter/assets/js/4.bfd7c17c.js"><link rel="prefetch" href="/vuepress-starter/assets/js/40.df9147f4.js"><link rel="prefetch" href="/vuepress-starter/assets/js/41.b9dbd9c8.js"><link rel="prefetch" href="/vuepress-starter/assets/js/42.14961272.js"><link rel="prefetch" href="/vuepress-starter/assets/js/43.c52c94eb.js"><link rel="prefetch" href="/vuepress-starter/assets/js/44.18ad7ef1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/45.dde77433.js"><link rel="prefetch" href="/vuepress-starter/assets/js/46.faac0ec5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/47.68cb02e1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/48.e06d18c1.js"><link rel="prefetch" href="/vuepress-starter/assets/js/49.3ef19540.js"><link rel="prefetch" href="/vuepress-starter/assets/js/5.96e99ac8.js"><link rel="prefetch" href="/vuepress-starter/assets/js/50.53ef320a.js"><link rel="prefetch" href="/vuepress-starter/assets/js/51.35a7a08f.js"><link rel="prefetch" href="/vuepress-starter/assets/js/52.3bc70bad.js"><link rel="prefetch" href="/vuepress-starter/assets/js/53.b8152f0a.js"><link rel="prefetch" href="/vuepress-starter/assets/js/54.57ca6a3e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/55.ddc626b3.js"><link rel="prefetch" href="/vuepress-starter/assets/js/56.2e7012a6.js"><link rel="prefetch" href="/vuepress-starter/assets/js/57.414850ba.js"><link rel="prefetch" href="/vuepress-starter/assets/js/58.bb9c31d7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/59.19424dab.js"><link rel="prefetch" href="/vuepress-starter/assets/js/6.08009833.js"><link rel="prefetch" href="/vuepress-starter/assets/js/60.850fcda4.js"><link rel="prefetch" href="/vuepress-starter/assets/js/61.394b2c5d.js"><link rel="prefetch" href="/vuepress-starter/assets/js/62.192362bb.js"><link rel="prefetch" href="/vuepress-starter/assets/js/63.e046621c.js"><link rel="prefetch" href="/vuepress-starter/assets/js/64.ba4336a5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/65.d97e98a6.js"><link rel="prefetch" href="/vuepress-starter/assets/js/66.f28fa041.js"><link rel="prefetch" href="/vuepress-starter/assets/js/67.07030ede.js"><link rel="prefetch" href="/vuepress-starter/assets/js/68.512cb88e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/69.e792e760.js"><link rel="prefetch" href="/vuepress-starter/assets/js/7.b29f260f.js"><link rel="prefetch" href="/vuepress-starter/assets/js/70.8eba790c.js"><link rel="prefetch" href="/vuepress-starter/assets/js/71.4bb44bb9.js"><link rel="prefetch" href="/vuepress-starter/assets/js/72.5aada06b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/73.86570555.js"><link rel="prefetch" href="/vuepress-starter/assets/js/74.6c9461e0.js"><link rel="prefetch" href="/vuepress-starter/assets/js/75.c3f94c54.js"><link rel="prefetch" href="/vuepress-starter/assets/js/76.0c0a0883.js"><link rel="prefetch" href="/vuepress-starter/assets/js/77.c066f6e7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/78.62a7e98a.js"><link rel="prefetch" href="/vuepress-starter/assets/js/79.e7ac8531.js"><link rel="prefetch" href="/vuepress-starter/assets/js/8.e41ded69.js"><link rel="prefetch" href="/vuepress-starter/assets/js/80.63233980.js"><link rel="prefetch" href="/vuepress-starter/assets/js/81.6bdb5931.js"><link rel="prefetch" href="/vuepress-starter/assets/js/82.092fe8c0.js"><link rel="prefetch" href="/vuepress-starter/assets/js/83.3821338f.js"><link rel="prefetch" href="/vuepress-starter/assets/js/84.aeac8e75.js"><link rel="prefetch" href="/vuepress-starter/assets/js/85.721b85d6.js"><link rel="prefetch" href="/vuepress-starter/assets/js/86.ff1fa601.js"><link rel="prefetch" href="/vuepress-starter/assets/js/87.5c91c62d.js"><link rel="prefetch" href="/vuepress-starter/assets/js/88.9f633d01.js"><link rel="prefetch" href="/vuepress-starter/assets/js/89.f435f958.js"><link rel="prefetch" href="/vuepress-starter/assets/js/90.79a1fc89.js"><link rel="prefetch" href="/vuepress-starter/assets/js/91.3217d3b7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/92.10f97f55.js"><link rel="prefetch" href="/vuepress-starter/assets/js/93.2ff4b874.js"><link rel="prefetch" href="/vuepress-starter/assets/js/94.96dcb585.js"><link rel="prefetch" href="/vuepress-starter/assets/js/95.98fc6c5e.js"><link rel="prefetch" href="/vuepress-starter/assets/js/96.b5328e52.js"><link rel="prefetch" href="/vuepress-starter/assets/js/97.01395395.js"><link rel="prefetch" href="/vuepress-starter/assets/js/98.53140f5b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/99.d0f7d03c.js">
    <link rel="stylesheet" href="/vuepress-starter/assets/css/0.styles.e83b6921.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>TS文档</h3> <p class="description" data-v-59e6cb88>TS文档翻译</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2022
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-starter/" class="home-link router-link-active"><img src="/vuepress-starter/images/good.png" alt="TS文档" class="logo"> <span class="site-name">TS文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-starter/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/vuepress-starter/page/js/" class="nav-link"><i class="undefined"></i>
  面试集合
</a></div><div class="nav-item"><a href="/vuepress-starter/handbook/ConditionalTypes.html" class="nav-link"><i class="undefined"></i>
  vue组件
</a></div><div class="nav-item"><a href="/vuepress-starter/vue/vuebase.html" class="nav-link"><i class="undefined"></i>
  vue学习
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
       JavaScript 博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/strongkin" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/vuepress-starter/images/good.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>105</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-starter/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><a href="/vuepress-starter/page/js/" class="nav-link"><i class="undefined"></i>
  面试集合
</a></div><div class="nav-item"><a href="/vuepress-starter/handbook/ConditionalTypes.html" class="nav-link"><i class="undefined"></i>
  vue组件
</a></div><div class="nav-item"><a href="/vuepress-starter/vue/vuebase.html" class="nav-link"><i class="undefined"></i>
  vue学习
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
       JavaScript 博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/strongkin" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>vue学习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-starter/vue/vuebase.html" class="sidebar-link">vue基础</a></li><li><a href="/vuepress-starter/vue/vuex.html" class="sidebar-link">vuex</a></li><li><a href="/vuepress-starter/vue/vueRouter.html" class="sidebar-link">vueRouter路由</a></li><li><a href="/vuepress-starter/vue/vueSource.html" aria-current="page" class="active sidebar-link">vue源码</a></li><li><a href="/vuepress-starter/vue/vueInterview.html" class="sidebar-link">vue面试</a></li><li><a href="/vuepress-starter/vue/vue3.html" class="sidebar-link">vue3</a></li><li><a href="/vuepress-starter/vue/vueVirtualDom.html" class="sidebar-link">虚拟DOM</a></li><li><a href="/vuepress-starter/vue/vueResponed.html" class="sidebar-link">响应式原理</a></li><li><a href="/vuepress-starter/vue/Pinia.html" class="sidebar-link">pinia</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>人力管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-starter/vue/hrsaas/01-vuex基础.html" class="sidebar-link">vuex基础</a></li><li><a href="/vuepress-starter/vue/hrsaas/02-基础环境搭建.html" class="sidebar-link">基础环境搭建</a></li><li><a href="/vuepress-starter/vue/hrsaas/03-登录模块.html" class="sidebar-link">登录模块</a></li><li><a href="/vuepress-starter/vue/hrsaas/04-主页模块.html" class="sidebar-link">主页模块</a></li><li><a href="/vuepress-starter/vue/hrsaas/05-路由和页面.html" class="sidebar-link">路由和页面</a></li><li><a href="/vuepress-starter/vue/hrsaas/06-组织架构.html" class="sidebar-link">组织架构</a></li><li><a href="/vuepress-starter/vue/hrsaas/07-公司和角色.html" class="sidebar-link">公司和角色</a></li><li><a href="/vuepress-starter/vue/hrsaas/08-员工管理.html" class="sidebar-link">员工管理</a></li><li><a href="/vuepress-starter/vue/hrsaas/09-权限设计和管理.html" class="sidebar-link">权限设计和管理</a></li><li><a href="/vuepress-starter/vue/hrsaas/10-其他模块集成.html" class="sidebar-link">其他模块集成</a></li><li><a href="/vuepress-starter/vue/hrsaas/11-主页审批-图表.html" class="sidebar-link">主页审批-图表</a></li><li><a href="/vuepress-starter/vue/hrsaas/12-多语言tab页全屏主题.html" class="sidebar-link">多语言tab页全屏主题</a></li><li><a href="/vuepress-starter/vue/hrsaas/13-打包上线.html" class="sidebar-link">打包上线</a></li><li><a href="/vuepress-starter/vue/hrsaas/Element表单校验补充.html" class="sidebar-link">Element表单校验补充</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>小兔仙</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-starter/vue/rabbit/00-vue3入门.html" class="sidebar-link">vue3入门</a></li><li><a href="/vuepress-starter/vue/rabbit/01-项目介绍.html" class="sidebar-link">项目介绍</a></li><li><a href="/vuepress-starter/vue/rabbit/02-项目起步.html" class="sidebar-link">项目起步</a></li><li><a href="/vuepress-starter/vue/rabbit/03-首页模块-Layout.html" class="sidebar-link">首页模块-Layout</a></li><li><a href="/vuepress-starter/vue/rabbit/04-首页模块-main主体.html" class="sidebar-link">首页模块-main主体</a></li><li><a href="/vuepress-starter/vue/rabbit/05-分类模块.html" class="sidebar-link">分类模块</a></li><li><a href="/vuepress-starter/vue/rabbit/06-详情模块.html" class="sidebar-link">详情模块</a></li><li><a href="/vuepress-starter/vue/rabbit/07-登录模块.html" class="sidebar-link">登录模块</a></li><li><a href="/vuepress-starter/vue/rabbit/08-购物车模块.html" class="sidebar-link">购物车模块</a></li><li><a href="/vuepress-starter/vue/rabbit/09-结算中心模块.html" class="sidebar-link">结算中心模块</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2022
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page" style="padding-right:0;"><section style="display:;"><div class="page-title"><h1 class="title">一、Vue源码解析--响应式原理</h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="一、vue源码解析-响应式原理"><a href="#一、vue源码解析-响应式原理" class="header-anchor">#</a> 一、<code>Vue</code>源码解析--响应式原理</h1> <h1 id="_1、课程目标"><a href="#_1、课程目标" class="header-anchor">#</a> 1、课程目标</h1> <ul><li><code>Vue.js</code>的静态成员和实例成员初始化过程</li> <li>​	首次渲染的过程</li> <li>数据响应式原理</li></ul> <h1 id="_2、准备工作"><a href="#_2、准备工作" class="header-anchor">#</a> 2、准备工作</h1> <p><code>Vue</code>源码的获取</p> <p>项目地址：<code>https://github.com/vuejs/vue</code></p> <p>为什么分析<code>Vue2.6</code>? 新的版本发布后，现有项目不会升级到<code>3.0</code>,<code>2.x</code>还有很长的一段过渡期。</p> <p><code>3.0</code>项目地址<code>https://github.com/vuejs/vue-next</code></p> <p>源码目录结构(在<code>src</code>目录下面定义的就是源码内容)：</p> <div class="language- extra-class"><pre class="language-text"><code>compiler: 编译相关（主要作用:就是把模板转换成render函数，在render函数中创建虚拟DOM）
core:Vue核心库
platforms:平台相关代码,web:基于web的开发，weex是基于移动端的开发
server:SSR，服务端渲染
sfc:将.vue文件编译为js对象
shared:公共的代码
</code></pre></div><p>​     在<code>core</code>目录是<code>Vue</code>的核心库，在<code>core</code>目录下面，也定义了很多的文件夹，下面我们先简单来看一下。</p> <p><code>components</code>目录下面定义的是<code>keep-alive.js</code>组件。</p> <p><code>global-api</code>:定义的是<code>Vue</code>中的静态方法。<code>vue.filter</code>,<code>vue.extend</code>,<code>vue.mixin</code>,<code>vue.use</code>等。</p> <p><code>Instance</code>:创建<code>vue</code>的实例，定义了<code>Vue</code>的构造函数，初始化，以及生命周期的钩子函数等。</p> <p><code>observer</code>:定义响应式机制的位置，</p> <p><code>util</code>:定义公共成员。</p> <p><code>vodom</code>:定义虚拟<code>DOM</code></p> <h1 id="_3、打包"><a href="#_3、打包" class="header-anchor">#</a> 3、打包</h1> <p>这里我们来介绍一下，关于<code>Vue</code>源码中使用的打包方式。</p> <p>打包工具<code>Rollup</code></p> <p><code>Vue.js</code> 所使用的打包工具为<code>Rollup</code>,<code>Rollup</code>比<code>Webpack</code>更加轻量，<code>Webpack</code>是把所有的文件（例如：图片文件，样式等）当作模块进行打包，<code>Rollup</code>只处理<code>js</code>文件，所以<code>Rollup</code>更适合在<code>Vue.js</code>这样的库中进行使用。</p> <p><code>Rollup</code>打包不会生成冗余的代码，如果是<code>Webpack</code>打包，那么会生成一些浏览器支持模块化的代码。</p> <p>以上就是<code>Webpack</code>与<code>Rollup</code>之间的区别。根据以上的讲解，其实我们可以总结出，<code>Rollup</code>更适合在库的开发中使用，<code>Webpack</code>更适合在项目开发中使用，所以它们各自有自己的应用场景。</p> <p>下面看一下打包的步骤:</p> <p>第一步：安装依赖</p> <div class="language- extra-class"><pre class="language-text"><code>npm i
</code></pre></div><p>第二步设置:<code>sourcemap</code></p> <p><code>sourcemap</code>是代码地图，在<code>sourcemap</code>中记录了打包后的代码与源码之间的对应关系。如果出错了，也会告诉我们源码中的第几行出错了。怎样设置<code>sourcemap</code>呢？在<code>package.json</code> 文件中的<code>dev</code>脚本中添加<code>--sourcemap</code>.</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;dev&quot;: &quot;rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev&quot;,
</code></pre></div><p>第三步:执行<code>dev</code>,运行<code>npm run dev</code>执行打包，用的是<code>rollup</code>,<code>-w</code> 参数是监听源码文件的变化，源码文件变化后自动的重新进行打包。<code>-c</code>是设置配置文件，<code>scripts/config.js</code>就是配置文件,<code>environment</code>环境变量，通过后面设置的值，来打包生成不同版本的<code>Vue</code>.<code>web-full-dev</code>:<code>web</code>:指的是打包<code>web</code>平台下的，<code>full</code>:表示完整版，包含了编译器与运行时，<code>dev</code>:表示的是开发版本，不会对代码进行压缩。</p> <p><code>web-runtime-cjs-dev</code>: <code>runtime</code>:表示运行时，<code>cjs</code>：表示<code>CommonJS</code>模块。</p> <p>在执行<code>npm run dev</code>进行打包之前，可以先来看一下<code>dist</code>目录，该目录下面已经有很多的<code>js</code>文件，这些文件针对的是不同版本的<code>Vue</code>.那么为了更好的看到，执行<code>npm run dev</code>命令后的打包效果，在这里可以将这些文件先删除掉。</p> <h1 id="_4、vue不同版本说明"><a href="#_4、vue不同版本说明" class="header-anchor">#</a> 4、Vue不同版本说明</h1> <p><code>https://cn.vuejs.org/v2/guide/installation.html#对不同构建版本的解释</code></p> <p>完整版：同时包含<code>编译器</code>和<code>运行时</code>版本。</p> <p>​              什么是编译器？用来将模板字符串编译成为<code>javascript</code>渲染函数(<code>render</code>函数，<code>render</code>函数用来生成虚拟<code>DOM</code>)的代码，体积大，效率低。</p> <p>​			什么是运行时？用来创建<code>Vue</code>实例，渲染并处理虚拟<code>DOM</code>等的代码，体积小，效率高，基本上就是除去编译器的代码。</p> <p>还有一点需要说明的是：<code>Vue</code>包含了不同的模块化方式。</p> <p><code>UMD</code>:指的是通用的模块版本，支持多种模块方式，<code>UMD</code> 版本可以通过 <code>&lt;script&gt;</code> 标签直接用在浏览器中</p> <p><strong><a href="http://wiki.commonjs.org/wiki/Modules/1.1" target="_blank" rel="noopener noreferrer">CommonJS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>：<code>CommonJS</code>版本用来配合老的打包工具比如<code>[Browserify</code>](http://browserify.org/) 或<code>[webpack 1</code>](https://webpack.github.io/)</p> <p><strong><a href="http://exploringjs.com/es6/ch_modules.html" target="_blank" rel="noopener noreferrer"><code>ES Module</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong>：从 2.6 开始 <code>Vue</code>会提供两个 <code>ES Modules (ESM，也是ES6的模块化方式，这时标准的模块化方式，后期会使用该方式替换其它的模块化方式)</code> 构建文件：</p> <ul><li>为打包工具提供的<code>ESM</code>：为诸如 <code>[webpack 2](https://webpack.js.org/)</code> 或 <code>[Rollup]</code>(https://rollupjs.org/) 提供的现代打包工具。<code>ESM</code> 格式被设计为可以被静态分析(在编译的时候进行代码的处理也就是解析模块之间的依赖，而不是运行时)，所以打包工具可以利用这一点来进行“tree-shaking”并将用不到的代码排除出最终的包。为这些打包工具提供的默认文件 (<code>pkg.module</code>) 是只有运行时的 <code>ES Module</code> 构建 (<code>vue.runtime.esm.js</code>)。</li> <li>为浏览器提供的 <code>ESM</code>(2.6+)：用于在现代浏览器中通过 <code>&lt;script type=&quot;module&quot;&gt;</code> 直接导入。</li></ul> <p>如果使用<code>vue-cli</code>创建的项目，默认的就是运行时版本，并且使用的是<code>ES6</code>的模块化方式。</p> <p>同时使用<code>vue-cli</code>创建的项目中，有很多的<code>.vue</code>文件，而这些文件浏览器是不支持的，所以在打包的时候，会将这些单文件转换成<code>js</code>对象，在转换<code>js</code>对象的过程中，会将<code>.vue</code>文件中的<code>template</code>转换成<code>render</code>函数。</p> <p>所以单文件组件在运行的时候也是不需要编译器的。</p> <h1 id="_5、寻找入口文件"><a href="#_5、寻找入口文件" class="header-anchor">#</a> 5、寻找入口文件</h1> <p>查看<code>vue</code>的源码，就需要找到对应的入口文件。</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;dev&quot;: &quot;rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev&quot;,
</code></pre></div><p>可以从<code>srcipts/config.js</code>这个配置文件中进行查找。</p> <p>该配置文件中的内容是比较多的。所以可以看一下文件的底部，底部导出了相应的内容、</p> <p>如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//判断环境变量是否有`TARGET`</span>
<span class="token comment">//如果有的话，使用`genConfig()`生成`rollup`配置文件。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">genConfig</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span>getBuild <span class="token operator">=</span> genConfig
  exports<span class="token punctuation">.</span><span class="token function-variable function">getAllBuilds</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>builds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>genConfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面，我们看一下<code>genConfig</code>方法的代码实现</p> <p>在<code>getConfig</code>方法中有一行代码如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">const</span> opts <span class="token operator">=</span> builds<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
</code></pre></div><p>我们看到在<code>builds</code>这个对象中，该对象中的属性就是：环境变量的值。</p> <p>由于在<code>package.json</code>文件中，关于<code>dev</code>的配置中的环境变量的值为<code>web-full-dev</code>.</p> <p>所以下面，我们在<code>builds</code>对象中查找该属性对应的内容。</p> <p>具体内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// Runtime+compiler development build (Browser)</span>
  <span class="token string-property property">'web-full-dev'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">//表示入口文件，我们查找的就是该文件。</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'web/entry-runtime-with-compiler.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//出口，打包后的目标文件</span>
    <span class="token literal-property property">dest</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'dist/vue.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">//模块化的方式，这里是umd</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
        <span class="token comment">//打包方式，env的取值可以是开发模式或者是生产模式</span>
    <span class="token literal-property property">env</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
        <span class="token comment">//别名，这里先不用关系</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">he</span><span class="token operator">:</span> <span class="token string">'./entity-decoder'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//表示的就是文件的头，打包好的文件的头部信息。</span>
    banner
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在<code>web-full-dev</code>中定义的就是在打包的时候，需要的一些配置的基本信息。</p> <p>通过以上代码的注意，我们知道，<code>web-full-dev</code>打包的是完整版，包含了运行时与编译器。</p> <p>下面我们来看一下，入口文件，入口文件的地址为<code>web/entry-runtime-with-compiler.js</code>, 但是问题是在<code>scripts</code>目录中，我们没有发现<code>web</code>目录，我们进入<code>reslove</code>方法看一下，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> aliases <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./alias'</span><span class="token punctuation">)</span><span class="token comment">//导入alias模块</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">p</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//根据传递过来的参数，安装`/`进行分隔，然后获取第一项内容。</span>
    <span class="token comment">//很明显这里获取的是 web</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token comment">//根据获取到的`web`,从aliases中获取一个值，下面看一下aliases中的内容。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//aliases[base]的值:src/platforms/web</span>
      <span class="token comment">// p的值为：web/entry-runtime-with-compiler.js</span>
      <span class="token comment">//p.slice(base.length + 1)：获取到的就是entry-runtime-with-compiler.js</span>
      <span class="token comment">//整个返回的内容是：src/platforms/web/entry-runtime-with-compiler.js 的绝对路径并返回</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>aliases<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>aliases</code>中的内容定义在<code>scripts/alias.js</code>文件，具体的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">p</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">vue</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web/entry-runtime-with-compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">compiler</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/compiler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">core</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/core'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/shared'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">web</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/web'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">weex</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/platforms/weex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/server'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sfc</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/sfc'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre></div><p>通过上面的代码，我们可以看到这里是通过<code>path.resolve</code>获取到了当前的绝对路径，并且是在<code>scripts</code>目录的上一级<code>src</code>下面去查找<code>platforms/web</code>目录中的内容。</p> <p>下面我们继续来看一下<code>genConfig</code>方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">genConfig</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取到了关于配置的基础信息</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> builds<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  <span class="token comment">//config对象就是所有的配置信息</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">input</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>entry<span class="token punctuation">,</span><span class="token comment">//入口</span>
    <span class="token literal-property property">external</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>external<span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">flow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">alias</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> aliases<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>alias<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>plugins <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">file</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>dest<span class="token punctuation">,</span><span class="token comment">//出口</span>
      <span class="token literal-property property">format</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>format<span class="token punctuation">,</span>
      <span class="token literal-property property">banner</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>banner<span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> opts<span class="token punctuation">.</span>moduleName <span class="token operator">||</span> <span class="token string">'Vue'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onwarn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> warn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Circular</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// built-in vars</span>
  <span class="token keyword">const</span> vars <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">__WEEX__</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>weex<span class="token punctuation">,</span>
    <span class="token literal-property property">__WEEX_VERSION__</span><span class="token operator">:</span> weexVersion<span class="token punctuation">,</span>
    <span class="token literal-property property">__VERSION__</span><span class="token operator">:</span> version
  <span class="token punctuation">}</span>
  <span class="token comment">// feature flags</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>featureFlags<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vars<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">process.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> featureFlags<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// build-specific env</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vars<span class="token punctuation">[</span><span class="token string">'process.env.NODE_ENV'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>env<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span>vars<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>transpile <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">buble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token string">'_name'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> name
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//将配置信息返回</span>
  <span class="token keyword">return</span> config
<span class="token punctuation">}</span>

</code></pre></div><h1 id="_6、从入口开始"><a href="#_6、从入口开始" class="header-anchor">#</a> 6、从入口开始</h1> <p>通过上一小节的内容，我们已经找到了对应的入口文件<code>src/platform/web/entry-runtime-with-compiler.js</code></p> <p>下面我们要对入口文件进行分析，在分析的过程中，我们要解决一个问题，如下代码所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
<span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'&lt;h3&gt;hello template&lt;/h3&gt;'</span>
<span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'h4'</span><span class="token punctuation">,</span><span class="token string">'hello render'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>在上面的代码中，我们在创建<code>Vue</code>的实例的时候，同时指定了<code>template</code>与<code>render</code>，那么会渲染执行哪个内容？</p> <p>一会我们通过查看源码来解决这个问题。</p> <p>下面我们打开入口文件。</p> <p>先来看一下<code>$mount</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//保留Vue实例的$mount方法</span>
<span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token punctuation">;</span>
<span class="token comment">//$mout:挂载，作用就是把生成的DOM挂载到页面中。</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  <span class="token comment">//非ssr情况下为false,ssr的时候为true</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  <span class="token comment">//获取el选项，创建vue实例的时候传递过来的选项。</span>
  <span class="token comment">//el就是DOM对象。</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token comment">//如果el为body或者是html,并且是开发环境，那么会在浏览器的控制台</span>
  <span class="token comment">//中输出不能将Vue的实例挂载到&lt;html&gt;或者是&lt;body&gt;标签上</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//直接返回vue的实例</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//获取options选项</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token comment">// resolve template/el and convert to render function</span>
  <span class="token comment">//判断options中是否有render(在创建vue实例的时候，也就new Vue的时候是否传递了render函数)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//没有传递render函数。获取template模板，然后将其转换成render函数</span>
    <span class="token comment">//关于将`template`转换成render的代码比较多，目录先知道其主要作用就可以了</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果是id选择器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取对应的DOM对象的innerHTML,作为模板</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* istanbul ignore if */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              <span class="token keyword">this</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果模板是元素，返回元素的innerHTML</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//如果不是字符串，也不是元素，在开发环境中会给出警告信息，模板不合法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;invalid template option:&quot;</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
          <span class="token comment">//返回Vue实例。</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果选项中没有设置template模板，那么获取el的outerHTML 作为模板。</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token comment">//把template模板编译成render函数</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>
        template<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
          shouldDecodeNewlines<span class="token punctuation">,</span>
          shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
          <span class="token literal-property property">delimiters</span><span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
          <span class="token literal-property property">comments</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns<span class="token punctuation">;</span>

      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> compile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;compile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果创建 Vue实例的时候，传递了render函数，这时会直接调用mount方法。</span>
  <span class="token comment">// mount方法的作用就是渲染DOM,这块内容在下一小节会讲解到。</span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


</code></pre></div><p>下面代码是<code>query</code>方法实现的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Query an element selector if it's not an element already.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> string <span class="token operator">|</span> Element</span><span class="token punctuation">)</span><span class="token operator">:</span> Element <span class="token punctuation">{</span>
  <span class="token comment">// 如果el等于字符串，表明是选择器。</span>
  <span class="token comment">//否则是DOM对象，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> el <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取对应的DOM元素</span>
    <span class="token keyword">const</span> selected <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果没有找到，判断是否为开发模式，如果是开发模式</span>
      <span class="token comment">//在控制台打印“找不到元素”</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot find element: &quot;</span> <span class="token operator">+</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//这时会创建一个`div`元素返回。</span>
      <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//返回找到的dom元素</span>
    <span class="token keyword">return</span> selected<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> el<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>看完上面的代码后，我们就可以回答最开始的时候，提出的问题，如果传递了<code>render</code>函数，是不会处理<code>template</code>这个模板的，直接调用<code>mount</code>方法渲染<code>dom</code></p> <p>现在面临的一个问题就是<code>$mount</code>这个方法是在哪儿被调用的呢？</p> <p>在<code>core/instance/init.js</code>文件中，查找到如下代码：</p> <div class="language- extra-class"><pre class="language-text"><code> if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }

</code></pre></div><p>通过以上代码，可以看到调用了<code>$mount</code>方法。</p> <p>也就是在<code>Vue._init</code>方法中调用的。</p> <p>那么<code>_init</code>方法是在哪被调用的呢？
在<code>core/instance/index.js</code>文件中、</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre></div><p>通过以上的代码，可以看到在<code>Vue</code>这个方法中调用了<code>_init</code>方法，而<code>Vue</code>方法，是在创建<code>Vue</code>实例的时候被调用的。所以上面的<code>Vue</code>方法就是一个构造函数。</p> <p>现在我们将以上的内容做一个总结，重点是以下三点内容。</p> <ul><li><code>el</code>不能是<code>body</code> 或者是<code>html</code>标签</li> <li>如果没有<code>render</code>，把<code>template</code>转换成<code>render</code>函数。</li> <li>如果有<code>render</code>方法，直接调用<code>mount</code>挂载<code>DOM</code></li></ul> <h1 id="_7、vue的初始化过程"><a href="#_7、vue的初始化过程" class="header-anchor">#</a> 7、Vue的初始化过程</h1> <p>在这一小节中，我们需要考虑如下的一个问题。</p> <p><code>Vue</code>实例成员和<code>Vue</code>的静态成员是从哪里来的？</p> <p>在<code>src/platforms/web</code>目录下面定义的文件都是与平台有关的文件。</p> <p>下面我们还是看一下开始文件：<code>entry-runtime-with-compiler.js</code>文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;core/config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> warn<span class="token punctuation">,</span> cached <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;core/util/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mark<span class="token punctuation">,</span> measure <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;core/util/perf&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//导入Vue的构造函数</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&quot;./runtime/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> query <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> compileToFunctions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./compiler/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  shouldDecodeNewlines<span class="token punctuation">,</span>
  shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./util/compat&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> idToTemplate <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> el <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//保留Vue实例的$mount方法，方便下面重写$mount的功能</span>
<span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token punctuation">;</span>
<span class="token comment">//$mout:挂载，作用就是把生成的DOM挂载到页面中。</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  <span class="token comment">//非ssr情况下为false,ssr的时候为true</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  <span class="token comment">//获取el选项，创建vue实例的时候传递过来的选项。</span>
  <span class="token comment">//el就是DOM对象。</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token comment">//如果el为body或者是html,并且是开发环境，那么会在浏览器的控制台</span>
  <span class="token comment">//中输出不能将Vue的实例挂载到&lt;html&gt;或者是&lt;body&gt;标签上</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el <span class="token operator">===</span> document<span class="token punctuation">.</span>body <span class="token operator">||</span> el <span class="token operator">===</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//直接返回vue的实例</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//获取options选项</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
  <span class="token comment">// resolve template/el and convert to render function</span>
  <span class="token comment">//判断options中是否有render(在创建vue实例的时候，也就new Vue的时候是否传递了render函数)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//没有传递render函数。获取template模板，然后将其转换成render函数</span>
    <span class="token comment">//关于将`template`转换成render的代码比较多，目录先知道其主要作用就可以了</span>
    <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template<span class="token punctuation">;</span>
    <span class="token comment">// 如果模板存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//判断对应的类型如果是字符串</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果模板是id选择器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;#&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//获取对应的DOM对象的innerHTML</span>
          template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">/* istanbul ignore if */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Template element not found or is empty: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span>template<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
              <span class="token keyword">this</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果模板是元素，返回元素的innerHTML</span>
        template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;invalid template option:&quot;</span> <span class="token operator">+</span> template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果模板不存在</span>
      template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token comment">//把template模板编译成render函数</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> staticRenderFns <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>
        template<span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">outputSourceRange</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
          shouldDecodeNewlines<span class="token punctuation">,</span>
          shouldDecodeNewlinesForHref<span class="token punctuation">,</span>
          <span class="token literal-property property">delimiters</span><span class="token operator">:</span> options<span class="token punctuation">.</span>delimiters<span class="token punctuation">,</span>
          <span class="token literal-property property">comments</span><span class="token operator">:</span> options<span class="token punctuation">.</span>comments<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>render <span class="token operator">=</span> render<span class="token punctuation">;</span>
      options<span class="token punctuation">.</span>staticRenderFns <span class="token operator">=</span> staticRenderFns<span class="token punctuation">;</span>

      <span class="token comment">/* istanbul ignore if */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> compile</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;compile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;compile end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果创建 Vue实例的时候，传递了render函数，这时会直接调用mount方法。</span>
  <span class="token comment">// mount方法的作用就是渲染DOM，这里的mount就是下面我们要看的./runtime/index文件中的$mount,只不过</span>
   <span class="token comment">// 在当前的文件中重写了。</span>
  <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Get outerHTML of elements, taking care
 * of SVG elements in IE as well.
 */</span>
<span class="token keyword">function</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">el</span><span class="token operator">:</span> Element</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果有outerHTML属性，返回内容的HTML形式</span>
    <span class="token keyword">return</span> el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建div</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把el的内容克隆，然后追加到div中</span>
    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//返回div的innerHTML</span>
    <span class="token keyword">return</span> container<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//注册Vue.compile方法，根据HTML字符串返回render函数</span>
Vue<span class="token punctuation">.</span>compile <span class="token operator">=</span> compileToFunctions<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span class="token punctuation">;</span>

</code></pre></div><p>通过查看该文件中的代码，可以发现，在该文件中并没有创建<code>Vue</code>的实例，关于实例的创建在如下导入的文件中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//导入Vue的构造函数</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&quot;./runtime/index&quot;</span><span class="token punctuation">;</span>

</code></pre></div><p>通过前面的讲解，我们知道在入口文件中，最主要的方法是<code>mount</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//保留Vue实例的$mount方法，方便下面重写$mount的功能</span>
<span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount<span class="token punctuation">;</span>

</code></pre></div><p>在该方法中，很重要的一个操作就是将<code>template</code>模板，转换成<code>render</code>函数。</p> <p>下面，我们先来看一下<code>./runtime/index</code>文件中的内容。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// install platform specific utils</span>
<span class="token comment">//给Vue.config注册了方法，这些方法都是与平台相关的方法。这些方法是在Vue内部使用的。</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>mustUseProp <span class="token operator">=</span> mustUseProp<span class="token punctuation">;</span>
<span class="token comment">//是否为保留的标签，也就是说，传递过来的内容是否为HTML中特有的标签</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isReservedTag <span class="token operator">=</span> isReservedTag<span class="token punctuation">;</span>
<span class="token comment">//是否是保留的属性，也就是说，传递过来的内容是否为HTML中特有的属性</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isReservedAttr <span class="token operator">=</span> isReservedAttr<span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>getTagNamespace <span class="token operator">=</span> getTagNamespace<span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isUnknownElement <span class="token operator">=</span> isUnknownElement<span class="token punctuation">;</span>


</code></pre></div><p>以上内容简短了解一下就可以。</p> <p>下面我们继续查看如下内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// install platform runtime directives &amp; components</span>
<span class="token comment">//通过extend方法注册了与平台相关的全局的指令与组件。</span>
<span class="token comment">//extend的作用就是将第二个参数的成员全部拷贝到第一个参数中</span>
<span class="token comment">//那么问题是注册了哪些指令与组件呢？</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> platformDirectives<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> platformComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>那么问题是注册了哪些指令与组件呢？</p> <p>我们可以查看，<code>extend</code>的第二个参数，以上<code>extend</code>参数的内容，分别来自如下两个文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> platformDirectives <span class="token keyword">from</span> <span class="token string">&quot;./directives/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> platformComponents <span class="token keyword">from</span> <span class="token string">&quot;./components/index&quot;</span><span class="token punctuation">;</span>

</code></pre></div><p>我们首先看一下<code>./directives/index</code>文件中的内容，如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> model <span class="token keyword">from</span> <span class="token string">'./model'</span>
<span class="token keyword">import</span> show <span class="token keyword">from</span> <span class="token string">'./show'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  model<span class="token punctuation">,</span>
  show
<span class="token punctuation">}</span>


</code></pre></div><p>通过以上代码，我们可以看到这个文件中导出了<code>v-show</code>与<code>v-model</code>这两个指令。</p> <p>下面再看一下<code>./components/index</code>文件中的内容。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Transition <span class="token keyword">from</span> <span class="token string">'./transition'</span>
<span class="token keyword">import</span> TransitionGroup <span class="token keyword">from</span> <span class="token string">'./transition-group'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  Transition<span class="token punctuation">,</span>
  TransitionGroup
<span class="token punctuation">}</span>


</code></pre></div><p>以上文件导出的就是<code>v-Transition</code>与<code>v-TransitionGroup</code>这两个组件的内容。</p> <p>通过下面两行代码，我们还可以发现一个相应的问题。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> platformDirectives<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> platformComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>就是全局的指令与组件分别存储到了<code>Vue.options.directives</code>与<code>Vue.options.components</code>中。</p> <p>例如，我们在项目中使用<code>Vue.component</code>注册的组件，都存储到了<code>Vue.options.components</code>中，也就说存储了<code>Vue.options.components</code>中的组件都是全局可以访问的。</p> <p>我们继续向下看，如下代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// install platform patch function</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>__patch__ <span class="token operator">=</span> inBrowser <span class="token operator">?</span> patch <span class="token operator">:</span> noop<span class="token punctuation">;</span>

</code></pre></div><p>以上代码就是在<code>Vue</code>的原型中注册了<code>__patch__</code>函数，该函数对我们来说比较熟悉了，在学习虚拟<code>DOM</code>的时候，我们知道<code>patch</code>函数的作用就是将虚拟<code>DOM</code>转换成真实的<code>DOM</code>.在给<code>patch</code>函数赋值的时候，首先判断是否为浏览器的环境，如果是则返回<code>patch</code>,否则返回<code>noop</code>,<code>noop</code>是一个空函数。</p> <p>这里有一个问题就是：<code>inBrowser</code>是怎样判断是否为浏览器环境的呢？</p> <p><code>inBrowser</code>定义在如下文件中<code>import { devtools, inBrowser } from &quot;core/util/index&quot;;</code></p> <p>该文件的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'shared/util'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./lang'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./env'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./options'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./debug'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./props'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./error'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./next-tick'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> defineReactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../observer/index'</span>


</code></pre></div><p>通过以上的代码，我们并没有发现<code>isBrowser</code>的定义，那么很明显都被封装到具体的文件中了。</p> <p><code>isBrowser</code>是与环境有关的内容，所以很明显来自<code>env</code>这个文件，在该文件中，可以看到如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> inBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span>

</code></pre></div><p>如果<code>window</code>对象不等于<code>undefined</code>,表明当前的环境就是浏览器的环境</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//给Vue原型注册了$mount方法，也就是给Vue的实例注册了$mount方法，在entry-runtime-with-compiler.js文件中对该方法进行了重写。</span>
<span class="token comment">//在该方法中调用了mountComponent方法，用来渲染DOM</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">el<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token comment">//这里重新获取el,并且判断是否为浏览器环境.</span>
    <span class="token comment">//这里有一个问题，就是为什么要重新获取el,在entry-runtime-with-compiler.js文件中重写$mount方法的时候也获取了el,这里为什么要重新获取呢？</span>
    <span class="token comment">//原因是：entry-runtime-with-compiler.js是带编译器版本的Vue,而当前文件是运行时版本执行的，那么就不会执行entry-runtime-with-compiler.js文件来获取el,所以这里必须要重新获取el。</span>
  el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrowser <span class="token operator">?</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>下面看一下<code>mountComponent</code>方法的内部实现。</p> <div class="language- extra-class"><pre class="language-text"><code>import { mountComponent } from &quot;core/instance/lifecycle&quot;;

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span> <span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token operator">?</span>Element<span class="token punctuation">,</span>
  hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> el<span class="token comment">//把el赋值给Vue实例中的$el属性</span>
    <span class="token comment">//判断$options中是否有render函数。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVNode
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/* istanbul ignore if */</span>
        <span class="token comment">//如果在运行时环境中，如果使用了template模板，会出现如下的警告信息。</span>
        <span class="token comment">//警告信息：使用的是运行时版本，编译器无效，应该使用完整版，或者是编写render函数。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>template <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'#'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el <span class="token operator">||</span> el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">'You are using the runtime-only build of Vue where the template '</span> <span class="token operator">+</span>
          <span class="token string">'compiler is not available. Either pre-compile the templates into '</span> <span class="token operator">+</span>
          <span class="token string">'render functions, or use the compiler-included build.'</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">'Failed to mount component: template or render function not defined.'</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
    <span class="token comment">//触发beforeMount钩子函数，表示的是挂载之前。</span>
  <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> updateComponent <span class="token comment">//完成组件的更新</span>
  <span class="token comment">/* istanbul ignore if */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> name <span class="token operator">=</span> vm<span class="token punctuation">.</span>_name
      <span class="token keyword">const</span> id <span class="token operator">=</span> vm<span class="token punctuation">.</span>_uid
      <span class="token keyword">const</span> startTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
      <span class="token keyword">const</span> vnode <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> render</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>

      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> patch</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//重点看这一段代码：</span>
      <span class="token comment">// vm._render():表示执行的是用户传入的render函数，或者是执行编译器生成的render函数。</span>
      <span class="token comment">// render( )函数最终会返回虚拟DOM,把返回的虚拟DOM传递给_update函数。</span>
      <span class="token comment">// _update函数，会将虚拟DOM转换成真实的DOM。</span>
      <span class="token comment">//也就说该方法执行完毕后，页面会呈现出具体的内容。</span>
    <span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// we set this to vm._watcher inside the watcher's constructor</span>
  <span class="token comment">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>
  <span class="token comment">// component's mounted hook), which relies on vm._watcher being already defined</span>
 <span class="token comment">//在 Watcher中调用了updateComponent方法。</span>
    <span class="token comment">// </span>
    <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>
  hydrating <span class="token operator">=</span> <span class="token boolean">false</span>

  <span class="token comment">// manually mounted instance, call mounted on self</span>
  <span class="token comment">// mounted is called for render-created child components in its inserted hook</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">//触发了mounted钩子函数，表明页面已经挂载完毕了。</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>


</code></pre></div><p><code>mountComponent</code>后面的代码就是一些调试的代码，这里也不要在看。</p> <p>下面，把我们看到的代码总结一下。以上代码定义的是与平台有关的代码，主要是注册了<code>patch</code>方法，以及<code>$mount</code>方法。还有就是注册了全局的指令与组件。</p> <p>但在当前的这个文件中，我们还是没有看到<code>Vue</code>的构造函数。</p> <p>在该文件的顶部，可以看到如下导入的语句。</p> <div class="language- extra-class"><pre class="language-text"><code>import Vue from &quot;core/index&quot;;

</code></pre></div><p>该文件中的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&quot;./instance/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initGlobalAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./global-api/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isServerRendering <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;core/util/env&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FunctionalRenderContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;core/vdom/create-functional-component&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//给Vue构造函数注册一些静态的方法。</span>
<span class="token function">initGlobalAPI</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//以下通过defineProperty定义的内容都是与服务端渲染有关的内容。</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$isServer&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">get</span><span class="token operator">:</span> isServerRendering<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$ssrContext&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore next */</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$vnode<span class="token punctuation">.</span>ssrContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// expose FunctionalRenderContext for ssr runtime helper installation</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">&quot;FunctionalRenderContext&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> FunctionalRenderContext<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//指定Vue版本。</span>
Vue<span class="token punctuation">.</span>version <span class="token operator">=</span> <span class="token string">&quot;__VERSION__&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span class="token punctuation">;</span>

</code></pre></div><p>下面我们来看一下<code>initGlobalAPI</code>方法中的代码。</p> <p>该方法的代码定义在<code>core/global-api/index.js</code>文件中。</p> <p>具体的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;../config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initUse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./use&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./mixin&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initExtend <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./extend&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> initAssetRegisters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./assets&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> set<span class="token punctuation">,</span> del <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../observer/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ASSET_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/constants&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> builtInComponents <span class="token keyword">from</span> <span class="token string">&quot;../components/index&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> observe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;core/observer/index&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  warn<span class="token punctuation">,</span>
  extend<span class="token punctuation">,</span>
  nextTick<span class="token punctuation">,</span>
  mergeOptions<span class="token punctuation">,</span>
  defineReactive<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/index&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initGlobalAPI</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// config</span>
  <span class="token keyword">const</span> configDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  configDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    configDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Do not replace the Vue.config object, set individual fields instead.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化了`Vue.config`对象，该对象是Vue的静态成员</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> configDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// exposed util methods.</span>
  <span class="token comment">// NOTE: these are not considered part of the public API - avoid relying on</span>
  <span class="token comment">// them unless you are aware of the risk.</span>
  <span class="token comment">//这些工具方法不视作全局API的一部分，除非你已经意识到某些风险，否则不要去依赖他们，也就是说，使用这些API会出现一些问题。</span>
  Vue<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
    warn<span class="token punctuation">,</span>
    extend<span class="token punctuation">,</span>
    mergeOptions<span class="token punctuation">,</span>
    defineReactive<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//静态方法set/delete/nextTick</span>
  <span class="token comment">//挂载到了Vue的构造函数中。后期会继续看内部源码的实现</span>
  Vue<span class="token punctuation">.</span>set <span class="token operator">=</span> set<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span>delete <span class="token operator">=</span> del<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span>nextTick <span class="token operator">=</span> nextTick<span class="token punctuation">;</span>

  <span class="token comment">// 2.6 explicit observable API</span>
  <span class="token comment">//让一个对象变成可响应式的，内部调用了observe方法。</span>
  Vue<span class="token punctuation">.</span>observable <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
  <span class="token comment">//初始化了Vue.options对象，并给其扩展了</span>
  <span class="token comment">//components/directives/filters内容，后面还会看这块内容</span>
  Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span>
  <span class="token comment">// components with in Weex's multi-instance scenarios.</span>
  Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue<span class="token punctuation">;</span>
  <span class="token comment">//设置keep-alive组件</span>
  <span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//注册Vue.use(),用来注册插件</span>
  <span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//注册Vue.mixin( )实现混入</span>
  <span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//注册Vue.extend( )基于传入的options返回一个组件的构造函数</span>
  <span class="token function">initExtend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册Vue.directive(),Vue.component( ),Vue.filter( )</span>
  <span class="token function">initAssetRegisters</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>目前我们只需要知道在<code>initGlobalAPI</code>方法，初始化了<code>Vue</code>的静态方法。</p> <p>现在，我们回到<code>import Vue from &quot;core/index&quot;;</code> 文件，发现在该文件中也没有创建<code>Vue</code>的构造函数，</p> <p>但是在其顶部，导入了：<code>import Vue from &quot;./instance/index&quot;;</code></p> <p>打开该文件查看的代码如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./init&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> stateMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./state&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> renderMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./render&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventsMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./events&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> lifecycleMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./lifecycle&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/index&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//Vue构造函数</span>
<span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断是否为生产环境，如果不等于生产环境并且如果this不是Vue的实例</span>
  <span class="token comment">//那么说明用户将其作为普通函数调用，而不是通过new来创建其实例，所以会出现如下错误提示</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Vue is a constructor and should be called with the `new` keyword&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//调用_init( )方法</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//注册vm的_init( )方法，初始化vm</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//注册vm（Vue实例）的$data/$props/$set/$delete/$watch</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//初始化事件相关的方法</span>
<span class="token comment">//$on/$once/$off/$emit</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//初始化生命周期相关的混入方法</span>
<span class="token comment">// $forceUpdate/$destroy</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//混入render</span>
<span class="token comment">// $nextTick</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Vue<span class="token punctuation">;</span>


</code></pre></div><p>下面看一下<code>stateMixin</code>方法，在该方法中，我们可以看到如下的代码</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">//在Vue的实例总初始化了一些属性和者方法。</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$data&quot;</span><span class="token punctuation">,</span> dataDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$props&quot;</span><span class="token punctuation">,</span> propsDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set <span class="token operator">=</span> set<span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span> <span class="token operator">=</span> del<span class="token punctuation">;</span>


</code></pre></div><p>通过上面的代码，我们可以看到在<code>stateMixin</code>方法中为<code>Vue</code>的原型上注册了对应的属性和方法，也就说在这个位置实现了为<code>Vue</code>的实例初始化属性和方法。</p> <p>到此位置，我们最开始提出的问题：</p> <p><code>Vue</code>实例成员和<code>Vue</code>的静态成员是从哪里来的？</p> <p>现在已经全部找到。</p> <p>关于<code>import Vue from &quot;./instance/index&quot;;</code>文件中的其他方法，后续课程内容中还会查看。</p> <p>目前我们只需要知道，在在该文件中，创建了<code>Vue</code>的构造函数，并且设置了<code>Vue</code>实例的成员。</p> <p>这里还有一个小的问题就是，在创建<code>Vue</code>的实例的时候，这里使用了构造函数，而没有使用类(<code>class</code>)的形式，</p> <p>原因是：因为使用类来实现构造函数的，下面的方法就不容易实现。在这些方法中为<code>Vue</code>的原型上挂在了很多的成员，而使用类的构造函数不容易实现。</p> <p>现在我们将这块内容做一总结：</p> <p>通过前面的讲解，我们看了四个文件</p> <p><code>src/platforms/web/entry-runtime-with-compiler.js</code></p> <ul><li><code>web</code>平台相关的入口</li> <li>重写了平台相关的<code>$mount( )</code>方法，把<code>template</code>模板转换成<code>render</code>函数</li> <li>注册了<code>Vue.compile( )</code>方法，可以根据传递的<code>HTML</code>字符串返回<code>render</code>函数</li></ul> <p><code>src/platforms/web/runtime/index.js</code></p> <ul><li><p><code>web</code>平台相关</p></li> <li><p>注册和平台相关的全局指令：<code>v-model</code>,<code>v-show</code></p></li> <li><p>注册和平台相关的全局组件:<code>v-transition</code>,<code>v-transition-group</code></p></li> <li><p>全局的指令与组件分别存储到了<code>Vue.options.directives</code>与<code>Vue.options.components</code>中。</p></li> <li><p>全局方法</p> <p>​	<code>__patch__</code>：把虚拟<code>DOM</code>转换成真实<code>DOM</code></p> <p>​	<code>$mount</code>：挂载方法，把<code>DOM</code>渲染到页面中，在<code>src/platforms/web/entry-runtime-with-compiler.js</code>文件中重写了</p> <p><code>$mount</code>,使其具有了编译的能力。</p></li> <li><p><code>src/core/index.js</code></p> <p>与平台无关</p> <p>设置了<code>Vue</code>的静态方法，<code>initGlobalAPI(Vue)</code></p></li> <li><p><code>src/core/instance/index.js</code></p> <p>与平台无关</p> <p>定义了<code>Vue</code>的构造方法，调用了<code>this._init(options)</code>方法（该方法是整个程序的入口）</p> <p>给<code>Vue</code>中混入了常用的实例成员。</p></li></ul> <h1 id="_8、静态成员初始化"><a href="#_8、静态成员初始化" class="header-anchor">#</a> 8、静态成员初始化</h1> <p>​	这一小节我们来看一下<code>Vue</code>中静态成员的初始化，通过前面的讲解，我们知道静态成员都是在文件<code>src/core/index.js</code>中完成初始化，下面再看一下该文件。</p> <p>在该文件有一个<code>initGlobalAPI</code>方法，在该方法中注册了一些静态成员。</p> <div class="language- extra-class"><pre class="language-text"><code>//给Vue构造函数注册一些静态的方法，属性。
initGlobalAPI(Vue);

</code></pre></div><p><code>initGlobalAPI</code>方法的具体实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initGlobalAPI</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// config</span>
  <span class="token keyword">const</span> configDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//为configDef对象添加一个get方法，返回一个config对象</span>
  configDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果不是生产环境，则为开发环境，这时会为configDef添加一个set方法，如果为config进行赋值操作，会出现不能给`Vue.config`重新赋值的错误。</span>
    configDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Do not replace the Vue.config object, set individual fields instead.&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化了`Vue.config`对象，该对象是Vue的静态成员</span>
  <span class="token comment">//这里不是定义响应式数据，而是为Vue定义了一个config属性</span>
  <span class="token comment">//并且为其设置了configDef约束。</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> configDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// exposed util methods.</span>
  <span class="token comment">// NOTE: these are not considered part of the public API - avoid relying on</span>
  <span class="token comment">// them unless you are aware of the risk.</span>
  <span class="token comment">//这些工具方法不视作全局API的一部分，除非你已经意识到某些风险，否则不要去依赖他们，也就是说，使用这些API会出现一些问题。</span>
  Vue<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
    warn<span class="token punctuation">,</span>
    extend<span class="token punctuation">,</span>
    mergeOptions<span class="token punctuation">,</span>
    defineReactive<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//静态方法set/delete/nextTick</span>
  <span class="token comment">//挂载到了Vue的构造函数中。后期会继续看内部源码的实现</span>
  Vue<span class="token punctuation">.</span>set <span class="token operator">=</span> set<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span>delete <span class="token operator">=</span> del<span class="token punctuation">;</span>
  Vue<span class="token punctuation">.</span>nextTick <span class="token operator">=</span> nextTick<span class="token punctuation">;</span>

  <span class="token comment">// 2.6 explicit observable API</span>
  <span class="token comment">//让一个对象变成可响应式的，内部调用了observe方法。</span>
  Vue<span class="token punctuation">.</span>observable <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token constant">T</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//初始化了Vue.options对象，并给其扩展了</span>
  <span class="token comment">//components/directives/filters内容</span>
  Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// this is used to identify the &quot;base&quot; constructor to extend all plain-object</span>
  <span class="token comment">// components with in Weex's multi-instance scenarios.</span>
  Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue<span class="token punctuation">;</span>

  <span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initExtend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initAssetRegisters</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>在上面的代码中，首先初始化了<code>Vue.config</code>对象,并且添加了相应的约束。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 初始化了`Vue.config`对象，该对象是Vue的静态成员</span>
  <span class="token comment">//这里不是定义响应式数据，而是为Vue定义了一个config属性</span>
  <span class="token comment">//并且为其设置了configDef约束。</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> configDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>初始化<code>Vue.config</code>对象后，在什么位置为其挂载了成员。</p> <p>在<code>platforms/web/runtime/index.js</code>文件中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// install platform specific utils</span>
<span class="token comment">//给Vue.config注册了方法，这些方法都是与平台相关的方法。这些方法是在Vue内部使用的。</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>mustUseProp <span class="token operator">=</span> mustUseProp<span class="token punctuation">;</span>
<span class="token comment">//是否为保留的标签，也就是说，传递过来的内容是否为HTML中特有的标签</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isReservedTag <span class="token operator">=</span> isReservedTag<span class="token punctuation">;</span>
<span class="token comment">//是否是保留的属性，也就是说，传递过来的内容是否为HTML中特有的属性</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isReservedAttr <span class="token operator">=</span> isReservedAttr<span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>getTagNamespace <span class="token operator">=</span> getTagNamespace<span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>isUnknownElement <span class="token operator">=</span> isUnknownElement<span class="token punctuation">;</span>

</code></pre></div><p>下面，我们来看如下的代码，前面的代码我们后面在讲解(<code>set</code>,<code>delete</code>,<code>observable</code>等内容)。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">//初始化了Vue.options对象，并给其扩展了</span>
  <span class="token comment">//components/directives/filters内容</span>

<span class="token comment">//创建了Vue.options对象，并且没有指定原型。这样性能更高。</span>
 Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//从`ASSET_TYPES`数组中取出每一项，并为其添加了`s`,来作为Vue.options对象的属性。</span>
      <span class="token comment">//也就是说给Vue.options中挂载了三个成员，分别是：components/directives/filters，并且都初始化成了空对象。这三个成员的作用是用来存储全局的组件，指令和过滤器，我们通过Vue.component,Vue.directive,Vue.filter创建的组件，指令，过滤器最终都会存储到Vue.options中的这三个成员中。</span>
    Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>对<code>ASSET_TYPES</code>数组进行遍历，那么该数组中存储的是什么内容呢？该数组具体定义的位置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ASSET_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;shared/constants&quot;</span><span class="token punctuation">;</span>

</code></pre></div><p>在<code>src/shared</code>目录下面找到<code>constants.js</code>文件，该文件中的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SSR_ATTR</span> <span class="token operator">=</span> <span class="token string">'data-server-rendered'</span>
<span class="token comment">//该数组中定义了我们比较常见的Vue.component,Vue.directive,Vue.filter的方法名称。</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'component'</span><span class="token punctuation">,</span>
  <span class="token string">'directive'</span><span class="token punctuation">,</span>
  <span class="token string">'filter'</span>
<span class="token punctuation">]</span>
<span class="token comment">//生命周期的钩子函数名称，后面在讲解这块内容</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LIFECYCLE_HOOKS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'beforeCreate'</span><span class="token punctuation">,</span>
  <span class="token string">'created'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeMount'</span><span class="token punctuation">,</span>
  <span class="token string">'mounted'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeUpdate'</span><span class="token punctuation">,</span>
  <span class="token string">'updated'</span><span class="token punctuation">,</span>
  <span class="token string">'beforeDestroy'</span><span class="token punctuation">,</span>
  <span class="token string">'destroyed'</span><span class="token punctuation">,</span>
  <span class="token string">'activated'</span><span class="token punctuation">,</span>
  <span class="token string">'deactivated'</span><span class="token punctuation">,</span>
  <span class="token string">'errorCaptured'</span><span class="token punctuation">,</span>
  <span class="token string">'serverPrefetch'</span>
<span class="token punctuation">]</span>


</code></pre></div><p>现在，我们知道了<code>ASSET_TYPES</code>数组中的内容，然后在来看一下对应的循环内容。</p> <p>看完循环内容后，我们再来看一下如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//将Vue的构造函数存储到了_base属性中，后期会用到。  </span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue<span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//设置keep-alive组件</span>
<span class="token comment">//extend方法的作用是将第二个参数中的属性，拷贝到第一个参数中。下面可以看一下extend方法的具体实现。</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><code>extend</code>方法定义在</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  warn<span class="token punctuation">,</span>
  extend<span class="token punctuation">,</span>
  nextTick<span class="token punctuation">,</span>
  mergeOptions<span class="token punctuation">,</span>
  defineReactive<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/index&quot;</span><span class="token punctuation">;</span>

</code></pre></div><p>查看<code>until/index</code>中的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'shared/util'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./lang'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./env'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./options'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./debug'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./props'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./error'</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./next-tick'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> defineReactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../observer/index'</span>

</code></pre></div><p>在<code>src/shared/util</code>文件中，打开该文件搜索<code>extend</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">extend</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">to</span><span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">_from</span><span class="token operator">:</span> <span class="token operator">?</span>Object</span><span class="token punctuation">)</span><span class="token operator">:</span> Object <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> _from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    to<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _from<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> to
<span class="token punctuation">}</span>

</code></pre></div><p>实现了一个浅拷贝。把一个对象的成员拷贝给另外一个对象</p> <p>下面的代码是将<code>builtInComponents</code>拷贝给<code>Vue.options.components</code>,这里完成的就是全局组件的注册</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//设置keep-alive组件</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>下面再来看一下<code>builtInComponents</code>中的内容。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> builtInComponents <span class="token keyword">from</span> <span class="token string">&quot;../components/index&quot;</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> KeepAlive <span class="token keyword">from</span> <span class="token string">'./keep-alive'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  KeepAlive
<span class="token punctuation">}</span>


</code></pre></div><p>通过上面的代码可以看到，导出了<code>KeepAlive</code>这个组件</p> <p>下面看一下<code>initUse(Vue);</code> 该方法的作用:<code>注册Vue.use(),用来注册插件</code></p> <p><code>initUser</code>方法定义在<code>global-api/use.js</code>文件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> toArray <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token comment">//参数为Vue的构造函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initUse</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//为Vue添加use函数</span>
    <span class="token comment">//plugin:是一个函数或者是对象，表示的就是插件</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">plugin</span><span class="token operator">:</span> Function <span class="token operator">|</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//installedPlugins：表示已经安装的插件</span>
      <span class="token comment">//注意:this表示的是Vue的构造函数</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">//判断传递过来的plugin这个插件是否在installedPlugins中存在，如果存在表示已经注册安装了，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// additional parameters</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token comment">//下面就是实现插件的注册，如果plugin中有install这个属性，表示传递过来的plugin表示的是对象</span>
      <span class="token comment">//这时候直接调用plugin中的install完成插件的注册。也就是说如果在注册插件的时候，传递的是一个对象，这个对象中一定要有install这个方法，关于这块内容我们在前面的课程中也已经讲解过来。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果传递的是函数，直接调用函数</span>
      <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
      <span class="token comment">//将插件添加的数组中</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>下面我们再来查看一下<code>initMixin</code>方法，该方法的作用就是用来注册<code>Vue.mixin( )</code>用来实现混入。</p> <p>具体代码的位置：<code>global-api/mixin.js</code>文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> mergeOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">mixin</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将mixin这个对象中的所有成员拷贝到options中，this指的就是Vue</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> mixin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>下面，我们再来看一下<code>initExtend</code>方法，该方法的作用是注册<code>Vue.extend( )</code>，基于传入的<code>options</code>返回一个组件的构造函数。</p> <p>代码位置：<code>global-api/entend.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code>  Vue<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">extendOptions</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    extendOptions <span class="token operator">=</span> extendOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment">//Vue的构造函数</span>
    <span class="token keyword">const</span> Super <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> SuperId <span class="token operator">=</span> Super<span class="token punctuation">.</span>cid
    <span class="token comment">//从缓存中加载组件的构造函数</span>
    <span class="token keyword">const</span> cachedCtors <span class="token operator">=</span> extendOptions<span class="token punctuation">.</span>_Ctor <span class="token operator">||</span> <span class="token punctuation">(</span>extendOptions<span class="token punctuation">.</span>_Ctor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> name <span class="token operator">=</span> extendOptions<span class="token punctuation">.</span>name <span class="token operator">||</span> Super<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果是开发环境验证组件的名称</span>
      <span class="token function">validateComponentName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">//VueComponent表示组件的构造函数</span>
    <span class="token keyword">const</span> <span class="token function-variable function">Sub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">VueComponent</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//调用_init()初始化</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//改变了Sub这个构造函数的原型，让其继承了Vue, Super.prototype表示的是Vue的原型。</span>
    <span class="token comment">//所以说所有的Vue组件都是继承自Vue.</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Sub
    Sub<span class="token punctuation">.</span>cid <span class="token operator">=</span> cid<span class="token operator">++</span>
    Sub<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
      Super<span class="token punctuation">.</span>options<span class="token punctuation">,</span>
      extendOptions
    <span class="token punctuation">)</span>
    Sub<span class="token punctuation">[</span><span class="token string">'super'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Super

    <span class="token comment">// For props and computed properties, we define the proxy getters on</span>
    <span class="token comment">// the Vue instances at extension time, on the extended prototype. This</span>
    <span class="token comment">// avoids Object.defineProperty calls for each instance created.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initProps</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initComputed</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// allow further extension/mixin/plugin usage</span>
      <span class="token comment">//把Super(Vue)的成员拷贝到Sub这个构造函数中，这样就表明我们创建的组件具有了这些成员。</span>
    Sub<span class="token punctuation">.</span>extend <span class="token operator">=</span> Super<span class="token punctuation">.</span>extend
    Sub<span class="token punctuation">.</span>mixin <span class="token operator">=</span> Super<span class="token punctuation">.</span>mixin
    Sub<span class="token punctuation">.</span>use <span class="token operator">=</span> Super<span class="token punctuation">.</span>use

    <span class="token comment">// create asset registers, so extended classes</span>
    <span class="token comment">// can have their private assets too.</span>
    <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Sub<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> Super<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// enable recursive self-lookup</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Sub
    <span class="token punctuation">}</span>

    <span class="token comment">// keep a reference to the super options at extension time.</span>
    <span class="token comment">// later at instantiation we can check if Super's options have</span>
    <span class="token comment">// been updated.</span>
    Sub<span class="token punctuation">.</span>superOptions <span class="token operator">=</span> Super<span class="token punctuation">.</span>options
    Sub<span class="token punctuation">.</span>extendOptions <span class="token operator">=</span> extendOptions
    Sub<span class="token punctuation">.</span>sealedOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Sub<span class="token punctuation">.</span>options<span class="token punctuation">)</span>

    <span class="token comment">// cache constructor</span>
      <span class="token comment">//把组件的构造函数缓存到options._Ctor</span>
    cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span> <span class="token operator">=</span> Sub
      <span class="token comment">//返回组件的构造函数VueComponent</span>
    <span class="token keyword">return</span> Sub
  <span class="token punctuation">}</span>

</code></pre></div><p>以上内容简单了解一下就可以。</p> <p>下面看一下：<code>initAssetRegisters</code>方法，在该方法中注册了<code>Vue.directive()</code>,<code>Vue.component( )</code>,<code>Vue.filter( )</code></p> <p>在这里需要注意的一点就是，以上三个方法并不是一个一个的注册的，而是一起注册的。为什么会一起注册呢？因为这三个方法的参数是一样的。这块可以参考文档。</p> <p>下面看一下具体的源码实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* @flow */</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ASSET_TYPES</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'shared/constants'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isPlainObject<span class="token punctuation">,</span> validateComponentName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initAssetRegisters</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> GlobalAPI</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Create asset registration methods.
   */</span>
    <span class="token comment">//变量ASSET_TYPES数组，为`Vue`定义相应的方法</span>
    <span class="token comment">//ASSET_TYPES数组包括了`directive`,`component`,`filter`</span>
  <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//分别给Vue中的`directive`,`component`,`filter`注册方法</span>
    Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> string<span class="token punctuation">,</span><span class="token comment">//是名字(组件，指令，过滤器的名字)</span>
      <span class="token literal-property property">definition</span><span class="token operator">:</span> Function <span class="token operator">|</span> Object <span class="token comment">//定义，可以是对象或者是函数，这两个参数可以通过查看手册：https://vuejs.bootcss.com/api/#Vue-directive</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果没有传递第二个参数，通过this.options找到之前存储的directive,component,filter，并返回</span>
          <span class="token comment">//通过前面的学习，我们知道Vue.directive,Vue.component,Vue.filter都注册到了this.options['directives'],this.options['components'],this.options['filters']中</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* istanbul ignore if */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> type <span class="token operator">===</span> <span class="token string">'component'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">validateComponentName</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//判断从ASSET_TYPES数组中取出的是否为`component`(也就是是否为组件)</span>
      <span class="token comment">//同时判断definition参数是否为对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//为definition设置名字，如果在Vue.component中的第二个参数设置了name属性，那么就使用该属性的值.</span>
            <span class="token comment">//如果没有设置，则使用id的值作为definition的名字</span>
          definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id
            <span class="token comment">//this.options._base表示的是Vue的构造函数。</span>
            <span class="token comment">//Vue.extend()：我们看过，作用就是将一个普通的对象转换成了VueComponent的构造函数、</span>
            <span class="token comment">//看到这里，我们回到官方手册:https://vuejs.bootcss.com/api/#Vue-component</span>
            <span class="token comment">// 注册组件，传入一个扩展过的构造器</span>
			<span class="token comment">//Vue.component('my-component', Vue.extend({ /* ... */ }))</span>
			<span class="token comment">// 注册组件，传入一个选项对象 (自动调用 Vue.extend)</span>
			<span class="token comment">//Vue.component('my-component', { /* ... */ })</span>
            <span class="token comment">//以上是官方手册中的内容，如果在使用Vue.component方法的时候，传递的第二个参数为Vue.extend,</span>
            <span class="token comment">//那么会直接执行this.options[type + 's'][id] = definition这样代码，因为如果传递的是Vue.extend,那么以上if判断条件不成立。</span>
            <span class="token comment">// 表示将definition对象的内容存储到this.options中，形式this.options[components]['my-component']</span>
            <span class="token comment">//如果传递的是一个对象，那么会执行 this.options._base.extend(definition)这行代码。</span>
            <span class="token comment">//那么现在我们就明白了文档中的这句话的含义:注册组件，传入一个选项对象 (自动调用 Vue.extend)</span>
            
          definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//如果是指令，那么第二个参数可以是可以是对象，也可以是函数。</span>
      <span class="token comment">//如果是对象，直接执行 this.options[type + 's'][id] = definition这行代码</span>
      <span class="token comment">//如果是函数，会将definition设置给bind与update这两个方法，</span>
      <span class="token comment">//在官方手册中，有如下内容</span>
      <span class="token comment">// 注册 (指令函数)</span>
		<span class="token comment">//Vue.directive('my-directive', function () {</span>
  			<span class="token comment">// 这里将会被 `bind` 和 `update` 调用</span>
		<span class="token comment">//})</span>
      <span class="token comment">//现在我们能够理解为什么会写`这里将会被 `bind` 和 `update` 调用`这句话了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'directive'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          definition <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> definition<span class="token punctuation">,</span> <span class="token literal-property property">update</span><span class="token operator">:</span> definition <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token comment">//最终注册的Vue.component,Vue.filter,Vue.directive都会存储到this.options['components']</span>
      <span class="token comment">//this.options['filters'],this.options['directives']中。是一个全局的注册。</span>
      <span class="token comment">//Vue.component,Vue.filter,Vue.directive 是全局注册的组件，过滤器，指令</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition
        <span class="token keyword">return</span> definition
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="_9、vue实例成员初始化"><a href="#_9、vue实例成员初始化" class="header-anchor">#</a> 9、Vue实例成员初始化</h1> <p>通过前面的学习我们知道，实例成员在``src/core/instance/index.js`文件中，下面我们来看一下该文件中的如下方法内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//注册vm的_init( )方法，初始化vm</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//注册vm（Vue实例）的$data/$props/$set/$delete/$watch 属性或方法</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//初始化事件相关的方法</span>
<span class="token comment">//$on/$once/$off/$emit</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//初始化生命周期相关的混入方法</span>
<span class="token comment">// $forceUpdate/$destroy</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//混入render</span>
<span class="token comment">// $nextTick</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><p>这些方法都是以<code>Mixin</code>进行结尾，表示混入的意思，并且传递的参数都是<code>Vue</code>的构造函数，也就是说这些方法都是为<code>Vue</code>混入一些成员。</p> <p><code>initMixin</code>方法的主要作用就是为<code>Vue</code>实例增加了<code>_init</code>方法，该方法在<code>Vue</code>的构造函数中被调用，该方法也是整个应用的入口。关于<code>_initMixin</code>方法中的代码，后面我们还会详细的讲解。</p> <p><code>stateMixin</code>方法，具体的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stateMixin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// flow somehow has problems with directly declared definition object</span>
  <span class="token comment">// when using Object.defineProperty, so we have to procedurally build up</span>
  <span class="token comment">// the object here.</span>
  <span class="token keyword">const</span> dataDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dataDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> propsDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  propsDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dataDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Avoid replacing instance root $data. &quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;Use nested data properties instead.&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    propsDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$props is readonly.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//为Vue的原型上添加`$data`与`$props`属性。也就是完成了`$data`与`$props`的初始化</span>
    <span class="token comment">//在这里为什么使用Object.defineProperty添加属性呢？</span>
    <span class="token comment">//原因是：第三个参数，第三个参数就是一个约束。</span>
    <span class="token comment">//dataDef和propsDef都是对象，并且为其添加了get,在开发环境中添加了set.</span>
    <span class="token comment">//在访问`$data`或者是`$props`的时候会执行get,如果在开发环境中向`$data`或者是`$props`赋值会执行set，从而给出相应的错误提示信息</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$data&quot;</span><span class="token punctuation">,</span> dataDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">&quot;$props&quot;</span><span class="token punctuation">,</span> propsDef<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//为Vue的原型上挂在了$set与$delete方法，与Vue.set和Vue.delete是一样的。</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set <span class="token operator">=</span> set<span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span> <span class="token operator">=</span> del<span class="token punctuation">;</span>
<span class="token comment">//监视数据的变化，该方法后面还会在进行查看。</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">cb</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> Object</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> Function <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>
          error<span class="token punctuation">,</span>
          vm<span class="token punctuation">,</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback for immediate watcher &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>下面，我们看一下<code>eventsMixin</code>方法。</p> <div class="language- extra-class"><pre class="language-text"><code>//初始化事件相关的方法
//$on/$once/$off/$emit
eventsMixin(Vue);

</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>$on:注册事件
$once：注册事件，只能触发一次
$off：取消事件
$emit:是触发事件

</code></pre></div><p>下面我们只看一下<code>$on</code>中的代码，其它内容的代码，可以自己查看。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> string <span class="token operator">|</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">fn</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> Component <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//如果event是一个数组，遍历该数组，给每一个事件，添加对应的处理函数。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> event<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果是字符串，则根据event(事件名称)从_events对象中查找对应内容，如果没有则指定一个空数组，</span>
        <span class="token comment">//然后向数组中添加了对应的处理函数。这样每个事件都有了对应的处理函数。</span>
      <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
      <span class="token comment">// optimize hook:event cost by using a boolean flag marked at registration</span>
      <span class="token comment">// instead of a hash lookup</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hookRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_hasHookEvent <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
  <span class="token punctuation">}</span>

</code></pre></div><p>下面看一下<code>lifecycleMixin</code>方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//初始化生命周期相关的混入方法</span>
<span class="token comment">//  _update/$forceUpdate/$destroy</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// _update方法的作用就是把虚拟DOM转换成真实的DOM</span>
<span class="token comment">//首次渲染的时候会调用，数据更新会调用</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vnode</span><span class="token operator">:</span> VNode<span class="token punctuation">,</span> hydrating<span class="token operator">?</span><span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> prevEl <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el
    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode
    <span class="token keyword">const</span> restoreActiveInstance <span class="token operator">=</span> <span class="token function">setActiveInstance</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
    <span class="token comment">// Vue.prototype.__patch__ is injected in entry points</span>
    <span class="token comment">// based on the rendering backend used.</span>
   <span class="token comment">//首次渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// initial render</span>
      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// updates（数据更新）</span>
      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">restoreActiveInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// update __vue__ reference</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prevEl<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$el<span class="token punctuation">.</span>__vue__ <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// if parent is an HOC, update its $el as well</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$vnode <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$parent <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span>$vnode <span class="token operator">===</span> vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>_vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$parent<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span>$el
    <span class="token punctuation">}</span>
    <span class="token comment">// updated hook is called by the scheduler to ensure that children are</span>
    <span class="token comment">// updated in a parent's updated hook.</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>其它方法，后续再看。</p> <p>下面看一下<code>renderMixin</code>函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//混入render</span>
<span class="token comment">// $nextTick</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">installRenderHelpers</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//安装了渲染有关的帮助方法</span>

</code></pre></div><p><code>installRenderHelpers</code>内部实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">installRenderHelpers</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>_o <span class="token operator">=</span> markOnce
  target<span class="token punctuation">.</span>_n <span class="token operator">=</span> toNumber
  target<span class="token punctuation">.</span>_s <span class="token operator">=</span> toString
  target<span class="token punctuation">.</span>_l <span class="token operator">=</span> renderList
  target<span class="token punctuation">.</span>_t <span class="token operator">=</span> renderSlot
  target<span class="token punctuation">.</span>_q <span class="token operator">=</span> looseEqual
  target<span class="token punctuation">.</span>_i <span class="token operator">=</span> looseIndexOf
  target<span class="token punctuation">.</span>_m <span class="token operator">=</span> renderStatic
  target<span class="token punctuation">.</span>_f <span class="token operator">=</span> resolveFilter
  target<span class="token punctuation">.</span>_k <span class="token operator">=</span> checkKeyCodes
  target<span class="token punctuation">.</span>_b <span class="token operator">=</span> bindObjectProps
  target<span class="token punctuation">.</span>_v <span class="token operator">=</span> createTextVNode <span class="token comment">//创建一个虚拟文本节点</span>
  target<span class="token punctuation">.</span>_e <span class="token operator">=</span> createEmptyVNode
  target<span class="token punctuation">.</span>_u <span class="token operator">=</span> resolveScopedSlots
  target<span class="token punctuation">.</span>_g <span class="token operator">=</span> bindObjectListeners
  target<span class="token punctuation">.</span>_d <span class="token operator">=</span> bindDynamicKeys
  target<span class="token punctuation">.</span>_p <span class="token operator">=</span> prependModifier
<span class="token punctuation">}</span>


</code></pre></div><p>以上这些函数都是在编译的时候会用到，也就是将<code>template</code>模板编译成<code>render</code>函数的时候。</p> <p>在<code>installRenderHelpers</code> 创建了<code>$nextTick</code>,关于这块内容，我们后期再来查看</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fn</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nextTick</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>下面有一个<code>_render</code>方法，在该方法中有一个非常重要的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code>  vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>

</code></pre></div><p>在上面的代码中首先看一下<code>render</code>的定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> _parentVnode <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options

</code></pre></div><p>从上面这行代码中，我们知道了<code>render</code>来自于<code>vm.$options</code>,那么就表明这个<code>render</code>是在用户创建<code>Vue</code>的实例的时候执行的的<code>render</code>.</p> <p><code>render.call</code>范围<code>render</code>方法的调用，第一个参数改变<code>this</code>的指向，第二个参数：<code>vm.$createElement</code>其实就是我们在创建<code>Vue</code>的实例的时候，指定的<code>h</code>函数。<code>h</code>函数的作用就是创建虚拟<code>DOM</code></p> <p>以上就是我们这一小节讲解的内容，当然其内部还有一些其它方法，这些我们会在后面在继续查看。</p> <h1 id="_10、init方法"><a href="#_10、init方法" class="header-anchor">#</a> 10、init方法</h1> <p>在``src/core/instance/index.js<code>文件中,创建了</code>Vue<code>的构造函数，并且在其内部调用了</code>_init( )方法<code>,而该方法的初始化是在</code>initMixin(Vue);<code>方法中完成的，下面我们再来看一下该方法的实现。</code>_init( )`方法完成了初始化的工作，所以我们重点看一下该方法中初始化了哪些内容？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">?</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//Vue的实例</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// a uid</span>
      <span class="token comment">//唯一标识</span>
    vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>

    <span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag
    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      endTag <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// a flag to avoid this being observed</span>
      <span class="token comment">//如果是Vue实例，不需要被observe处理。</span>
    vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// merge options</span>
      <span class="token comment">// 合并options</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// optimize internal component instantiation</span>
      <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
      <span class="token comment">// internal component options needs special treatment.</span>
      <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//将用户掺入的options与Vue构造函数中的options进行合并、</span>
        <span class="token comment">//在初始化静态成员的时候已经为Vue构造函数初始化了v-show,v-model,keep-alive等指令和组件</span>
      vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* istanbul ignore else */</span>
      <span class="token comment">//设置渲染的代理对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//开发环境调用initProxy方法</span>
      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//渲染的时候设置的代理对象就是Vue的实例</span>
        <span class="token comment">//在渲染的时候会用到该属性。</span>
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">// expose real self</span>
    vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm
      <span class="token comment">//下面的函数是完成Vue实例的一些初始化操作。</span>
      <span class="token comment">//初始与生命周期相关的属性（$children,$parent,$root,$refs）</span>
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token comment">//初始化当前组件的事件      </span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token comment">//初始化了render中所使用的h函数</span>
      <span class="token comment">//同时还初始化了$slots/$attrs 等等</span>
      <span class="token comment">//在initRender方法中，注意如下两行代码</span>
               <span class="token comment">//   vm._c = (a, b, c, d) =&gt; createElement(vm, a, b, c, d, false)</span>
              <span class="token comment">//vm.$createElement = (a, b, c, d) =&gt; createElement(vm, a, b, c, d, true)</span>
      <span class="token comment">//当我们在创建一个Vue实例的时候，是可以直接传递一个render函数，render函数需要一个参数就是h函数，</span>
      <span class="token comment">//$createElement就是传递过来的h函数。其作用就是将虚拟DOM转换成真实DOM</span>
      <span class="token comment">//当我们把template编译成render函数的时候，在内部调用的是_c这个函数，在模板编译的过程中，会看到这个方法</span>
      <span class="token comment">// 而$createElement函数，是在new Vue实例的时候传递的render函数所调用的。</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token comment">//触发生命周期中的beforeCreate钩子函数</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
      <span class="token comment">//初始化inject，把inject的成员注入到Vue的实例上</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
      <span class="token comment">//初始化Vue实例中的methods/computed/watch等，关于该函数会在下一小节中进行讲解</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
      <span class="token comment">// 初始化provide</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
      <span class="token comment">//触发生命周期中的created钩子函数</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>

    <span class="token comment">/* istanbul ignore if */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
      <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token comment">//调用$mount挂载整个页面，并且进行页面的渲染</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>initProxy</code>方法的实现</p> <div class="language-js extra-class"><pre class="language-js"><code>onst hasProxy <span class="token operator">=</span>
    <span class="token keyword">typeof</span> Proxy <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>Proxy<span class="token punctuation">)</span>
<span class="token comment">//如果有Proxy，通过new Proxy来创建一个代理。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isBuiltInModifier <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'stop,prevent,self,ctrl,shift,alt,meta,exact'</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>keyCodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>keyCodes<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">set</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInModifier</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid overwriting built-in modifier in config.keyCodes: .</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre></div><h1 id="_11、initstate方法"><a href="#_11、initstate方法" class="header-anchor">#</a> 11、initState方法</h1> <p><code>initState</code>方法的作用就是：初始化<code>Vue</code>实例中的<code>methods/computed/watch</code>等.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initState</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//获取options</span>
  <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">;</span>
    <span class="token comment">//初始化props,并且注入到Vue实例中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化methods，把methods中的方法注册到Vue实例中，下面看一下initMethods方法的内部实现</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">initMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果options中有data属性会调用initData方法，下面查看一下initData方法内部实现</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化data</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果没有data属性，会为Vue的实例创建一个空对象，并且将其修改成响应式的。关于响应式的内容我们后期还会查看。</span>
    <span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
    <span class="token comment">//初始化computed，会把computed注册到Vue的实例中，可以自己查看源码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化watch，会把watch注册到Vue的实例中，可以自己查看源码</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initWatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>initMethods</code>方法实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span> <span class="token literal-property property">methods</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span><span class="token comment">//获取props</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//对所有的methods进行遍历</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//在开发环境中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//获取对应的method如果不是函数，会给出相应的警告</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has type &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>
            key
          <span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; in the component definition. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Did you reference the function correctly?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
        <span class="token comment">// 如果method的名字与props中的属性名字重名也会给出相应的警告</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a prop.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
        <span class="token comment">//判断方法的名称是否为Vue的实例，同时判断方法的名称是否以_或者是$开头。</span>
        <span class="token comment">//如果以 _ 开头表示一个私有属性，所以不建议方法名称以 _ 开头。</span>
        <span class="token comment">// 以$开头的都是成员都是Vue的成员，所以也不建议方法名称使用$开头</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm <span class="token operator">&amp;&amp;</span> <span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; conflicts with an existing Vue instance method. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid defining component methods that start with _ or $.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
      <span class="token comment">//把method注册到Vue的实例中</span>
      <span class="token comment">//首先判断从methods中取出来的方法如果不是&quot;function&quot;,返回noop,也就是一个空函数。</span>
      <span class="token comment">//如果是&quot;funciton&quot;，返回该函数，同时通过bind修改函数内部this的指向，然后指向到Vue的实例。</span>
    vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token keyword">typeof</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> noop <span class="token operator">:</span> <span class="token function">bind</span><span class="token punctuation">(</span>methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>initData</code>方法实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span><span class="token comment">//获取props中的data内容</span>
    <span class="token comment">//初始化_data,判断data的类型是不是一个函数如果不是直接返回data，如果是调用getData方法,getData中就是通过call来调用data函数。</span>
    <span class="token comment">//其实就是初始化组件中的data,组件中的data就是一个函数，如果是Vue实例中的data,那么就是一个对象。</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;data functions should return an object:\n&quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&quot;</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// proxy data on instance</span>
    <span class="token comment">//获取data中的所有属性</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取props</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token comment">// 获取methods</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">//判断data中的成员是否和`props/methods`重名。在开发环境中有重名会出现相应的警告信息。</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a data property.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already declared as a prop. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use prop default value instead.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//isReserved方法就是判断当前的属性是否以`_`和`$`开头，如果是以`_`和`$`开头就不会把当前的属性注入到Vue实例中。否则会将当前属性（key的值）注册到Vue的实例中。</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// observe data</span>
    <span class="token comment">//对data做响应式的处理。</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>下面可以看一下<code>proxy</code>方法中的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">sourceKey</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果访问get，那么返回的就是this._data中当前属性的值</span>
  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//把当前属性注入到Vue实例中</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedPropertyDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="_12、总结"><a href="#_12、总结" class="header-anchor">#</a> 12、总结</h1> <p>下面我们把上面讲解的内容，做一个总结：</p> <p>在首次渲染的时候，首先对<code>Vue</code>进行初始化，同时完成实例成员与静态成员的初始化。初始化完成后会执行构造函数，在构造函数中调用了<code>_init</code>方法，该方法是整个<code>Vue</code>的入口，在该方法中调用了<code>vm.$mount</code>方法，通过前面的学习，我们知道有两个<code>$mount</code>, 首先第一个<code>$mount</code>来自于<code>src/platforms/web/entry-runtime-with-compiler.js</code>文件，这个<code>$mount</code>方法的作用就是把模板编译成<code>render</code>函数，当然，在把模板编译成<code>render</code>函数之前，先判断一下是否传入了<code>render</code>这个选项，如果没有传入，这时就会去获取<code>template</code>选项，如果也没有<code>template</code>这个选项，那么会把<code>el</code>中的内容作为模板，然后把模板编译成<code>render</code>函数。这里是通过<code>compileToFunctions</code>这个函数，把模板编译成<code>render</code>函数。把编译好的<code>render</code>函数存储到<code>options.render</code>中。</p> <p>下面会调用<code>src/platforms/web/runtime/index.js</code>文件中的<code>$mount</code>方法。在这个方法中会重新获取<code>el</code>,因为运行时版本，是不会执行<code>src/platforms/web/entry-runtime-with-compiler.js</code>文件中的代码，所以这里需要重新获取<code>el</code>,下面调用<code>mountComponent( )</code>方法，该方法定义的文件为<code>src/core/instance/lifecycle.js</code>,在<code>mountComponent( )</code>方法中，首先判断是否有<code>render</code>选项，如果没有但是传入了模板，并且当前是开发环境，那么会打印一个警告信息。警告信息为运行时版本不支持编译器。下面触发了<code>beforeMount</code>这个钩子函数，然后定义<code>updateComponent</code>,在<code>updateComponent</code>中，调用了<code>vm._render( )</code>函数和<code>vm._update</code>函数。</p> <p><code>vm._render()</code>函数的作用就是生成虚拟<code>DOM</code>（在 <code>vm._render()</code>这个方法中，调用了在创建<code>Vue</code>实例的时候传入的<code>render</code>函数,或者是将<code>template</code>编译成的<code>render</code>函数）,<code>vm._update( )</code>函数的作用就是将虚拟<code>DOM</code>转换成真实的<code>DOM</code>（在<code>vm._udpate</code>这个方法中调用了<code>vm.__patch__</code>方法将虚拟<code>DOM</code>转换成了真实的<code>DOM</code>然后挂在到页面中）.接下来创建了<code>Watcher</code>的实例，在<code>Watcher</code>实例中调用了<code>updateComponent</code>, 接下来会执行<code>mounted</code>这个钩子函数，完成挂在，最后返回<code>Vue</code>的实例。</p> <h1 id="_13、响应式处理入口"><a href="#_13、响应式处理入口" class="header-anchor">#</a> 13、响应式处理入口</h1> <p>通过查看 源码解决如下的问题</p> <ul><li><code>vm.msg={count:0}</code> 重新给属性赋值，是否是响应式的？</li> <li><code>vm.arr[0]=4</code> 给数组元素赋值，视图是否会更新</li> <li><code>vm.arr.length=0</code> 修改数组的<code>length</code>,视图是否会更新</li> <li><code>vm.arr.push(5)</code> 视图是否会更新</li></ul> <p>响应式处理的入口</p> <p>整个响应式处理的过程是比较复杂的，下面我们先查看<code>src/core/instance/init.js</code>文件,在该文件中有<code>initState(vm)</code>方法，该方法完成了<code>vm</code>状态的初始化，初始化了<code>_data</code>,<code>_props</code>,<code>methods</code>等。</p> <p>然后我们再来看一下，<code>src/core/instance/state.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//数据的初始化</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">//把data中的成员注入到Vue实例，并且转换成响应式的对象</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">//如果options选项中没有data，这里会将data初始化一个空对象。传入到observe这个方法中转换成响应式的对象</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">//observe就是响应式的入口。</span>
<span class="token punctuation">}</span>

</code></pre></div><p>下面看一下<code>src/core/instance/init.js</code>文件，在该文件中找到<code>initState(vm)</code>方法，该方法就是注册<code>vm</code>（<code>Vue</code>实例）的<code>$data/$props/$set/$delete/$watch</code> 属性或方法.当我们单击进入该方法后，可以看到该方法所在的文件为<code>src/core/instance/state.js</code>.</p> <p>在该文件中找到如下代码</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> 

</code></pre></div><p>下面在进入<code>initData</code>方法，代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>data<span class="token punctuation">;</span><span class="token comment">//获取props中的data内容</span>
    <span class="token comment">//初始化_data,判断data的类型是不是一个函数如果不是直接返回data对象，如果是调用getData方法,getData中就是通过call来调用data函数。</span>
    <span class="token comment">//其实就是初始化组件中的data,组件中的data就是一个函数，如果是Vue实例中的data,那么就是一个对象。</span>
  data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span> <span class="token operator">?</span> <span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token string">&quot;data functions should return an object:\n&quot;</span> <span class="token operator">+</span>
          <span class="token string">&quot;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&quot;</span><span class="token punctuation">,</span>
        vm
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// proxy data on instance</span>
    <span class="token comment">//获取data中的所有属性</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取props</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token comment">// 获取methods</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods<span class="token punctuation">;</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token comment">//判断data中的成员是否和`props/methods`重名。在开发环境中有重名会出现相应的警告信息。</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; has already been defined as a data property.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot;production&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The data property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is already declared as a prop. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Use prop default value instead.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//isReserved方法就是判断当前的属性是否以`_`和`$`开头，如果是以`_`和`$`开头就不会把当前的属性注入到Vue实例中。否则会将当前属性（key的值）注册到Vue的实例中。</span>
      <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// observe data</span>
    <span class="token comment">//对data做响应式的处理。</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* asRootData */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre></div><p>在上面的代码中，我们可以看到最后调用了<code>observe</code>方法。<code>data</code>就是传递过来的<code>options</code>选项中的<code>data</code>,第二个参数为<code>true</code>,表示的就是根数据,根数据会做相应的处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Attempt to create an observer instance for a value,
 * returns the new observer if successfully observed,
 * or the existing observer if the value already has one.
 */</span>
<span class="token comment">//试图为value创建一个Observer对象,如果创建成功，将创建的Observer返回，或者返回一个已经存在的Observer对象。也就是说valu这个参数如果已经有Observer对象，直接返回。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">asRootData</span><span class="token operator">:</span> <span class="token operator">?</span>boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断 value 是否是对象,如果不是对象，或者是VNode，直接返回，不做响应式的处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> value <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> <span class="token literal-property property">ob</span><span class="token operator">:</span> Observer <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token comment">//声明一个Observer类型的变量</span>
  <span class="token comment">// 判断value中是否有'__ob__'这个属性，如果有，那么就需要判断value中的ob这个属性是否为Observer的实例</span>
  <span class="token comment">//如果value中的ob属性是Observer的实例，在这就赋值给ob这个变量。最后直接返回ob.</span>
  <span class="token comment">//这一点就和最开始我们说的是一样的，也是如果已经存在Observer对象，直接返回,相当于做了一个缓存的效果。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token comment">//如果value中没有ob这个属性，那么就需要创建一个Observer对象。</span>
      <span class="token comment">//在创建Observer对象之前，需要做一些判断的处理。</span>
      <span class="token comment">//这里我们重点看一下,如下的判断      </span>
        <span class="token comment">//(Array.isArray(value) || isPlainObject(value)) &amp;&amp;</span>
    <span class="token comment">//Object.isExtensible(value) &amp;&amp;</span>
    <span class="token comment">//!value._isVue</span>
      <span class="token comment">//(Array.isArray(value):判断传递过来的value是否为一个数组</span>
      <span class="token comment">//isPlainObject(value)):判断value是否为一个对象。</span>
      <span class="token comment">//!value._isVue:判断value是否为一个Vue的实例，在core/instance/index.js文件中，调用了initMixin方法，</span>
      <span class="token comment">//在该方法中，设置了_isVue这个属性，如果传递过来的的value是Vue的实例就不要通过Observer设置响应式。</span>
      <span class="token comment">//如果value可以进行响应式的处理，就需要创建一个Observer对象。</span>
    shouldObserve <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    Object<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span>value<span class="token punctuation">.</span>_isVue
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建一个 Observer 对象</span>
      <span class="token comment">//在Observer中把value中的所有属性转换成get与set的形式。</span>
    ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>asRootData <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ob<span class="token punctuation">.</span>vmCount<span class="token operator">++</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ob
<span class="token punctuation">}</span>

</code></pre></div><p>这里最重要的就是<code>Observer</code>对象的创建，下一小节我们来看一下<code>Observer</code>中是怎样处理的。</p> <h1 id="_14、observer"><a href="#_14、observer" class="header-anchor">#</a> 14、Observer</h1> <p>在上一小节中，我们已经找到了响应式的入口，<code>Observer</code>.（<code>src/core/observer/index.js</code>）</p> <p>下面我们看一下<code>Observer</code>对应的代码。<code>Observer</code>是一个类</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Observer class that is attached to each observed
 * object. Once attached, the observer converts the target
 * object's property keys into getter/setters that
 * collect dependencies and dispatch updates.
 */</span>
<span class="token comment">//Observer类附加到每个被观察的对象，一旦附加，observer就会转换目标对象的所有属性，将其转换成`getter/setter`.</span>
<span class="token comment">//其目的就是收集依赖和派发更新。其实就是我们前面所讲的发送通知。</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token comment">// 观察对象</span>
  <span class="token literal-property property">value</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token comment">// 依赖对象</span>
  <span class="token literal-property property">dep</span><span class="token operator">:</span> Dep<span class="token punctuation">;</span>
  <span class="token comment">// 实例计数器</span>
  <span class="token literal-property property">vmCount</span><span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// number of vms that have this object as root $data</span>

  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化实例的 vmCount 为0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 将实例挂载到观察对象的 __ob__ 属性上。</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// 数组的响应式处理,后面再看具体的实现</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 为数组中的每一个对象创建一个 observer 实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历对象中的每一个属性，转换成 setter/getter</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


</code></pre></div><p>下面 看一下对应的<code>walk</code>方法的实现。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">walk</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">obj</span><span class="token operator">:</span> Object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取观察对象的每一个属性</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
    <span class="token comment">// 遍历每一个属性，设置为响应式数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//该方法就是将对象中的属性转换成getter和setter.</span>
        <span class="token comment">//当然在将属性转换成getter/setter前，也做了其它的一些处理，例如收集依赖，当数据发生变化后，发送通知等。</span>
        <span class="token comment">//下一小节，查看该方法的实现。</span>
      <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


</code></pre></div><p>最好还调用了<code>observeArray</code>方法，该方法的作用就是将数组转换成响应式的。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">observeArray</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">items</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p><code>Observer</code>类核心的作用就是对数组和对象做响应式的处理。</p> <h1 id="_15、definereactive"><a href="#_15、definereactive" class="header-anchor">#</a> 15、defineReactive</h1> <p>这一小节我们来看一下<code>Observer</code>类中的<code>defineReactive</code>方法，在上一小节中我们说过该方法的作用就是：就是将对象中的属性转换成<code>getter</code>和<code>setter</code>.</p> <p>下面看一下<code>defineReactive</code>方法中的源码实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 为一个对象定义一个响应式的属性</span>
<span class="token comment">/**
 * Define a reactive property on an Object.
 */</span>
<span class="token comment">//shallow的值为true,表示只监听对象中的第一层属性，如果是false那就是深度监听，也就是说当key这个属性的值是一个对象，那么还需要监听这个对象中的每个值的变化。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">obj</span><span class="token operator">:</span> Object<span class="token punctuation">,</span><span class="token comment">//目标对象</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">//转换的属性</span>
  <span class="token literal-property property">val</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
  customSetter<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span><span class="token comment">//用户自定义的函数，很少会用到。</span>
  shallow<span class="token operator">?</span><span class="token operator">:</span> boolean
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建依赖对象实例，其作用就是为key收集依赖，也就是收集所有观察当前key这个属性的所有的watcher.</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取 obj 的属性描述符对象,在属性描述符中可以定义getter/setter. 还可以定义configurable,也就是该属性是否为可配置的。</span>
  <span class="token keyword">const</span> property <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
  <span class="token comment">//判断是否存在属性描述符并且configurable的值为false。如果configurable的值为false,表明是不可配置的，那么就不能通过delete将这个属性进行删除。、</span>
  <span class="token comment">//也不能通过 Object.defineProperty进行重新的定义。</span>
  <span class="token comment">//而在接下的操作中我们需要通过 Object.defineProperty对属性重新定义描述符，所以这里判断了configurable属性如果为false,则直接返回。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>configurable <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取属性中的get和set.因为obj这个对象有可能是用户传入的，如果是用户传入的那么就有可能给obj这个对象中的属性设置了get/set.</span>
    <span class="token comment">//所以这里先将用户设置的get和set存储起来，后面需要对get/set进行重写,为其增加依赖收集与派发更新的功能。</span>
  <span class="token comment">// cater for pre-defined getter/setters</span>
  <span class="token keyword">const</span> getter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>get
  <span class="token keyword">const</span> setter <span class="token operator">=</span> property <span class="token operator">&amp;&amp;</span> property<span class="token punctuation">.</span>set
  <span class="token comment">//如果传入了两个参数（obj和key）,这里需要获取对应的key这个属性的值。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>getter <span class="token operator">||</span> setter<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> arguments<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    val <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 判断shallow是否为false.如果当前的shallow是false,那么就不是浅层的监听。那么需要调用observe，也就是val是一个对象，那么需要将该对象中的所有的属性转换成getter/setter，observe方法返回的就是一个Observer对象</span>
  <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token comment">//下面就是通过Object.defineProperty将对象的属性转换成了get和set  </span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//可枚举</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//可以配置</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首先调用了用户传入的getter,如果用户设置了getter，那么首先会通过用户设置的getter获取对象中的属性值。</span>
        <span class="token comment">//如果没有设置getter,直接返回我们前面获取到的值。</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token comment">//下面就是收集依赖（这块内容我们在一下小节中再来讲解，下面再来看一下set）</span>
      <span class="token comment">// 如果存在当前依赖目标，即 watcher 对象，则建立依赖</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 如果子观察目标存在，建立子对象的依赖关系</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果属性是数组，则特殊处理收集数组对象依赖</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 返回属性值</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果用户设置了getter,通过用户设置的getter获取对象中的属性值，否则直接返回前面获取到的值。</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val
      <span class="token comment">// 如果新值等于旧值或者新值旧值为NaN则不执行</span>
      <span class="token comment">/* eslint-disable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/* eslint-enable no-self-compare */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果没有 setter 直接返回</span>
      <span class="token comment">// #7981: for accessor properties without setter</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token keyword">return</span>
      <span class="token comment">// 如果setter存在则调用，为对象中的属性赋值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">//当getter和setter都不存在，将新值赋值给旧值。</span>
        val <span class="token operator">=</span> newVal
      <span class="token punctuation">}</span>
      <span class="token comment">// 如果新值是对象，那么把这个对象的属性再次转换成getter/setter</span>
        <span class="token comment">//childOb就是一个Observe对象。</span>
      childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
      <span class="token comment">// 派发更新(发布更改通知)</span>
      dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="_16、依赖收集"><a href="#_16、依赖收集" class="header-anchor">#</a> 16、依赖收集</h1> <p>在<code>defineReactive</code>方法中定义了<code>getter/setter</code>.在<code>getter</code>中做了收集依赖。依赖收集就是把依赖该属性的<code>watcher</code>对象，添加到<code>dep</code>中的<code>subs</code>数组中。</p> <p>当数据发生变化后，通知数组中的<code>watch</code>,在前面的课程中，我们模拟过这个过程，下面看一下在<code>Vue</code>中是怎样实现的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//下面就是收集依赖</span>
      <span class="token comment">// 判断Dep中是否有target属性，该属性中存储的就是watcher对象</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//depend方法就是进行依赖收集，就是把watch对象添加到Dep中的subs数组中。</span>
        dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 如果子对象存在，建立子对象的依赖关系</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//每一个Observer对象，都有一个dep对象，然后调用depend方法建立子对象的依赖关系。</span>
          childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token comment">// 如果属性是数组，则收集数组对象依赖</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

</code></pre></div><p>现在我们对以上代码有了一个基本的了解，下面我们思考一个问题是,在什么时候给<code>Dep</code>的<code>target</code>属性赋值的？要回答这个问题，我们首先要考虑的是，什么时候创建<code>Watcher</code>对象的。</p> <p>在<code>src/core/instance/lifecycle.js</code>文件中创建了<code>Watcher</code>对象。</p> <p>找到该文件中的<code>mountComponent</code>方法，在该方法中创建了<code>Watcher</code>对象。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// we set this to vm._watcher inside the watcher's constructor</span>
  <span class="token comment">// since the watcher's initial patch may call $forceUpdate (e.g. inside child</span>
  <span class="token comment">// component's mounted hook), which relies on vm._watcher being already defined</span>
  <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span>

</code></pre></div><p>下面进入<code>Watcher</code>的内部，看一下在其内部是怎样给<code>Dep</code>的<code>target</code>属性赋值的。在其内部有个<code>get</code>方法，在该方法的内部的内部调用了<code>pushTarget(this)</code>,在这里<code>this</code>就是<code>Watcher</code>对象，下面进入<code>pushTarget</code>方法的内部。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Dep.target 用来存放目前正在使用的watcher</span>
<span class="token comment">// 全局唯一，并且一次也只能有一个watcher被使用</span>
<span class="token comment">// The current target watcher being evaluated.</span>
<span class="token comment">// This is globally unique because only one watcher</span>
<span class="token comment">// can be evaluated at a time.</span>
Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token keyword">const</span> targetStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// 入栈并将当前 watcher 赋值给 Dep.target</span>
<span class="token comment">// 父子组件嵌套的时候先把父组件对应的 watcher 入栈，</span>
<span class="token comment">// 再去处理子组件的 watcher，子组件的处理完毕后，再把父组件对应的 watcher 出栈，继续操作</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pushTarget</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token operator">?</span>Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//将Watcher对象存储到栈中。</span>
    <span class="token comment">//因为在V2.0以后每一个组件对应一个Watcher对象，如果组件之间有嵌套，先处理子组件，所以这时应该先将父组件的	`Watcher`存储起来，这里是存储到栈中了，</span>
    <span class="token comment">//子组件处理完毕后，把父组件中的Watcher从栈中弹出，继续处理父组件。</span>
  targetStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token comment">//给Dep中的target赋值。</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popTarget</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 出栈操作</span>
  targetStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> targetStack<span class="token punctuation">[</span>targetStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>


</code></pre></div><p>下面，我们查看一下<code>dep.depend()</code>这个方法内部的代码。我们知道<code>depend</code>方法的作用就是收集依赖。</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// 将观察对象和 watcher 建立依赖</span>
  <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 target 存在，把 dep 对象添加到 watcher 的依赖中</span>
        
      Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p><code>Dep.target</code>指的就是<code>Watcher</code> ,所以接下来我们查看<code>observer/watcher.js</code>这个文件中的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">dep</span><span class="token operator">:</span> Dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token comment">//唯一表示，每次创建一个Dep对象的时候，会让该编号加1，这里可以进入Dep中查看。例如，在页面中有两个{{msg}}，针对这个属性，只会收集一次依赖，即使使用两次msg，这样就避免了重复收集依赖。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果在newDepIds集合中没有id,将其添加到该集合中。</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token comment">//将dep对象添加到newDeps集合中。</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 调用dep对象中的addSub方法，将Watcher对象添加到subs数组中。this为Watcher对象。</span>
        dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>下面我们来看一下<code>Dep</code>中的<code>addSub</code>方法</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 将Watcher对象添加到subs数组中。</span>
  <span class="token function">addSub</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">sub</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


</code></pre></div><h1 id="_17、数组的响应式处理"><a href="#_17、数组的响应式处理" class="header-anchor">#</a> 17、数组的响应式处理</h1> <p>数组的响应式处理的核心代码在<code>Observer</code>类的构造函数中(<code>/core/observer/index.js</code>)</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化实例的 vmCount 为0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vmCount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">// 将实例挂载到观察对象的 __ob__ 属性</span>
    <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// 数组的响应式处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//  export const hasProto = '__proto__' in {}</span>
        <span class="token comment">//判断当前浏览器是否支持对象的原型这个属性，目的完成浏览器兼容的处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//支持对象的原型，则调用如下的函数，</span>
          <span class="token comment">//value是数组，</span>
          <span class="token comment">//arrayMethods:数组相关的方法。</span>
          <span class="token comment">//该方法重新设置数组的原型属性，对应的值为arrayMthods.</span>
        <span class="token function">protoAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          
        <span class="token function">copyAugment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 为数组中的每一个对象创建一个 observer 实例</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历对象中的每一个属性，转换成 setter/getter</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p><code>arrayMethods</code>的实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//数组构造函数的原型</span>
<span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype
<span class="token comment">//使用Object.create创建一个对象，让对象的原型指向arrayProto，也就是数组的prototype</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>
<span class="token comment">//我们可以看到，如下内容都是数组中的方法，而且这些方法会对数组进行修改，例如push向数组增加内容，造成了原有数组的更新。</span>
<span class="token comment">//而当数组中的内容发生了变化后，我们要调用Dep中的notity方法发送通知。通知watcher,数据发生了变化，要重新更新视图。</span>
<span class="token comment">//但是数组的原生方法不知道Dep,也就不会调用Dep中的notity方法。所以说要做一些处理。下面看一下怎样进行处理的。</span>
<span class="token keyword">const</span> methodsToPatch <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'push'</span><span class="token punctuation">,</span>
  <span class="token string">'pop'</span><span class="token punctuation">,</span>
  <span class="token string">'shift'</span><span class="token punctuation">,</span>
  <span class="token string">'unshift'</span><span class="token punctuation">,</span>
  <span class="token string">'splice'</span><span class="token punctuation">,</span>
  <span class="token string">'sort'</span><span class="token punctuation">,</span>
  <span class="token string">'reverse'</span>
<span class="token punctuation">]</span>
<span class="token comment">//对methodsToPatch数组进行遍历。</span>
<span class="token comment">//method表示的是从methodsToPatch数组中取出来的方法的名字</span>
methodsToPatch<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// cache original method</span>
    <span class="token comment">// arrayProto：数组的原型，这里就是获取数组的原始方法，例如push,pop等</span>
  <span class="token keyword">const</span> original <span class="token operator">=</span> arrayProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span>
  <span class="token comment">// 调用 Object.defineProperty() ，将method中存储的方法的名字，重新定义到arrayMthods,也就是给arrayMthods对象，重新定义push,pop等这些方法。</span>
  <span class="token comment">// 方法的值，就是defineProperty()方法的第三个参数mutator，该方法需要参数args:该参数中存储的就是我们在调用push或者是pop时传递的内容。</span>
  <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行数组的原始方法</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
    <span class="token comment">// 获取数组关联的Observer对象</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
    <span class="token comment">//存储数组中新增的内容，例如如果是push,unshift，则将args赋值给inserted，因为这时args存储的就是新增的内容。</span>
    <span class="token keyword">let</span> inserted
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'push'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'unshift'</span><span class="token operator">:</span>
        inserted <span class="token operator">=</span> args
        <span class="token keyword">break</span>
      <span class="token keyword">case</span> <span class="token string">'splice'</span><span class="token operator">:</span>
            <span class="token comment">//如果是splice方法，那么把第三个值存储到inserted中。</span>
        inserted <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果有新增的元素，将会重新遍历数组中的元素，并且将其设置为响应式数据。也就是说，调用push,unshift,splice方法，向数组中添加的内容都是响应式的。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inserted<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>inserted<span class="token punctuation">)</span>
    <span class="token comment">// notify change</span>
    <span class="token comment">// 找到Observer中的dep对象，调用其中的notify方法来发送通知</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">//返回方法执行的结果。</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>以上就是对数组中的会修改数组原有内容的方法的处理。具体的过程就是先调用数组中的原始方法，例如<code>push</code>,<code>pop</code>等这些方法。</p> <p>下面就是找到对数组进行新增元素的这些方法，例如:<code>push</code>,<code>unshift</code>,<code>splice，</code>,如果新增了元素，就调用<code>observer</code>中的<code>observerArray</code>这个方法，去遍历数组中的这些新增的元素，然后转换成响应式。当调用了数组中的新增元素的这些方法后，会发送通知。最后返回方法执行的结果。</p> <p>下面我们再回到<code>Observer</code>类的构造函数中(<code>/core/observer/index.js</code>)。</p> <p>如果浏览器不支持原型属性会调用<code>copyAugment</code>方法，该方法有三个参数，前两个参数与<code>protoAugment</code>方法参数的含义是一样的，第三个参数是<code>arrayKeys</code>.</p> <p><code>arrayKeys</code>具体的含义是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arrayKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">)</span>

</code></pre></div><p>获取数组中的<code>push</code>,<code>pop</code>等方法的名字，<code>arrayKeys</code>是一个数组。</p> <p>下面看一下<code>copyAugment</code>方法中的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">copyAugment</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">target</span><span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">src</span><span class="token operator">:</span> Object<span class="token punctuation">,</span> <span class="token literal-property property">keys</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//变量传递过来的数组中方法的名字</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token comment">//给数组对象重新定义这些数组的方法，例如pop,push. 当然这些方法都是经过处理的。该方法的作用与protoAugment方法的一样</span>
    <span class="token function">def</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>下面我们再来看一下<code>observeArray</code>方法。</p> <p>遍历数组中的成员，为数组中的每个对象设置为响应式的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">observeArray</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">items</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="_18、数组练习88888"><a href="#_18、数组练习88888" class="header-anchor">#</a> 18、数组练习88888</h1> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{arr}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">const</span> vm<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">'#app'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span>
          <span class="token literal-property property">arr</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">//看一下如下操作是否为响应式</span>
  <span class="token comment">// vm.arr.push(8)</span>
  <span class="token comment">// vm.arr[0]=100</span>
  <span class="token comment">// vm.arr.length=0</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>通过前面的代码的阅读，我们知道<code>push</code>方法，在<code>Vue</code>中做了一定的处理，当通过<code>push</code>方法向数组中添加了一个新的数据后，对应的视图页面也会进行更新。</p> <p><code>vm.arr[0]=100</code>,会修改数组中的内容，但是当数组中的内容修改了以后，视图并没有发生任何的变化，所以这种操作并不是响应式的。也就是说通过数组的索引来</p> <p>修改数组的时候，并没有调用<code>Dep</code>中的<code>notify</code>,也就没有通知<code>watcher</code>去重新渲染视图。通过源码，我们并没有发现对这种情况的处理，也就是没有监听数组中的每个属性（<code>index</code>,<code>length</code>都是数组的属性）将其转换成响应式，同理<code>vm.arr.length=0</code>也不是响应式的。</p> <p>在源码中，我们看的是对数组进行遍历，对数组中的每个元素中是对象的元素转换成了响应式。</p> <p>如果现在我们想让<code>vm.arr[0]=100</code>和<code>vm.arr.length=0</code>这种操作变成响应式的效果，应该怎样实现呢？</p> <p>首先，我们先来看<code>vm.arr[0]=100</code>,就是修改数组中的第一个元素，这里我们可以使用<code>splice</code>方法来达到相同的目的，而且通过前面阅读源码我们知道，<code>splice</code>方法是响应式的，也就是通过该发你规范修改完了数组后，对应的视图也会进行。所以对应的代码为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//第一个参数0，表示删除arr数组中的第一个元素。</span>
<span class="token comment">//第二个参数1.表示的是删除的个数</span>
<span class="token comment">//第三个参数100，表示的是把删除的元素用100来替换。</span>
vm<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span>


</code></pre></div><p>下面我们再来看一下关于<code>vm.arr.length=0</code>,表示的是清空数组中的内容。</p> <p>为了达到响应式的效果，这里也可以使用splice方法来完成，清空数组的操作。</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//清空数组中的所有元素</span>

</code></pre></div><p>通过查看源码我们对上面的问题有了更加深入的理解。</p> <h1 id="_19、watcher"><a href="#_19、watcher" class="header-anchor">#</a> 19、Watcher</h1> <p>关于<code>Watcher</code>我们首先会查看一下在首次渲染的时候的执行过程，然后再来看一下当数据发生变化后，<code>Watcher</code>的执行过程。</p> <p><code>Watcher</code>分为三种，<code>Computed Watcher</code>(计算属性，本质也是通过<code>Watcher</code>来实现的),用户<code>Watcher</code>(侦听器)，渲染<code>Watcher</code></p> <p>前面两种<code>Watcher</code>是在<code>initState</code>的时候初始化的。</p> <p>下面我们来复习一下首次渲染的时候<code>Watcher</code>的执行过程。</p> <p><code>/src/core/instance/lifecycle.js</code>中的<code>mountComponent</code>组件中创建的。</p> <p>如下代码所示：</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">//vm:Vue的实例</span>
<span class="token comment">// updateComponent</span>
<span class="token comment">//noop空函数，</span>
 <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> updateComponent<span class="token punctuation">,</span> noop<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">before</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_isMounted <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>_isDestroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//触发beforeUpate方法。</span>
        <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeUpdate'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* isRenderWatcher */</span><span class="token punctuation">)</span><span class="token comment">//ture表示渲染的watcher.</span>

</code></pre></div><p>下面进入<code>Watcher</code>类中，看一下做了哪些事情。以下的代码是<code>Watcher</code>类的构造函数。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter"><span class="token literal-property property">vm</span><span class="token operator">:</span> Component<span class="token punctuation">,</span>
    <span class="token literal-property property">expOrFn</span><span class="token operator">:</span> string <span class="token operator">|</span> Function<span class="token punctuation">,</span>
    <span class="token literal-property property">cb</span><span class="token operator">:</span> Function<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> <span class="token operator">?</span>Object<span class="token punctuation">,</span>
    isRenderWatcher<span class="token operator">?</span><span class="token operator">:</span> boolean</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//将Vue的实例记录到了vm这个属性中。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果是渲染`Watcher`,则将`Watcher`的实例保存到`Vue`实例中的`_watcher`属性中。</span>
      vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
      <span class="token comment">//将所有的`Watcher`实例都保存到`Vue`实例中的`_watchers`这个数组中。</span>
      <span class="token comment">// _watchers数组中不仅存储了渲染`Watcher`,还存储了计算属性对应的watcher,还有就是侦听器。</span>
    vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token comment">// options</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>deep
      <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>user
      <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy
      <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>sync
      <span class="token keyword">this</span><span class="token punctuation">.</span>before <span class="token operator">=</span> options<span class="token punctuation">.</span>before
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>deep <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
      <span class="token comment">//创建渲染watcher的实例的时候，传递过来的cb函数就是一个noop空函数。</span>
      <span class="token comment">//如果是用户创建的`Watcher`的时候，传递过来的就是一个回调函数。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>uid <span class="token comment">//为了区分每个watcher,创建一个编号 uid for batching</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token comment">// active表示这个watcher是否为活动的watcher,如果为true,则为活动的watcher.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token comment">// for lazy watchers</span>
      <span class="token comment">//下面的集合记录的都是Dep</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expression <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span>
      <span class="token operator">?</span> expOrFn<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token string">''</span>
    <span class="token comment">// parse expression for getter</span>
      <span class="token comment">//判断expOrFn是否为函数，我们在前面创建渲染watcher的时候，传递过来的updateComponent函数给了expOrFn这个参数。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//将函数保存到了getter中。</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// expOrFn 是字符串的时候，也就是创建侦听器的时候传递的内容，例如 watch: { 'person.name': function... }</span>
        <span class="token comment">// 这时候侦听器侦听的内容是字符串，也就是person.name</span>
      <span class="token comment">// parsePath('person.name') 返回一个函数获取 person.name 的值</span>
        <span class="token comment">//parsePath的作用就是生成一个函数，来获取`person.name`的值。将返回的函数记录到了getter中。记录geeter中的目的，就是当获取属性值的时候会触发对应的getter,当触发getter的时候会触发依赖。</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed watching path: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expOrFn<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token string">'Watcher only accepts simple dot-delimited paths. '</span> <span class="token operator">+</span>
          <span class="token string">'For full control, use a function instead.'</span><span class="token punctuation">,</span>
          vm
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
      <span class="token comment">//如果是计算属性，lazy的值为true,表示延迟执行。如果是渲染watcher,会立即调用get方法。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
      <span class="token operator">?</span> <span class="token keyword">undefined</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>


</code></pre></div><p>下面就是<code>get</code>方法的源码。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//把当前的watcher对象入栈，并且把当前的watcher赋值给Dep的target属性。</span>
      <span class="token comment">//当有父子组件嵌套的时候，先将父组件的watcher入栈，然后对子组件进行处理，处理完毕后，在从栈中获取父组件的watcher进行处理。</span>
    <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> value
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//对getter函数进行调用，如果是渲染函数，这里调用的是updateComponent</span>
        <span class="token comment">//当updateComponent函数执行完毕后会将虚拟DOM转换成真实的DOM,然后渲染到页面中。</span>
      value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getter for watcher &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> e
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// &quot;touch&quot; every property so they are all tracked as</span>
      <span class="token comment">// dependencies for deep watching</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//表示进行深度监听，深度监听表示的就是如果监听的是一个对象的话，会监听这个对象下的子属性、</span>
        <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
        <span class="token comment">//处理完毕后，做一些清理的工作，例如将watcher从栈中弹出</span>
      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//将Watcher从subs数组中移除</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value
  <span class="token punctuation">}</span>

</code></pre></div><p>以上就是首次渲染的时候，<code>Watcher</code>的执行过程。</p> <p><strong>下面，我们来看一下当数据发生更新的时候，<code>Watcher</code>是怎样工作的？</strong></p> <p>下面我们来查看一下<code>observer/dep.js</code></p> <p>我们知道当数据发生了变化后，会调用<code>Dep</code>中的<code>notify</code>这个方法，下面我们来看一下该方法的代码，如下所示:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 发布通知</span>
  <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// stabilize the subscriber list first</span>
      <span class="token comment">//subs数组中存储的就是`watcher`对象，调用slice方法实现了克隆，因为下面会对subs数组中的内容进行排序。</span>
    <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// subs aren't sorted in scheduler if not running async</span>
      <span class="token comment">// we need to sort them now to make sure they fire in correct</span>
      <span class="token comment">// order</span>
        <span class="token comment">//按照Watcher对象中的id值进行从小到大的排序，也就是按照`watcher`的创建顺序进行排序，从而保证了在执行`watcher`的时候顺序是正确的。</span>
      subs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用每个watcher对象的update方法实现更新</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在上面的代码中，对<code>subs</code>数组进行遍历，然后获取对应的<code>Watcher</code>,然后调用<code>Watcher</code>对象的<code>update</code>方法，下面我们来看一下<code>update</code>这个方法中的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">update</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token comment">//在渲染watcher的时候，把lazy属性与sync属性设置为了false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//渲染watcher会执行queueWatcher,</span>
        <span class="token comment">//该方法的作用就是将watcher的实例放到一个队列中。</span>
      <span class="token function">queueWatcher</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


</code></pre></div><p>下面，我们来查看一下<code>queueWatcher</code>方法内部的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">queueWatcher</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">watcher</span><span class="token operator">:</span> Watcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id<span class="token comment">//获取watcher的id属性</span>
  <span class="token comment">//has是一个对象，下面获取has中的值，如果为null,表示当前这个watcher对象还没有被处理。</span>
  <span class="token comment">//下面加这个判断的目的，就是为了防止watcher被重复性的处理。</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token comment">//把has[id]设置为true,表明当前的watcher对象已经被处理了。</span>
      <span class="token comment">//下面就是开始正式的处理watcher</span>
      <span class="token comment">//flushing为true,表明queue这个队列正在被处理。队列中存储的是watcher对象，也就是watcher对象正在被处理。</span>
      <span class="token comment">//如果下面的判断条件成立，表明没有处理队列，那么就将watcher放到队列中。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// if already flushing, splice the watcher based on its id</span>
      <span class="token comment">// if already past its id, it will be run next immediately.</span>
        <span class="token comment">//如果执行else表明队列正在被处理，那么这里需要找到队列中一个合适位置，然后把watcher插入到队列中。</span>
        <span class="token comment">//那么这里是怎样获取位置的呢？</span>
        <span class="token comment">//首先获取队列的长度。</span>
        <span class="token comment">//index表示现在处理到了队列中的第几个元素，如果i大于index,则表明当前这个队列并没有处理完。</span>
        <span class="token comment">//下面需要从后往前，取到队列中的每个watcher对象，然后判断id是否大于watcher.id,如果大于正在处理的这个watcher的id,那么这个位置就是插入watcher的位置</span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> index <span class="token operator">&amp;&amp;</span> queue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>id <span class="token operator">&gt;</span> watcher<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        i<span class="token operator">--</span>
      <span class="token punctuation">}</span>
       <span class="token comment">//下面就是把待处理的watcher放到队列的合适位置。</span>
      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>
        
        <span class="token comment">//上面的代码其实就是把当前将要处理的watcher对象放到队列中。</span>
        <span class="token comment">//下面就开始执行队列中的watcher对象。</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// queue the flush</span>
      <span class="token comment">//下面判断的含义就是判断一下当前的队列是否正在被执行。</span>
      <span class="token comment">//如果watiing为false,表明当前队列没有被执行，下面需要将waiting设置为true.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waiting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      waiting <span class="token operator">=</span> <span class="token boolean">true</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>async<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//开发环境直接调用下面的flushSchedulerQueue方法</span>
          <span class="token comment">//flushSchedulerQueue方法的作用会遍历队列，然后调用队列中每个watcher的run方法。</span>
        <span class="token function">flushSchedulerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
        <span class="token comment">//生产环境会将flushSchedulerQueue函数传递到nextTick函数中，后面再来讲解nextTick的应用。</span>
      <span class="token function">nextTick</span><span class="token punctuation">(</span>flushSchedulerQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>下面我们来看一下<code>flushSchedulerQueue</code>方法内部的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushSchedulerQueue</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentFlushTimestamp <span class="token operator">=</span> <span class="token function">getNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  flushing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token comment">//将flushing设置为true,表明正在处理队列</span>
  <span class="token keyword">let</span> watcher<span class="token punctuation">,</span> id

  <span class="token comment">// Sort queue before flush.</span>
  <span class="token comment">// This ensures that:</span>
  <span class="token comment">//组件的更新顺序是从父组件到子组件，因为先创建了父组件后创建了子组件</span>
  <span class="token comment">// 1. Components are updated from parent to child. (because parent is always</span>
  <span class="token comment">//    created before the child)</span>
  <span class="token comment">//组件的用户watcher,要在渲染watcher之前运行，因为用户watcher是在渲染watcehr之前创建的。</span>
  <span class="token comment">// 2. A component's user watchers are run before its render watcher (because</span>
  <span class="token comment">//    user watchers are created before the render watcher)</span>
  <span class="token comment">// 如果一个组件，在父组件执行前被销毁了，那么对应的watcher应该跳过。</span>
  <span class="token comment">// 3. If a component is destroyed during a parent component's watcher run,</span>
  <span class="token comment">//    its watchers can be skipped.</span>
  
  <span class="token comment">//对队列中的watcher进行排序，排序的方式是根据对应id，从小到大的顺序 进行排序。也就是按照watcher的创建顺序进行排列。</span>
  <span class="token comment">//为什么要进行排序呢？上面的注释已经给出了三点的说明</span>
  queue<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>id <span class="token operator">-</span> b<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

  <span class="token comment">// do not cache length because more watchers might be pushed</span>
  <span class="token comment">// as we run existing watchers</span>
    <span class="token comment">//以上注释的含义：不要缓存length,因为watcher在执行的过程中，还会向队列中放入新的watcher.</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//对队列进行遍历，然后取出当前要处理的watcher.</span>
    watcher <span class="token operator">=</span> queue<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//判断是否有before这个函数，该函数是在渲染watcher中具有的一个函数。其作用就是触发beforeupdate这个钩子函数。</span>
        <span class="token comment">//也就是说走到这个位置beforeupate这个钩子函数被触发了。</span>
      watcher<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    id <span class="token operator">=</span> watcher<span class="token punctuation">.</span>id<span class="token comment">//获取watcher的id</span>
    has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token comment">//将has[id]的值设为null,表明当前的watcher已经被处理过了。</span>
    watcher<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//执行watcher中的run方法。下面看一下run方法中的源码。</span>
    <span class="token comment">// in dev build, check and stop circular updates.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> has<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>circular<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token constant">MAX_UPDATE_COUNT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token string">'You may have an infinite update loop '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>
            watcher<span class="token punctuation">.</span>user
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in watcher with expression &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>watcher<span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
              <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">in a component render function.</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          watcher<span class="token punctuation">.</span>vm
        <span class="token punctuation">)</span>
        <span class="token keyword">break</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 

</code></pre></div><p>下面是<code>run</code>方法的实现代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">run</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//标记当前的watcher对象是否为存活的状态。active默认值为true,表明可以对watcher进行处理。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//调用watcher对象中的get方法，在get方法中会进行判断，如果是渲染watcher会调用updatecomponent方法，来渲染组件，更新视图</span>
      <span class="token comment">//对于渲染watcher来说，对应的updateComponent方法是没有返回值，所以常量value的值为undefined.所以下面的代码不在执行，但是是用户 watcher,那么会调用其对应的回调函数，我们创建侦听器的时候，指定了回调函数。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        value <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">||</span>
        <span class="token comment">// Deep watchers and watchers on Object/Arrays should fire even</span>
        <span class="token comment">// when the value is the same, because the value may</span>
        <span class="token comment">// have mutated.</span>
        <span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deep
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// set new value</span>
        <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback for watcher &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>以上就是数据更新后，<code>watcher</code>的执行过程。</p> <p>我们总结一下：当数据发生了变化后，会调用<code>Dep</code>中的<code>notify</code>方法去通知watcher,首先会将<code>watcher</code>放入到一个队列中，然后遍历队列，调用<code>Watcher</code>对象的<code>run</code>方法，在<code>run</code>方法中调用了渲染<code>watcher</code>的<code>updatecomponet</code>这个函数来渲染组件，更新视图，以上就是整个的处理过程。</p> <h1 id="_20、总结响应式处理的过程"><a href="#_20、总结响应式处理的过程" class="header-anchor">#</a> 20、总结响应式处理的过程</h1> <p>响应式是从<code>Vue</code>实例的<code>initState</code>方法开始的，在<code>initState</code>中完成了<code>Vue</code>实例状态的初始化，在<code>initState</code>方法的内部调用了<code>initData</code>方法，该方法的作用就是把<code>data</code>属性注入到了<code>Vue</code>的实例中，并且在其内部调用了<code>observe</code>方法，在<code>observe</code>方法中把<code>data</code>对象转换成响应式对象。所以说<code>observe</code>就是响应式的入口，下面我们来看一下在<code>observe</code>方法中做了哪些事情：</p> <p><code>observe</code>方法所在的位置<code>src/core/observer/index.js</code>.</p> <p>在调用<code>observe</code>方法的时候，会传递一个参数<code>value</code>,所以在<code>observe</code>方法中首先会判断一下传递过来的参数<code>value</code>是否为对象，如果不是对象直接返回。</p> <p>然后判断<code>value</code>对象是否有<code>__ob__</code>属性,如果有说明之前已经对其做过响应式的处理，所以直接返回。</p> <p>如果没有<code>__ob__</code>属性，在创建<code>observer</code>对象，最后将<code>observer</code>对象返回。</p> <p>那在创建<code>observer</code>对象的时候又做了哪些事情呢？</p> <p><code>observer</code>对象是有<code>Observer</code>类创建的(位置:<code>src/core/observer/index.js</code>),在<code>Observer</code>类的构造函数中，给<code>value</code>对象定义不可枚举的<code>__ob__</code>属性，并且通过该数据记录当前的<code>observer</code>对象。接下来进行了数组的响应式处理与对象的响应式处理。</p> <p>在对数组进行响应式处理的时候，主要是设置了数组常用的方法，例如<code>push</code>,<code>pop</code>等。这些方法会改变原数组，所以当这些方法调用的时候，会发送通知。</p> <p>在发送通知的时候，找到数组对应的<code>__ob__</code>属性,也就是<code>observer</code>对象，再找到<code>observer</code>对象的<code>dep</code>,然后调用<code>dep</code>中的<code>notify</code>方法。</p> <p>更改了这些数组的方法后，下面就开始遍历数组中的每个成员，对每一个成员再去调用<code>observer</code>,如果这个成员是对象，也会将这个对象转换成响应式。</p> <p>这就是关于数组的响应式处理。</p> <p>下面我们再来看一下关于对象的响应式处理。关于对象的响应式处理，调用的是<code>walk</code>方法。</p> <p>在<code>walk</code>方法内部会遍历对象中的所有属性，对每一个属性调用<code>defineReactive</code>方法（位置：<code>src/core/observer/index.js</code>），在<code>defineReactive</code>方法的内部会为每一个属性创建<code>dep</code>对象。让<code>dep</code>收集依赖。如果当前对象的属性值是对象，则会调用<code>observe</code>,也就是说如果当前对象的属性是对象，调用<code>observe</code>方法的目录就是把这个对象也转换成响应式对象。</p> <p>在<code>defineReactive</code>方法的内部定义了<code>getter</code>和<code>setter</code>.</p> <p>在<code>getter</code>中收集依赖，当然在收集依赖的时候，会为每一个属性收集依赖。如果属性的值为对象，也要收集依赖。<code>getter</code>方法最终会返回属性的值。</p> <p>下面看一下<code>setter</code>,在<code>setter</code>方法中会保存新值，如果新值是对象也会调用<code>observe</code>,把这个新设置的对象也转换为响应式的对象。在<code>setter</code>方法椎间盘每个。数据发生变化，所以会派发通知，调用<code>dep.notify</code>方法。</p> <p>下面我们再来看一下关于<code>收集</code>依赖的过程。在收集依赖的过程中，首先会调用<code>watcher</code>对象的<code>get</code>方法，在<code>get</code>方法中调用了<code>pushTarget</code>,在该方法中会将当前的<code>watcher</code>对象记录到<code>Dep.target</code>属性中。</p> <p>在访问<code>data</code>中的成员的时候收集依赖，当访问属性的值时候会触发<code>defineReactive</code>中的<code>getter</code>方法来收集依赖。这时候会把属性对应的<code>watcher</code>对象添加到<code>dep</code>的<code>subs</code>数组中。如果属性的值也是对象，这时会创建一个<code>childOb</code>对象，为子对象收集依赖，目的就是在子对添加或者是删除成员的时候发送通知。</p> <p>下面我们再来看一下<code>Watcher</code>,当数据发生变化的时候会调用<code>dep.notify</code>方法发送通知，同时在内容调用了<code>update</code>方法，在该方法中又调用了<code>queueWatcher</code>方法，在<code>queueWatcher</code>方法中会判断当前的<code>watcher</code>是否被处理了。如果没有处理，在添加到<code>queue</code>队列中，并调用了<code>flushSchedulerQueue()</code>方法，在该方法中触发了<code>beforeUpdate</code>这个钩子函数，然后调用了<code>watcher.run</code>方法，在该方法中最终调用了<code>updateComponent</code>方法（当前是渲染<code>watcher</code>）.这时已经将数据更新到了视图中，那么我们在页面中看到了最新的数据。最后触发了<code>actived</code>钩子函数和<code>updated</code>钩子函数。</p> <h1 id="_21、动态添加一个响应式属性"><a href="#_21、动态添加一个响应式属性" class="header-anchor">#</a> 21、动态添加一个响应式属性</h1> <p>在这里我们考虑一个问题，就是给一个响应式对象，动态增加一个属性，那么这个属性是否为响应式的呢？</p> <p>下面我们通过如下代码来演示。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{obj.title}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>
    {{obj.name}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span>
    {{arr}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>srcipt</span><span class="token punctuation">&gt;</span></span>
	const vm=new Vue({
     el:'#app',
     data:{
    	obj:{
    	title:'Hello World'
   		 },
    	arr:[2,2,3]
    }	
    })

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>srcipt</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>在上面的代码中，<code>data</code>中定义了一个对象<code>obj</code>,并且<code>obj</code>中有一个属性<code>title</code>,并且展示在了视图中，</p> <p>同时在视图中还展示了<code>obj</code>对象中的<code>name</code>属性，但是我们并没有在<code>obj</code>对象中创建<code>name</code>属性。下面我们会动态的向</p> <p><code>obj</code>对象中动态的增加一个属性<code>name</code>,看一下是否会渲染视图。</p> <p>下面我们在浏览器中打开上面的页面，会展示<code>title</code>与<code>arr</code>数组中的内容。</p> <p>但是由于没有<code>name</code>，所以不会展示。</p> <p>打开浏览器的控制台，在<code>Console</code>中输入如下代码：</p> <div class="language- extra-class"><pre class="language-text"><code>vm.obj.name=&quot;abc&quot;

</code></pre></div><p>执行完上面的代码后，并没有看到对应的视图的变化，所以动态添加的<code>name</code>属性并不是响应式的。</p> <p>如果我们这里有这个需求，可以通过<code>vm.$set</code>或者是<code>Vue.set</code>来解决(这两个方法是一样的)。</p> <p>如下代码：</p> <div class="language- extra-class"><pre class="language-text"><code>vm.$set(vm.obj,'name','zhangsan')

</code></pre></div><p>上面的代码，通过<code>Vue</code>的实例调用了<code>$set</code>方法，给<code>obj</code>对象添加了<code>name</code>属性，值为<code>zhangsan</code>.</p> <p>通过以上方式添加属性为响应式的。</p> <p>下面我们修改一下<code>arr</code>数组中的第一项内容，看一下是否为响应式的。</p> <p>如果是<code>arr[0]=100</code>这种修改方式，并不是响应式的，关于这一点我们在前面也讲解过。</p> <p>我么可以使用<code>slice</code>函数来修改，或者可以使用<code>vm.$set</code>方法也是可以的。</p> <div class="language- extra-class"><pre class="language-text"><code>vm.$set(vm.arr,0,100)

</code></pre></div><p>把<code>arr</code>数组中的下标为<code>0</code>的这一项的值修改为<code>100</code>/</p> <p>以上代码实现的操作为响应式的。</p> <p>关于<code>vm.$set</code>的使用也可以参考官方文档。</p> <div class="language- extra-class"><pre class="language-text"><code>https://cn.vuejs.org/v2/api/#Vue-set

</code></pre></div><p>向响应式对象中添加一个 <code>property</code>，并确保这个新 <code>property</code>同样是响应式的，且触发视图更新。它必须用于向响应式对象上添加新 <code>property</code>，因为 <code>Vue</code>无法探测普通的新增<code>property</code> (比如 <code>this.myObject.newProperty = 'hi'</code>)</p> <div class="language- extra-class"><pre class="language-text"><code>注意对象不能是 Vue 实例，或者 Vue 实例的根数据对象

</code></pre></div><p>以下代码是错误的。</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span>

</code></pre></div><p>以上代码是想<code>vue</code>的实例添加属性<code>abc</code>,以上写法是错误的。</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span><span class="token function">$set</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$data<span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">,</span><span class="token string">'12'</span><span class="token punctuation">)</span>

</code></pre></div><p>以上代码是向<code>data</code>中添加属性，以上代码也是错误的。表明不能向<code>Vue</code>实例的根数据对象中动态添加属性。</p> <p>以上就是关于<code>set</code>方法的使用的方式。下一小节，我们来查看<code>set</code>的源代码。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/vuepress-starter/vue/vueRouter.html" class="prev">
          vueRouter路由
        </a></span> <span class="next"><a href="/vuepress-starter/vue/vueInterview.html">
          vue面试
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:0;" data-v-b57cc07c data-v-7dd95ae2></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 TS文档
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="150" height="220" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div></div></div>
    <script src="/vuepress-starter/assets/js/app.9588c189.js" defer></script><script src="/vuepress-starter/assets/js/9.d0fd5d46.js" defer></script><script src="/vuepress-starter/assets/js/1.a4aa22ef.js" defer></script><script src="/vuepress-starter/assets/js/121.0f334874.js" defer></script>
  </body>
</html>
