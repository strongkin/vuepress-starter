<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue 相关原理进阶 | TS文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="TS文档翻译">
    
    <link rel="preload" href="/vuepress-starter/assets/css/0.styles.d7e25954.css" as="style"><link rel="preload" href="/vuepress-starter/assets/js/app.e3fb7a36.js" as="script"><link rel="preload" href="/vuepress-starter/assets/js/2.659413da.js" as="script"><link rel="preload" href="/vuepress-starter/assets/js/18.3c4946c5.js" as="script"><link rel="prefetch" href="/vuepress-starter/assets/js/10.f0a54ab5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/11.d2f2be24.js"><link rel="prefetch" href="/vuepress-starter/assets/js/12.35e804de.js"><link rel="prefetch" href="/vuepress-starter/assets/js/13.3cc25877.js"><link rel="prefetch" href="/vuepress-starter/assets/js/14.31666be5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/15.162fc1ed.js"><link rel="prefetch" href="/vuepress-starter/assets/js/16.7367de07.js"><link rel="prefetch" href="/vuepress-starter/assets/js/17.148da913.js"><link rel="prefetch" href="/vuepress-starter/assets/js/19.b89a248b.js"><link rel="prefetch" href="/vuepress-starter/assets/js/20.3e6bb9a7.js"><link rel="prefetch" href="/vuepress-starter/assets/js/21.a6f71e56.js"><link rel="prefetch" href="/vuepress-starter/assets/js/22.7cbca601.js"><link rel="prefetch" href="/vuepress-starter/assets/js/23.c9b13606.js"><link rel="prefetch" href="/vuepress-starter/assets/js/3.419d79d3.js"><link rel="prefetch" href="/vuepress-starter/assets/js/4.795ea2c9.js"><link rel="prefetch" href="/vuepress-starter/assets/js/5.f572c9b5.js"><link rel="prefetch" href="/vuepress-starter/assets/js/6.01825db4.js"><link rel="prefetch" href="/vuepress-starter/assets/js/7.d872f524.js"><link rel="prefetch" href="/vuepress-starter/assets/js/8.20633d30.js"><link rel="prefetch" href="/vuepress-starter/assets/js/9.57110574.js">
    <link rel="stylesheet" href="/vuepress-starter/assets/css/0.styles.d7e25954.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-starter/" class="home-link router-link-active"><!----> <span class="site-name">TS文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-starter/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-starter/handbook/ConditionalTypes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  vue组件
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=" JavaScript 博客" class="dropdown-title"><span class="title"> JavaScript 博客</span> <span class="arrow down"></span></button> <button type="button" aria-label=" JavaScript 博客" class="mobile-dropdown-title"><span class="title"> JavaScript 博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/strongkin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-starter/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/vuepress-starter/handbook/ConditionalTypes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  vue组件
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label=" JavaScript 博客" class="dropdown-title"><span class="title"> JavaScript 博客</span> <span class="arrow down"></span></button> <button type="button" aria-label=" JavaScript 博客" class="mobile-dropdown-title"><span class="title"> JavaScript 博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/strongkin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress-starter/handbook/" class="sidebar-heading clickable router-link-active open"><span>基础学习</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-starter/handbook/ConditionalTypes.html" aria-current="page" class="active sidebar-link">vue 相关原理进阶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_1-整体目标" class="sidebar-link">1 - 整体目标</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_2-数据响应式" class="sidebar-link">2 - 数据响应式</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_3-数据的变化反应到视图" class="sidebar-link">3 - 数据的变化反应到视图</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_4-视图的变化反应到数据" class="sidebar-link">4 - 视图的变化反应到数据</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_5-现存架构的问题" class="sidebar-link">5 - 现存架构的问题</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_6-发布订阅模式优化" class="sidebar-link">6 - 发布订阅模式优化</a></li><li class="sidebar-sub-header"><a href="/vuepress-starter/handbook/ConditionalTypes.html#_7-整体总结" class="sidebar-link">7 - 整体总结</a></li></ul></li><li><a href="/vuepress-starter/handbook/Generics.html" class="sidebar-link">react-redux 的新特性 useSelector, useDispatch</a></li><li><a href="/vuepress-starter/handbook/Commponet.html" class="sidebar-link">vue组件开发</a></li><li><a href="/vuepress-starter/handbook/Ssr.html" class="sidebar-link">ssr</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小兔仙+TS+pinia</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue-相关原理进阶"><a href="#vue-相关原理进阶" class="header-anchor">#</a> vue 相关原理进阶</h1> <h2 id="_1-整体目标"><a href="#_1-整体目标" class="header-anchor">#</a> 1 - 整体目标</h2> <ul><li>[x] 了解<code>Object.defineProperty</code>实现响应式</li> <li>[x] 了解<code>指令编译</code>的基础原理</li> <li>[x] 清楚<code>observe/watcher/dep</code>具体指的是什么</li> <li>[x] 了解<code>发布订阅模式</code>以及其解决的具体问题</li></ul> <h2 id="_2-数据响应式"><a href="#_2-数据响应式" class="header-anchor">#</a> 2 - 数据响应式</h2> <h3 id="_2-1-响应式是什么"><a href="#_2-1-响应式是什么" class="header-anchor">#</a> 2.1 响应式是什么</h3> <blockquote><p>一旦数据发生变化，我们可以立刻知道，并且做一些你想完成的事情，这些事情包括但不限于以下：</p></blockquote> <ul><li>发送一个网络请求</li> <li>打印一段文字</li> <li>操作一个 dom</li> <li>....</li></ul> <h3 id="_2-2-如何实现数据响应式"><a href="#_2-2-如何实现数据响应式" class="header-anchor">#</a> 2.2 如何实现数据响应式</h3> <p>在 Javascript 里实现数据响应式一般有俩种方案，分别对应着 vue2.x 和 vue3.x 使用的方式，他们分别是：</p> <ol><li><p>对象属性拦截 (vue2.x)</p> <p><code>Object.defineProperty</code></p></li> <li><p>对象整体代理 (vue3.x)</p> <p><code>Proxy</code></p></li></ol> <p>其中<strong>对象属性拦截</strong>，是我们本次课程关注的重点，不管使用其中的哪种方式，道理都是相通的</p> <h3 id="_2-3-实现对象属性拦截"><a href="#_2-3-实现对象属性拦截" class="header-anchor">#</a> 2.3 实现对象属性拦截</h3> <p>字面量对象定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Object.defineProperty 对象定义</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 访问name属性就会执行此方法 返回值就是获取到的值</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被获取了&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;柴柴老师&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 设置新值就会执行此方法 newVal就是设置的新值</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被设置新值了&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-4-优化-1-get-和-set-联动"><a href="#_2-4-优化-1-get-和-set-联动" class="header-anchor">#</a> 2.4 优化 1- get 和 set 联动</h3> <blockquote><p>上一小节，我们的 get 方法中返回的值始终是<code>柴柴老师</code>，是固定的，set 中拿到新值之后，我们如何让 get 中可以得到 newVal 使我们需要解决的问题</p></blockquote> <h4 id="现存问题"><a href="#现存问题" class="header-anchor">#</a> 现存问题</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 访问name属性就会执行此方法 返回值就是获取到的值</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被获取了&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;柴柴老师&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 设置新值就会执行此方法 newVal就是设置的新值</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被设置新值了&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="错误演示"><a href="#错误演示" class="header-anchor">#</a> 错误演示</h4> <p><img src="asset/oldname.png" alt=""></p> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h4> <blockquote><p>我们可以 通过一个中间变量 <code>_name</code> 来中转 get 函数和 set 函数之间的联动</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">let</span> _name <span class="token operator">=</span> <span class="token string">&quot;柴柴老师&quot;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 访问name属性就会执行此方法 返回值就是获取到的值</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被获取了&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> _name
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 设置新值就会执行此方法 newVal就是设置的新值</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;name属性被设置新值了&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span>
    _name <span class="token operator">=</span> newVal
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="结果验证"><a href="#结果验证" class="header-anchor">#</a> 结果验证</h4> <p><img src="asset/_name.png" alt=""></p> <h3 id="_2-5-优化-2-更加通用的劫持方案"><a href="#_2-5-优化-2-更加通用的劫持方案" class="header-anchor">#</a> 2.5 优化 2-更加通用的劫持方案</h3> <blockquote><p>大家想想看，如果现在有一份已经声明好了数据的对象，我们如何通过劫持的方法把每一个属性都变成 setter 和 getter 的形式</p></blockquote> <p>一份已经声明好的数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我想让里面所有的属性都变成响应式的，并且 get 和 set 方法中对于每个属性值的操作是连通的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// 遍历每一个属性</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// key 属性名</span>
  <span class="token comment">// data[key] 属性值</span>
  <span class="token comment">// data 原对象</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 响应式转化方法</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> newVal
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>!&gt; 结构说明：这个地方实际上使用了闭包的特性，看下图，在每一次的 defineReactive 函数执行的时候，都会形成一块独立的函数作用域，传入的<code>value</code> 因为闭包的关系会常驻内存，这样一来，每个 defineReactive 函数中的<code>value</code> 会作为各自 set 和 get 函数操作的局部变量</p> <p><img src="asset/defineReactive.png" alt=""></p> <h3 id="_2-6-响应式总结"><a href="#_2-6-响应式总结" class="header-anchor">#</a> 2.6 响应式总结</h3> <ol><li>所谓的响应式其实就是拦截对象属性的访问和设置，插入一些我们自己想要做的事情</li> <li>在 Javascript 中能实现响应式拦截的方法有俩种，<code>Object.defineProperty</code>方法和<code>Proxy对象代理</code></li> <li>回归到 vue2.x 中的 data 配置项，只要放到了 data 里的数据，不管层级多深不管你最终会不会用到这个数据都会进行递归响应式处理，所以要求我们如非必要，尽量不要添加太多的冗余数据在 data 中</li> <li>需要了解 vue3.x 中，解决了 2 中对于数据响应式处理的无端性能消耗，使用的手段是 Proxy 劫持对象整体 + 惰性处理（用到了才进行响应式转换）</li></ol> <h2 id="_3-数据的变化反应到视图"><a href="#_3-数据的变化反应到视图" class="header-anchor">#</a> 3 - 数据的变化反应到视图</h2> <p>上一章节，我们了解到数据劫持之后，我们可以在数据发生修改之后做任何我们想要做的事情，操作视图当然也是 OK 的，回归到我们的主角-视图上，我们学习下如何把数据的变化在视图上反应出来，看下面的案例</p> <p><img src="asset/01.png" alt=""></p> <p>!&gt; 要想把数据反应到视图中，本质上还是离不开 dom 操作</p> <h3 id="_3-1-命令式操作视图"><a href="#_3-1-命令式操作视图" class="header-anchor">#</a> 3.1 命令式操作视图</h3> <blockquote><p>目标：我们通过原始的操作 dom 的方式让每一次的 name 的最新值都能显示到 p 元素内部</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历每一个属性</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 属性名</span>
    <span class="token comment">// data[key] 属性值</span>
    <span class="token comment">// data 原对象</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 数据发生变化,操作dom进行更新</span>
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">.</span>name
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 首次渲染</span>
  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#app p&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">.</span>name
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-2-声明式操作视图"><a href="#_3-2-声明式操作视图" class="header-anchor">#</a> 3.2 声明式操作视图</h3> <blockquote><p>目标：我们将 data 中 name 属性的值作为文本渲染到标记了 v-text 的 p 标签内部，在 vue 中，我们把这种标记式的声明式渲染叫做<code>指令</code></p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历每一个属性</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 属性名</span>
    <span class="token comment">// data[key] 属性值</span>
    <span class="token comment">// data 原对象</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> newVal
        <span class="token comment">// 数据发生变化,操作dom进行更新</span>
        <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//</span>
  <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 1.拿到app下所有的子元素</span>
    <span class="token keyword">const</span> nodes <span class="token operator">=</span> app<span class="token punctuation">.</span>childNodes <span class="token comment">//  [text, input, text]</span>
    <span class="token comment">//2.遍历所有的子元素</span>
    nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// nodeType为1为元素节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> attrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes
        <span class="token comment">// 遍历所有的attrubites找到 v-model</span>
        Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> dirName <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeName
          <span class="token keyword">const</span> dataProp <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeValue
          <span class="token keyword">if</span> <span class="token punctuation">(</span>dirName <span class="token operator">===</span> <span class="token string">&quot;v-text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 首次渲染</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-3-总结"><a href="#_3-3-总结" class="header-anchor">#</a> 3.3 总结</h3> <ol><li>不管是指令也好，插值表达式也好，这些都是将数据反应到视图的标记而已，通过标记我们可以把数据的变化响应式的反应到对应的 dom 位置上去</li> <li>找标记，把数据绑定到 dom 的过程，我们称之为<code>binding</code></li></ol> <h2 id="_4-视图的变化反应到数据"><a href="#_4-视图的变化反应到数据" class="header-anchor">#</a> 4 - 视图的变化反应到数据</h2> <blockquote><p>目标：将 data 中的 message 属性对应的值渲染到 input 上面，同时 input 值发生修改之后，可以反向修改 message 的值，在 vue 系统中，v-model 指令就是干这个事情的，下面我们就实现一下 v-model 的功能</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历每一个属性</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 属性名</span>
    <span class="token comment">// data[key] 属性值</span>
    <span class="token comment">// data 原对象</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 数据发生变化,操作dom进行更新</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        value <span class="token operator">=</span> newVal
        <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 编译函数</span>
  <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 1.拿到app下所有的子元素</span>
    <span class="token keyword">const</span> nodes <span class="token operator">=</span> app<span class="token punctuation">.</span>childNodes <span class="token comment">//  [text, input, text]</span>
    <span class="token comment">//2.遍历所有的子元素</span>
    nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// nodeType为1为元素节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> attrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes
        <span class="token comment">// 遍历所有的attrubites找到 v-model</span>
        Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> dirName <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeName
          <span class="token keyword">const</span> dataProp <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeValue
          <span class="token keyword">if</span> <span class="token punctuation">(</span>dirName <span class="token operator">===</span> <span class="token string">&quot;v-model&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
            <span class="token comment">// 视图变化反应到数据 无非是事件监听反向修改</span>
            node<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 首次渲染</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_5-现存架构的问题"><a href="#_5-现存架构的问题" class="header-anchor">#</a> 5 - 现存架构的问题</h2> <blockquote><p>无法做到精准更新</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;柴柴老师&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 遍历每一个属性</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 属性名</span>
    <span class="token comment">// data[key] 属性值</span>
    <span class="token comment">// data 原对象</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 数据发生变化,操作dom进行更新</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        value <span class="token operator">=</span> newVal
        <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 编译函数</span>
  <span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 1.拿到app下所有的子元素</span>
    <span class="token keyword">const</span> nodes <span class="token operator">=</span> app<span class="token punctuation">.</span>childNodes <span class="token comment">//  [text, input, text]</span>
    <span class="token comment">//2.遍历所有的子元素</span>
    nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// nodeType为1为元素节点</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> attrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes
        Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> dirName <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeName
          <span class="token keyword">const</span> dataProp <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeValue
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dirName<span class="token punctuation">,</span> dataProp<span class="token punctuation">)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>dirName <span class="token operator">===</span> <span class="token string">&quot;v-text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更新了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dirName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">指令,需要更新的属性为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dataProp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 首次渲染</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="asset/problem.png" alt=""></p> <p>为了做到精准更新，我们需要借助设计模式来优化我们的架构，下面我们就聊聊发布订阅模式~</p> <h2 id="_6-发布订阅模式优化"><a href="#_6-发布订阅模式优化" class="header-anchor">#</a> 6 - 发布订阅模式优化</h2> <h3 id="_6-1-优化思路思考"><a href="#_6-1-优化思路思考" class="header-anchor">#</a> 6.1 优化思路思考</h3> <p>1.数据更新之后实际上需要执行的代码是什么？</p> <div class="language-js extra-class"><pre class="language-js"><code>node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
</code></pre></div><p>为了保存当前的 node 和 dataProp，我们再次设计一个函数执行利用闭包函数将每一次编译函数执行时候的 node 和 dataProp 都缓存下来，所以每一次数据变化之后执行的是这样的一个<code>更新函数</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2.一个响应式数据可能会有多个视图部分都需要依赖，也就是响应式数据变化之后，需要执行的更新函数可能不止一个，如下面的代码所示，name 属性有俩个 div 元素都使用了它，所以当 name 变化之后，俩个 div 节点都需要得到更新，那属性和更新函数之间应该是一个一对多的关系</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>age<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;cp&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>经过分析我们可以得到下面的存储架构图，每一个响应式属性都绑定了相对应的更新函数，是一个一对多的关系，数据发生变化之后，只会再次执行和自己绑定的更新函数</p> <p><img src="asset/03.png" alt=""></p> <h3 id="_6-2-理解发布订阅模式-自定义事件"><a href="#_6-2-理解发布订阅模式-自定义事件" class="header-anchor">#</a> 6.2 理解发布订阅模式(自定义事件)</h3> <blockquote><p>理解发布订阅，关键是理解<code>一对多</code></p></blockquote> <h4 id="_1-从浏览器事件说起"><a href="#_1-从浏览器事件说起" class="header-anchor">#</a> 1. 从浏览器事件说起</h4> <p>dom 绑定事件的方式，我们学过俩种</p> <ol><li>dom.onclick = function(){}</li> <li>dom.addEventListener('click',()=&gt;{})</li></ol> <p>这俩种绑定方式的区别是，第二种方案可以实现同一个事件绑定多个回调函数，很明显这是一个一对多的场景，既然浏览器也叫作事件，我们试着分析下浏览器事件绑定实现的思路</p> <ol><li><p>首先 addEventListenr 是一个函数方法，接受俩个参数，分别是<code>事件类型</code> 和<code>回调函数</code></p></li> <li><p>因为是一个事件绑定多个回调函数，那在内存里大概会有这样的一个数据结构</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">click</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'cb1'</span><span class="token punctuation">,</span><span class="token string">'cb2'</span><span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'cb1'</span><span class="token punctuation">,</span><span class="token string">'cb2'</span><span class="token punctuation">,</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>触发事件执行，浏览器因为有鼠标键盘输入可以触发事件，大概的思路是通过事件名称找到与之关联的回调函数列表，然后遍历执行一遍即可</p></li></ol> <p>ok，我们分析了浏览器事件的底层实现思路，那我们完全可以自己模仿一个出来，事件的触发，我们也通过设计一个方法来执行</p> <h4 id="_2-实现简单的发布订阅"><a href="#_2-实现简单的发布订阅" class="header-anchor">#</a> 2. 实现简单的发布订阅</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 增加dep对象 用来收集依赖和触发依赖</span>
<span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">map</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 收集</span>
  <span class="token function">collect</span><span class="token punctuation">(</span><span class="token parameter">dataProp<span class="token punctuation">,</span> updateFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>updateFn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 触发</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token parameter">dataProp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">updateFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">updateFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-3-收集更新函数"><a href="#_6-3-收集更新函数" class="header-anchor">#</a> 6.3 收集更新函数</h3> <p>在编译函数执行的时候，我们把用于更新 dom 的更新函数收集起来</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 编译函数</span>
<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
  <span class="token comment">// 1.拿到app下所有的子元素</span>
  <span class="token keyword">const</span> nodes <span class="token operator">=</span> app<span class="token punctuation">.</span>childNodes <span class="token comment">//  [text, input, text]</span>
  <span class="token comment">//2.遍历所有的子元素</span>
  nodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// nodeType为1为元素节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> attrs <span class="token operator">=</span> node<span class="token punctuation">.</span>attributes
      <span class="token comment">// 遍历所有的attrubites找到 v-model</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> dirName <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeName
        <span class="token keyword">const</span> dataProp <span class="token operator">=</span> attr<span class="token punctuation">.</span>nodeValue
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dirName<span class="token punctuation">,</span> dataProp<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirName <span class="token operator">===</span> <span class="token string">&quot;v-text&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更新了</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dirName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">指令,需要更新的属性为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dataProp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
          <span class="token comment">// 收集更新函数</span>
          dep<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>dataProp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>innerText <span class="token operator">=</span> data<span class="token punctuation">[</span>dataProp<span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>查看收集结果</strong></p> <p><img src="asset/collect.png" alt=""></p> <h3 id="_6-4-触发更新函数"><a href="#_6-4-触发更新函数" class="header-anchor">#</a> 6.4 触发更新函数</h3> <blockquote><p>当属性发生变化的时候，我们通过属性找到对应的更新函数列表，然后依次执行即可</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 更新视图</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token keyword">return</span>
      value <span class="token operator">=</span> newValue
      <span class="token comment">// 再次编译要放到新值已经变化之后只更新当前的key</span>
      dep<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>验证优化结果</strong></p> <p><img src="asset/better.png" alt=""></p> <h3 id="_6-5-总结"><a href="#_6-5-总结" class="header-anchor">#</a> 6.5 总结</h3> <ol><li>了解了发布订阅模式的基础形态</li> <li>了解发布订阅可以解决什么样的具体问题（精准更新）</li></ol> <h2 id="_7-整体总结"><a href="#_7-整体总结" class="header-anchor">#</a> 7 - 整体总结</h2> <ol><li><p>数据响应式的实现无非是对象属性拦截，我们使用<code>Object.defineProperty</code>来实现，在 vue3 中使用<code>Proxy</code>对象代理方案进行了优化</p></li> <li><p>面试宝典上提到的几个专业名词</p> <p><code>observe</code>对象指的是把数据处理成响应式的对象</p> <p><code>watcher</code>指的其实就是数据变化之后的更新函数 (vue 中的 watcher 有两种，一种是用来更新视图的 watcher，一种是通过 watch 配置项声明的 watcher)</p> <p><code>dep</code>指的就是使用发布订阅实现的收集更新函数和触发更新函数的对象</p></li> <li><p>指令实现的核心无非是通过模板编译找到标识然后把数据绑上去，等到数据变化之后再重新放一次</p></li> <li><p>发布订阅模式的本质是解决一对多的问题，在 vue 中实现数据变化之后的精准更新</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/vuepress-starter/handbook/Generics.html">
        react-redux 的新特性 useSelector, useDispatch
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-starter/assets/js/app.e3fb7a36.js" defer></script><script src="/vuepress-starter/assets/js/2.659413da.js" defer></script><script src="/vuepress-starter/assets/js/18.3c4946c5.js" defer></script>
  </body>
</html>
