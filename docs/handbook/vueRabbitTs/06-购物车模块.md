# è´­ç‰©è½¦æ¨¡å—

## è´­ç‰©è½¦åŠŸèƒ½åˆ†æ

![](./media/01-16459814763577.png)

**æ€è·¯æµç¨‹**

1. è´­ç‰©è½¦çš„å„ç§æ“ä½œéƒ½ä¼šæœ‰ä¸¤ç§çŠ¶æ€çš„åŒºåˆ†ï¼Œç™»å½•å’Œæœªç™»å½•
2. æ‰€æœ‰æ“ä½œéƒ½å°è£…åˆ° `Pinia` ä¸­ï¼Œç»„ä»¶åªéœ€è¦è§¦å‘ `actions` å‡½æ•°
3. åœ¨`actions`ä¸­é€šè¿‡ `member` ä¿¡æ¯å»åŒºåˆ†ç™»å½•çŠ¶æ€
   1. å·²ç™»å½•ï¼Œé€šè¿‡è°ƒç”¨æ¥å£å»æœåŠ¡ç«¯æ“ä½œï¼Œå“åº”æˆåŠŸä¼šé€šè¿‡ `actions` ä¿®æ”¹ `Pinia` ä¸­çš„æ•°æ®å³å¯
   2. æœªç™»å½•æ—¶ï¼Œé€šè¿‡ `actions` ä¿®æ”¹ `Pinia` ä¸­çš„æ•°æ®å³å¯ï¼Œ `Pinia` å®ç°æŒä¹…åŒ–ï¼ŒåŒæ­¥ä¿å­˜åœ¨æœ¬åœ°



## å‡†å¤‡è´­ç‰©è½¦ Store

> æœ¬èŠ‚ç›®æ ‡ï¼šä¸ºè´­ç‰©è½¦ä¸šåŠ¡å®šä¹‰ä¸“å±çš„ Storeï¼Œå¤šä¸ªç»„ä»¶éƒ½è¦ç”¨åˆ°è´­ç‰©è½¦æ•°æ®ã€‚

`Pinia`  åŸºæœ¬ç»“æ„

```jsx
import { defineStore } from "pinia";

const useCartStore = defineStore("cart",{
  // çŠ¶æ€
  state: () => ({
    // è´­ç‰©è½¦åˆ—è¡¨
    list: [],
  }),
  // è®¡ç®—
  getters: {},
  // æ–¹æ³•
  actions: {},
});

export default useCartStore;
```

ğŸ“Œæ³¨æ„ï¼šè®°å¾—åˆ° `src\store\index.ts` åˆå¹¶æ–° `Store`

## æ·»åŠ è´­ç‰©è½¦åŠŸèƒ½å®ç°-å·²ç™»å½•

> æœ¬èŠ‚ç›®æ ‡:   å®Œæˆå•†å“è¯¦æƒ…çš„æ·»åŠ è´­ç‰©è½¦æ“ä½œã€‚

![](./media/03.png)

**å®ç°æ­¥éª¤**

1. `actions` ä¸­å°è£…åŠ å…¥è´­ç‰©è½¦çš„æ¥å£ã€‚
2. åœ¨å•†å“è¯¦æƒ…é¡µå®ç°æ·»åŠ é€»è¾‘è§¦å‘ `actions` å‡½æ•°è°ƒç”¨æ¥å£ã€‚

### æ¥å£ï¼šåŠ å…¥è´­ç‰©è½¦

**æ¥å£åŸºæœ¬ä¿¡æ¯**

**Pathï¼š** /member/cart

**Methodï¼š** POST

**è¯·æ±‚å‚æ•°**

**Body**

| åç§°  | ç±»å‹    | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ | å¤‡æ³¨  | å…¶ä»–ä¿¡æ¯ |
| ----- | ------- | -------- | ------ | ----- | -------- |
| skuId | string  | å¿…é¡»     |        | SKUID |          |
| count | integer | å¿…é¡»     |        | æ•°é‡  |          |

æ–‡ä»¶ï¼š`src\store\modules\cart.ts`

```ts
const useCartStore = defineStore("cart", {
  ...
  // æ–¹æ³•
  actions: {
    // åŠ å…¥è´­ç‰©è½¦
    async addCart(data: { skuId: string; count: number }) {
      const res = await http("POST", "/member/cart", data);
      console.log("POST", "/member/cart", res.data.result);
    },
  },
});

```

### ç‚¹å‡»æŒ‰é’®è°ƒç”¨æ¥å£

åœ¨å•†å“è¯¦æƒ…ç»„ä»¶è°ƒç”¨ `actions` å‡½æ•°åŠ å…¥è´­ç‰©è½¦ã€‚

1. å‡†å¤‡å¥½åŠ å…¥è´­ç‰©è½¦æ¥å£æ‰€éœ€çš„å‚æ•°ï¼š`skuId` å’Œ `count`
2. ç‚¹å‡»æŒ‰é’®ï¼Œè°ƒç”¨æ¥å£ã€‚
2. æ²¡æœ‰ `skuId` éœ€æç¤ºç”¨æˆ·ã€‚

```vue
<script setup lang="ts">

// å•†å“æ•°é‡
const count = ref(1);

// XtxSku ç»„ä»¶é€‰ä¸­çš„å•†å“ä¿¡æ¯
const skuId = ref("");
const changeSku = (value: SkuEmit) => {
  // ğŸ””å­˜å‚¨ skuId ç”¨äºåŠ å…¥è´­ç‰©è½¦
  skuId.value = value.skuId || "";
  // console.log("å½“å‰é€‰æ‹©çš„SKUä¸ºä¿¡æ¯ä¸º", value);
  ...çœç•¥
};

// åŠ å…¥è´­ç‰©æŒ‰é’®ç‚¹å‡»
const { cart } = useStore();
const addCart = () => {
  // æ²¡æœ‰ skuIdï¼Œæé†’ç”¨æˆ·å¹¶é€€å‡ºå‡½æ•°
  if (!skuId.value) {
    return message({ type: "warn", text: "è¯·é€‰æ‹©å®Œæ•´å•†å“è§„åˆ™~" });
  }
  // è°ƒç”¨åŠ å…¥è´­ç‰©è½¦æ¥å£
  cart.addCart({
    skuId: skuId.value,
    count: count.value,
  });
};
</script>

<template>
   ...
          <!-- æŒ‰é’®ç»„ä»¶ -->
          <XtxButton
            @click="addCart"
            size="middle"
            type="primary"
            style="margin-top: 20px"
          >
            åŠ å…¥è´­ç‰©è½¦
          </XtxButton>
   ...
</template>
```



## å¤´éƒ¨è´­ç‰©è½¦å®ç°-å·²ç™»å½•

![](./media/02.png)

### 1. åŸºç¡€å¸ƒå±€

`æœ¬èŠ‚ç›®æ ‡:`  åœ¨ç½‘ç«™å¤´éƒ¨è´­ç‰©è½¦å›¾ç‰‡å¤„ï¼Œé¼ æ ‡ç»è¿‡å±•ç¤ºè´­ç‰©è½¦åˆ—è¡¨

**å®ç°æ­¥éª¤**

1. æå–å¤´éƒ¨è´­ç‰©è½¦ç»„ä»¶ï¼Œå®ŒæˆåŸºç¡€å¸ƒå±€
2. é€šè¿‡ `getters` è¿”å›æœ‰æ•ˆå•†å“æ€»æ•°å’Œæœ‰æ•ˆå•†å“åˆ—è¡¨
3. æ¸²æŸ“å¤´éƒ¨è´­ç‰©è½¦ç»„ä»¶

**ä»£ç è½åœ°**

1ï¼‰æ–°å»ºå¤´éƒ¨è´­ç‰©è½¦ç»„ä»¶

 `src/views/Layout/components/app-header-cart.vue`

```html
<script setup lang="ts">
//
</script>

<template>
  <div class="cart">
    <a class="curr" href="javascript:;">
      <i class="iconfont icon-cart"></i><em>20</em>
    </a>
    <div class="layer">
      <div class="list">
        <div class="item" v-for="i in 4" :key="i">
          <RouterLink to="">
            <img
              src="https://yanxuan-item.nosdn.127.net/ead73130f3dbdb3cabe1c7b0f4fd3d28.png"
              alt=""
            />
            <div class="center">
              <p class="name ellipsis-2">
                å’Œæ‰‹è¶³å¹²è£‚è¯´æ‹œæ‹œ ingramsæ‰‹è¶³çš²è£‚ä¿®å¤éœœ
              </p>
              <p class="attr ellipsis">é¢œè‰²ï¼šä¿®å¤ç»¿ç“¶ å®¹é‡ï¼š150ml</p>
            </div>
            <div class="right">
              <p class="price">&yen;45.00</p>
              <p class="count">x2</p>
            </div>
          </RouterLink>
          <i class="iconfont icon-close-new"></i>
        </div>
      </div>
      <div class="foot">
        <div class="total">
          <p>å…± 3 ä»¶å•†å“</p>
          <p>&yen;135.00</p>
        </div>
        <XtxButton type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.cart {
  width: 50px;
  position: relative;
  z-index: 600;
  .curr {
    height: 32px;
    line-height: 32px;
    text-align: center;
    position: relative;
    display: block;
    .icon-cart {
      font-size: 22px;
    }
    em {
      font-style: normal;
      position: absolute;
      right: 0;
      top: 0;
      padding: 1px 6px;
      line-height: 1;
      background: @helpColor;
      color: #fff;
      font-size: 12px;
      border-radius: 10px;
      font-family: Arial;
    }
  }
  &:hover {
    .layer {
      opacity: 1;
      transform: none;
    }
  }
  .layer {
    opacity: 0;
    transition: all 0.2s 0.1s;
    transform: translateY(-200px) scale(1, 0);
    width: 400px;
    height: 400px;
    position: absolute;
    top: 50px;
    right: 0;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    background: #fff;
    border-radius: 4px;
    padding-top: 10px;
    &::before {
      content: '';
      position: absolute;
      right: 14px;
      top: -10px;
      width: 20px;
      height: 20px;
      background: #fff;
      transform: scale(0.6, 1) rotate(45deg);
      box-shadow: -3px -3px 5px rgba(0, 0, 0, 0.1);
    }
    .foot {
      position: absolute;
      left: 0;
      bottom: 0;
      height: 70px;
      width: 100%;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      background: #f8f8f8;
      align-items: center;
      .total {
        padding-left: 10px;
        color: #999;
        p {
          &:last-child {
            font-size: 18px;
            color: @priceColor;
          }
        }
      }
    }
  }
  .list {
    height: 310px;
    overflow: auto;
    padding: 0 10px;
    &::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    &::-webkit-scrollbar-track {
      background: #f8f8f8;
      border-radius: 2px;
    }
    &::-webkit-scrollbar-thumb {
      background: #eee;
      border-radius: 10px;
    }
    &::-webkit-scrollbar-thumb:hover {
      background: #ccc;
    }
    .item {
      border-bottom: 1px solid #f5f5f5;
      padding: 10px 0;
      position: relative;
      i {
        position: absolute;
        bottom: 38px;
        right: 0;
        opacity: 0;
        color: #666;
        transition: all 0.5s;
      }
      &:hover {
        i {
          opacity: 1;
          cursor: pointer;
        }
      }
      a {
        display: flex;
        align-items: center;
        img {
          height: 80px;
          width: 80px;
        }
        .center {
          padding: 0 10px;
          width: 200px;
          .name {
            font-size: 16px;
          }
          .attr {
            color: #999;
            padding-top: 5px;
          }
        }
        .right {
          width: 100px;
          padding-right: 20px;
          text-align: center;
          .price {
            font-size: 16px;
            color: @priceColor;
          }
          .count {
            color: #999;
            margin-top: 5px;
            font-size: 16px;
          }
        }
      }
    }
  }
}
</style>

```

2ï¼‰headerç»„ä»¶ä½¿ç”¨è´­ç‰©è½¦ç»„ä»¶

 `src/views/Layout/components/header/index.vue`

```diff
<template>
  <header class="app-header">
    <div class="container">
      <h1 class="logo">
        <RouterLink to="/">å°å…”é²œ</RouterLink>
      </h1>
      <AppHeaderNav />
      <div class="search">
        <i class="iconfont icon-search"></i>
        <input type="text" placeholder="æœä¸€æœ" />
      </div>
-      <div class="cart">
-        <a class="curr" href="#">
-          <i class="iconfont icon-cart"></i>
-          <em>2</em>
-        </a>
-      </div>  
+      <!-- è´­ç‰©è½¦ -->
+      <AppHeaderCart />
    </div>
  </header>
</template>
```

### 2. å‡†å¤‡æ•°æ®

#### æ¥å£ï¼šè´­ç‰©è½¦åˆ—è¡¨

**Pathï¼š** /member/cart

**Methodï¼š** GET

è¯·æ±‚å‚æ•°ï¼šæ— 

#### å°è£… `action`

```ts
const useCartStore = defineStore('cart', {
  // ...
  actions: {
    // è·å–è´­ç‰©è½¦åˆ—è¡¨
    async getCartList() {
      // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
      const res = await http('GET', '/member/cart');
      console.log('GET', '/member/cart', res.data.result);
    },
  },
});

```

#### å®šä¹‰TSç±»å‹å£°æ˜æ–‡ä»¶

- æ–°å»ºæ–‡ä»¶ï¼š`src\types\api\cart.d.ts`

```ts
// å•ä¸ªè´­ç‰©è½¦å•†å“
export interface CartItem {
  id: string;
  skuId: string;
  name: string;
  attrsText: string;
  // specs: any[];
  picture: string;
  price: string;
  nowPrice: string;
  nowOriginalPrice: string;
  selected: boolean;
  stock: number;
  count: number;
  isEffective: boolean;
  // discount?: any;
  isCollect: boolean;
  postFee: number;
}

// è´­ç‰©è½¦åˆ—è¡¨
export type CartList = CartItem[];

```

- æ•´åˆå¯¼å‡ºï¼š`src\types\index.d.ts`

```diff
// types æ€»ç®¡ï¼Œç»Ÿä¸€å¯¼å‡ºç±»å‹å£°æ˜
export * from './api/home';
export * from './api/category';
export * from './api/goods';
export * from './api/member';
export * from './api/qq';
+ export * from './api/cart';
```

- æŒ‡å®šç±»å‹  `src\store\modules\cart.ts` ï¼Œå¹¶å®Œå–„åŠ å…¥è´­ç‰©è½¦åï¼Œä¸»åŠ¨è·å–æœåŠ¡å™¨æœ€æ–°åˆ—è¡¨ã€‚

```diff
+ import type { CartList } from '@/types';

const useCartStore = defineStore('cart', {
  // çŠ¶æ€
  state: () => ({
    // è´­ç‰©è½¦åˆ—è¡¨
-    list: [],
+    list: [] as CartList,
  }),
  // æ–¹æ³•
  actions: {
    // åŠ å…¥è´­ç‰©è½¦
    async addCart(data: { skuId: string; count: number }) {
      // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
      const res = await http('POST', '/member/cart', data);
      // æˆåŠŸæç¤º
      message({ type: 'success', text: 'åŠ å…¥è´­ç‰©è½¦æˆåŠŸ' });
+      // åŠ å…¥æˆåŠŸåï¼Œä¸»åŠ¨è·å–æœåŠ¡å™¨æœ€æ–°åˆ—è¡¨
+      this.getCartList();
    },
    // è·å–è´­ç‰©è½¦åˆ—è¡¨
    async getCartList() {
      // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
-      const res = await http('GET', '/member/cart');
+      const res = await http<CartList>('GET', '/member/cart');
+      // ä¿å­˜è´­ç‰©è½¦åˆ—è¡¨æ•°æ®
+      this.list = res.data.result;
    },
  },
});

```

### 3. åˆ—è¡¨æ¸²æŸ“ä¸è®¡ç®—

#### åˆ—è¡¨æ¸²æŸ“

> ğŸš¨æ³¨æ„ï¼š
>
> 1. åˆ—è¡¨æ¸²æŸ“çš„æ—¶å€™ `key` å€¼ç”¨ `skuId`ï¼Œ`RouterLink` è·³è½¬çš„æ—¶å€™ç”¨äº§å“ `id`
> 2. è´­ç‰©è½¦åˆ—è¡¨çš„  `price` ä¸ºåŠ å…¥æ—¶ä»·æ ¼ï¼Œæœ€æ–°ä»·æ ¼æ˜¯ `nowPrice`

```diff
<template>
  <div class="cart">
    <a class="curr" href="javascript:;">
      <i class="iconfont icon-cart"></i><em>2</em>
    </a>
    <div class="layer">
      <div class="list">
+        <div class="item" v-for="item in cart.list" :key="item.skuId">
+          <RouterLink :to="`/product/${item.id}`">
+            <img :src="item.picture" alt="" />
+            <div class="center">
+              <p class="name ellipsis-2">
+                {{ item.name }}
+              </p>
+              <p class="attr ellipsis">{{ item.attrsText }}</p>
+            </div>
+            <div class="right">
+              <p class="price">&yen;{{ item.nowPrice }}</p>
+              <p class="count">x{{ item.count }}</p>
+            </div>
+          </RouterLink>
+          <i class="iconfont icon-close-new"></i>
+        </div>
      </div>
      <div class="foot">
        <div class="total">
          <p>å…± 3 ä»¶å•†å“</p>
          <p>&yen;135.00</p>
        </div>
        <XtxButton type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
      </div>
    </div>
  </div>
</template>
```



#### åˆ—è¡¨è®¡ç®—

è¯´æ˜ï¼š

1. è´­ç‰©è½¦çš„å•†å“å¯èƒ½ä¼šä¸‹æ¶ï¼Œä¸‹æ¶åå°±å˜æˆæ— æ•ˆå•†å“ã€‚
2. å•†å“ä¼šè¢«å…¶ä»–ç”¨æˆ·è´­ä¹°ï¼Œå•†å“åº“å­˜æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ²¡æœ‰åº“å­˜çš„å•†å“ä¹Ÿä¸ºæ— æ•ˆå•†å“ã€‚

> æœ¬èŠ‚ç›®æ ‡:  ä½¿ç”¨  `Pinia`  çš„ `getters` å±æ€§è®¡ç®— æœ‰æ•ˆå•†å“åˆ—è¡¨ï¼Œæœ‰æ•ˆå•†å“æ€»æ•°ï¼Œæœ‰æ•ˆå•†å“æ€»é‡‘é¢ã€‚

1ï¼‰ä½¿ç”¨ `getters` å¾—åˆ°æœ‰æ•ˆå•†å“åˆ—è¡¨ï¼Œæ€»æ•°é‡ï¼Œ æ€»ä»·

```ts
  getters: {
    // è®¡ç®—æœ‰æ•ˆå•†å“åˆ—è¡¨ isEffective = true  filter
    effectiveList(state): CartList {
      return state.list.filter((item) => item.stock > 0 && item.isEffective);
    },
    // æœ‰æ•ˆå•†å“æ€»æ•°é‡ æŠŠeffctiveListä¸­çš„æ¯ä¸€é¡¹çš„countå åŠ èµ·æ¥
    effectiveListCount(): number {
      return this.effectiveList.reduce((sum, item) => sum + item.count, 0);
    },
    // æ€»é’±æ•°  = æ‰€æœ‰å•é¡¹çš„é’±æ•°ç´¯åŠ   å•é¡¹çš„é’±æ•° = æ•°é‡ * å•ä»·
    effectiveListPrice(): string {
      return this.effectiveList
        .reduce((sum, item) => sum + item.count * Number(item.nowPrice), 0)
        .toFixed(2);
    },
  },
```

2ï¼‰æ¸²æŸ“å¤´éƒ¨è´­ç‰©è½¦æ¨¡æ¿

```diff
<template>
  <div class="cart">
    <a class="curr" href="javascript:;">
+      <i class="iconfont icon-cart"></i><em>{{ cart.effectiveListCount }}</em>
    </a>

    <!-- æ˜¾ç¤ºéšè—çš„å¼¹å±‚ -->
    <div class="layer">
      <div class="list">
-        <div class="item" v-for="item in cart.list" :key="item.skuId">
+        <div class="item" v-for="item in cart.effectiveList" :key="item.skuId">
          <RouterLink :to="`/goods/${item.id}`">
            <img :src="item.picture" alt="">
            <div class="center">
              <p class="name ellipsis-2">{{ item.name }}</p>
              <p class="attr ellipsis">{{ item.attrsText }}</p>
            </div>
            <div class="right">
              <p class="price">&yen;{{ item.nowPrice }}</p>
              <p class="count">x{{ item.count }}</p>
            </div>
          </RouterLink>
          <i class="iconfont icon-close-new"></i>
        </div>
      </div>
      <div class="foot">
        <div class="total">
+          <p>å…± {{ cart.effectiveListCount }} ä»¶å•†å“</p>
+          <p>&yen;{{ cart.effectiveListPrice }}</p>
        </div>
        <XtxButton type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
      </div>
    </div>
  </div>
</template>
```



### 4. åˆ é™¤åŠŸèƒ½å®ç°

> æœ¬èŠ‚ç›®æ ‡:  å®ç°å¤´éƒ¨è´­ç‰©è½¦ä¸­çš„åˆ—è¡¨åˆ é™¤åŠŸèƒ½

![](./media/04.png)

#### æ¥å£ï¼šåˆ é™¤/æ¸…ç©ºè´­ç‰©è½¦å•†å“

**åŸºæœ¬ä¿¡æ¯**

**Pathï¼š** /member/cart

**Methodï¼š** DELETE

**è¯·æ±‚å‚æ•°**

**Body**

| åç§° | ç±»å‹      | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ | å¤‡æ³¨       | å…¶ä»–ä¿¡æ¯          |
| ---- | --------- | -------- | ------ | ---------- | ----------------- |
| ids  | string [] | å¿…é¡»     |        | SKUID é›†åˆ | item ç±»å‹: string |

**å®ç°æ­¥éª¤**

1. ç¼–å†™ actions è¿›è¡Œåˆ é™¤æ“ä½œ
2. åœ¨å¤´éƒ¨è´­ç‰©è½¦è¿›è¡Œ action è°ƒç”¨
3. åˆ é™¤è¯·æ±‚å‘é€åï¼Œä¸»åŠ¨è·å–è´­ç‰©è½¦æœ€æ–°åˆ—è¡¨
4. ä¼˜åŒ–ï¼šè´­ç‰©è½¦æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¸éœ€è¦æ¸²æŸ“åˆ—è¡¨

**ä»£ç è½åœ°**

1ï¼‰ Pinia çš„actionsä»£ç  

`src/store/modules/cart.js`

```js

  actions: {
    // åˆ é™¤è´­ç‰©è½¦å•†å“
    async deleteCart(ids: string[]) {
      // å‘é€è¯·æ±‚è®©åç«¯åˆ é™¤å•†å“
      await http("DELETE", "/member/cart", {ids: ids});
      // ğŸ¯ä¸»åŠ¨è·å–æœ€æ–°è´­ç‰©è½¦åˆ—è¡¨
      this.getCartList();
      // æç¤º
      message({ type: 'success', text: 'åˆ é™¤æˆåŠŸ' });
    },
  },
```

3ï¼‰å°ä¼˜åŒ–

> è´­ç‰©è½¦æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œä¸æ˜¾ç¤ºç§»å…¥é¼ æ ‡æ•ˆæœ

```html
<div class="layer" v-if="cart.effectiveList.length > 0">
```



## åˆ—è¡¨è´­ç‰©è½¦å®ç°-å·²ç™»å½•

### 1. è·¯ç”±å’Œç»„ä»¶

> æœ¬èŠ‚ç›®æ ‡ï¼šå®Œæˆè´­ç‰©è½¦ç»„ä»¶åŸºç¡€å¸ƒå±€å’Œè·¯ç”±é…ç½®ä¸è·³è½¬é“¾æ¥ã€‚

![](./media/05.png)

1ï¼‰æ–°å»ºè´­ç‰©è½¦é¡µé¢ç»„ä»¶

 `src/views/Cart/index.vue`

```vue
<script setup lang="ts">
//
</script>

<template>
  <div class="xtx-cart-page">
    <div class="container">
      <XtxBread>
        <XtxBreadItem to="/">é¦–é¡µ</XtxBreadItem>
        <XtxBreadItem>è´­ç‰©è½¦</XtxBreadItem>
      </XtxBread>
      <div class="cart">
        <table>
          <thead>
            <tr>
              <th width="120"><XtxCheckBox>å…¨é€‰</XtxCheckBox></th>
              <th width="400">å•†å“ä¿¡æ¯</th>
              <th width="220">å•ä»·</th>
              <th width="180">æ•°é‡</th>
              <th width="180">å°è®¡</th>
              <th width="140">æ“ä½œ</th>
            </tr>
          </thead>
          <!-- æœ‰æ•ˆå•†å“ -->
          <tbody>
            <tr v-for="i in 3" :key="i">
              <td><XtxCheckBox :model-value="true" /></td>
              <td>
                <div class="goods">
                  <RouterLink to="/">
                    <img
                      src="https://yanxuan-item.nosdn.127.net/13ab302f8f2c954d873f03be36f8fb03.png"
                      alt=""
                    />
                  </RouterLink>
                  <div>
                    <p class="name ellipsis">
                      å’Œæ‰‹è¶³å¹²è£‚è¯´æ‹œæ‹œ ingramsæ‰‹è¶³çš²è£‚ä¿®å¤éœœ
                    </p>
                    <p class="attr">å•†å“è§„æ ¼</p>
                  </div>
                </div>
              </td>
              <td class="tc">
                <p>&yen;200.00</p>
              </td>
              <td class="tc">
                <XtxCount :model-value="1" />
              </td>
              <td class="tc"><p class="f16 red">&yen;200.00</p></td>
              <td class="tc">
                <p><a href="javascript:;">ç§»å…¥æ”¶è—å¤¹</a></p>
                <p><a class="green" href="javascript:;">åˆ é™¤</a></p>
                <p><a href="javascript:;">æ‰¾ç›¸ä¼¼</a></p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- æ“ä½œæ  -->
      <div class="action">
        <div class="batch"></div>
        <div class="total">
          å…± 7 ä»¶æœ‰æ•ˆå•†å“ï¼Œå·²é€‰æ‹© 2 ä»¶ï¼Œå•†å“åˆè®¡ï¼š
          <span class="red">Â¥400</span>
          <XtxButton type="primary">ä¸‹å•ç»“ç®—</XtxButton>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
.tc {
  text-align: center;
  .xtx-numbox {
    margin: 0 auto;
    width: 120px;
  }
}
.red {
  color: @priceColor;
}
.green {
  color: @xtxColor;
}
.f16 {
  font-size: 16px;
}
.goods {
  display: flex;
  align-items: center;
  img {
    width: 100px;
    height: 100px;
  }
  > div {
    width: 280px;
    font-size: 16px;
    padding-left: 10px;
    .attr {
      font-size: 14px;
      color: #999;
    }
  }
}
.action {
  display: flex;
  background: #fff;
  margin-top: 20px;
  height: 80px;
  align-items: center;
  font-size: 16px;
  justify-content: space-between;
  padding: 0 30px;
  .xtx-checkbox {
    color: #999;
  }
  .batch {
    a {
      margin-left: 20px;
    }
  }
  .red {
    font-size: 18px;
    margin-right: 20px;
    font-weight: bold;
  }
}
.tit {
  color: #666;
  font-size: 16px;
  font-weight: normal;
  line-height: 50px;
}
.xtx-cart-page {
  .cart {
    background: #fff;
    color: #666;
    table {
      border-spacing: 0;
      border-collapse: collapse;
      line-height: 24px;
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #f5f5f5;
        &:first-child {
          text-align: left;
          padding-left: 30px;
          color: #999;
        }
      }
      th {
        font-size: 16px;
        font-weight: normal;
        line-height: 50px;
      }
    }
  }
}
</style>

```

2ï¼‰å‡†å¤‡è·¯ç”±

```jsx
{
  path: '/cart',
  component: () => import('@/views/Cart/index.vue')
}
```

3)  ç‚¹å‡»è´­ç‰©è½¦æŒ‰é’®è·³è½¬

```jsx
<RouterLink to="/cart" class="curr">
  <i class="iconfont icon-cart"></i><em>{{ cart.effectiveListCount }}</em>
</RouterLink>


<XtxButton @click="$router.push('/cart')" type="plain">å»è´­ç‰©è½¦ç»“ç®—</XtxButton>
```



### 2.åˆ—è¡¨æ•°æ®å±•ç¤º

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°è´­ç‰©è½¦å•†å“åˆ—è¡¨å±•ç¤ºåŠŸèƒ½

1) æ¸²æŸ“æœ‰æ•ˆå•†å“

- æœ€æ–°ä»·æ ¼æ˜¯ `nowPrice`
- è®¡æ•°å™¨éœ€è¦è®¾ç½®æœ€å¤§åº“å­˜å€¼ `max`
- ä»·æ ¼å°è®¡éœ€è¦ `toFixed(2)` ä¿ç•™ä¸¤ä½å°æ•°

```html
<!-- æœ‰æ•ˆå•†å“ -->
<tbody>
  <tr v-for="goods in cart.effectiveList" :key="goods.skuId">
    <td><XtxCheckBox :model-value="goods.selected" /></td>
    <td>
      <div class="goods">
        <RouterLink :to="`/product/${goods.id}`">
          <img :src="goods.picture" :alt="goods.name" />
        </RouterLink>
        <div>
          <p class="name ellipsis">{{ goods.name }}</p>
          <p class="attr">{{ goods.attrsText }}</p>
        </div>
      </div>
    </td>
    <td class="tc">
      <p>&yen;{{ goods.nowPrice }}</p>
    </td>
    <td class="tc">
      <XtxCount :model-value="goods.count" :max="goods.stock" />
    </td>
    <td class="tc">
      <p class="f16 red">
        &yen;{{ (Number(goods.nowPrice) * goods.count).toFixed(2) }}
      </p>
    </td>
    <td class="tc">
      <p><a class="green" href="javascript:;">åˆ é™¤</a></p>
    </td>
  </tr>
</tbody>
```

### 3. åˆ é™¤æ“ä½œå®ç°

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°å•†å“åˆ é™¤åŠŸèƒ½

**æ€è·¯åˆ†æ**

1. ç‚¹å‡»åˆ é™¤æŒ‰é’®è®°å½•å½“å‰ç‚¹å‡»çš„å•†å“ `skuId`
2. è°ƒç”¨ action å‡½æ•°å®ç°åˆ é™¤å³å¯ã€‚

**ä»£ç è½åœ°**

> åˆ é™¤æŒ‰é’®ç»‘å®šäº‹ä»¶è§¦å‘åˆ é™¤actionå‡½æ•°

```jsx
<td class="tc">
  <p><a @click="cart.deleteCart([goods.skuId])" class="green" href="javascript:;">åˆ é™¤</a></p>
</td>
```

åˆ é™¤å…‰è´­ç‰©è½¦ä¹‹åä½¿ç”¨å…ƒç´ å ä½

```html
<!-- åˆ é™¤å…‰è´­ç‰©è½¦ä¹‹åä½¿ç”¨å…ƒç´ å ä½ -->
<tr>
  <td colspan="6">
    <div class="cart-none" style="text-align: center">
      <img src="@/assets/images/none.png" alt="" />
      <p>è´­ç‰©è½¦å†…æš‚æ—¶æ²¡æœ‰å•†å“</p>
      <div class="btn" style="margin: 20px">
        <XtxButton type="primary">
          ç»§ç»­é€›é€›
        </XtxButton>
      </div>
    </div>
  </td>
</tr>
```



### 4. å•é€‰æ“ä½œå®ç°ğŸš¨

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°çš„å•†å“å•é€‰åŠŸèƒ½
>
> ä»å•é€‰å¼€å§‹ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°ä¸€ä¸ª `Pinia`  + è¡¨å•æ•°æ®çš„äº¤äº’åŠŸèƒ½å®ç°ï¼Œè¿™é‡Œé¢æœ‰äº›å°å‘ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹

![](./media/06.png)

**æ€è·¯åˆ†æ**

1. é€šè¿‡åˆ‡æ¢é€‰æ‹©æ¡†ç»„ä»¶è·å¾—å½“å‰çš„æœ€æ–°çŠ¶æ€
2. è·å–ç‚¹å‡»å•é€‰æ¡†çš„å•†å“ `skuId`
3. è·å–ç‚¹å‡»å•é€‰æ¡†çš„`selected`çš„æœ€æ–°çŠ¶æ€



#### æ¥å£ï¼šä¿®æ”¹è´­ç‰©è½¦å•†å“

**Pathï¼š** /member/cart/:id

**Methodï¼š** PUT

**è¯·æ±‚å‚æ•°**

**è·¯å¾„å‚æ•°**

| å‚æ•°åç§° | ç¤ºä¾‹ | å¤‡æ³¨  |
| -------- | ---- | ----- |
| id       |      | SKUID |

**Body**

| åç§°     | ç±»å‹    | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ | å¤‡æ³¨     | å…¶ä»–ä¿¡æ¯ |
| -------- | ------- | -------- | ------ | -------- | -------- |
| selected | boolean | éå¿…é¡»   |        | æ˜¯å¦é€‰ä¸­ |          |
| count    | integer | éå¿…é¡»   |        | æ•°é‡     |          |

**ä»£ç è½åœ°**

1ï¼‰å®šä¹‰ `Pinia` ä¸­æ“ä½œ selected çš„ action å‡½æ•°

```ts

const useCartStore = defineStore('cart', {
  // æ–¹æ³•
  actions: {
    // ä¿®æ”¹è´­ç‰©è½¦å•†å“(æ˜¯å¦é€‰ä¸­,å•†å“æ•°é‡)
    async updateCart( skuId: string,data: { selected?: boolean; count?: number } ) {
      // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
      const res = await http('PUT', `/member/cart/${skuId}`, data);
      // ä¸»åŠ¨è·å–æœ€æ–°åˆ—è¡¨
      this.getCartList();
    },
  },
});

```

2ï¼‰è·å–åˆ°å½“å‰é€‰æ‹©æ¡†çš„æœ€æ–°çŠ¶æ€

```tsx
<XtxCheckBox
  :model-value="item.selected"
  @update:model-value="cart.updateCart(item.skuId, { selected: $event })"
/>
```



### 5. ä¿®æ”¹æ•°é‡å®ç°

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°å•†å“æ•°é‡ä¿®æ”¹åŠŸèƒ½

**æ€è·¯åˆ†æ**

1. å‚è€ƒå•é€‰æ“ä½œå®ç°ã€‚
2. ğŸ””æ¸©é¦¨æé†’ï¼šXtxUI ç»„ä»¶åº“ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼Œæä¾›ä¸¤ç§è‡ªå®šä¹‰äº‹ä»¶è·å–å€¼ @update:model-value å’Œ @change åŠŸèƒ½æ˜¯ç­‰ä»·çš„ã€‚

**ä»£ç è½åœ°**

2ï¼‰ç»‘å®šäº‹ä»¶è§¦å‘ action

```tsx
<td class="tc">
  <XtxCount
    :max="goods.stock"
    :model-value="goods.count"
    @change="cart.updateCart(item.skuId, { count: $event })"
  />
</td>
```

### 6. å…¨é€‰åˆ‡æ¢å®ç°ğŸš¨ğŸš¨

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°å•†å“å…¨é€‰åˆ‡æ¢åŠŸèƒ½ã€‚

#### æ¥å£ï¼šè´­ç‰©è½¦å…¨é€‰/å–æ¶ˆå…¨é€‰

**Pathï¼š** /member/cart/selected

**Methodï¼š** PUT

**æ¥å£æè¿°ï¼š**

idså‚æ•°å¦‚æœä¸ä¼ ï¼Œè¡¨ç¤ºç”¨æˆ·è®¿é—®çš„æ˜¯å…¨é€‰å’Œå–æ¶ˆå…¨é€‰æ“ä½œï¼Œåç«¯æ ¹æ® selected ç¡®å®šç”¨æˆ·æ˜¯å…¨é€‰å’Œå–æ¶ˆå…¨é€‰

**è¯·æ±‚å‚æ•°**

**Body**

| åç§°     | ç±»å‹      | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ | å¤‡æ³¨      | å…¶ä»–ä¿¡æ¯          |
| -------- | --------- | -------- | ------ | --------- | ----------------- |
| selected | boolean   | å¿…é¡»     |        | æ˜¯å¦é€‰ä¸­  |                   |
| ids      | string [] | éå¿…é¡»   |        | skuIdé›†åˆ | item ç±»å‹: string |
| â”œâ”€       |           | éå¿…é¡»   |        | skuId     |                   |

**æ€è·¯åˆ†æ**

1. é€šè¿‡ `getters` è®¡ç®—å‡ºé€‰ä¸­çŠ¶æ€ ï¼ˆæ³¨æ„ï¼š `Pinia` çš„ `getters` æ²¡æœ‰ `set` ï¼‰
2. å°è£…è°ƒç”¨ä¿®æ”¹å…¨é€‰æ¥å£çš„ `actions` ã€‚
3. å®ç°å…¨é€‰æ•ˆæœã€‚ğŸš¨ğŸš¨
   1. æ–¹æ¡ˆ1ï¼š`:model-value` å’Œ `@update:model-value` ç»„åˆã€‚
   2. æ–¹æ¡ˆ2ï¼š `v-model` å’Œ `computed` ç»„åˆã€‚

**ä»£ç è½åœ°**

1ï¼‰åœ¨ `src\store\modules\cart.ts` ä¸­å°è£… `actions`  å’Œ `getters` ã€‚

```jsx
const useCartStore = defineStore("cart", {
  // è®¡ç®—
  getters: {
    ...
    // è®¡ç®—å…¨é€‰çŠ¶æ€
    isAllSelected(): boolean {
      return (
        this.effectiveList.length > 0 &&
        this.effectiveList.every((v) => v.selected)
      );
    },
  },
  // æ–¹æ³•
  actions: {
    ...
    // è´­ç‰©è½¦å…¨é€‰/å–æ¶ˆå…¨é€‰
    async updateCartAllSelected(data: { selected: boolean; ids?: string[] }) {
      // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
      const res = await http("PUT", "/member/cart/selected", data);
      // è·å–è´­ç‰©è½¦åˆ—è¡¨
      this.getCartList();
    },
  },
});

```

2ï¼‰é¡µé¢ä¸­è°ƒç”¨

```vue
  <XtxCheckBox
    :model-value="cart.isAllSelected"
    @update:model-value="cart.updateCartAllSelected({ selected: $event })"
  >
    å…¨é€‰
  </XtxCheckBox>
```

### 7. æ“ä½œæ æ•°æ®è®¡ç®—å’Œæ¸²æŸ“

![image-20210819135539000](./media/image-20210819135539000.png)

```jsx
// å·²é€‰æ‹©çš„åˆ—è¡¨
selectedList ():CartList {
  return this.effectiveList.filter(item => item.selected)
},
// å·²é€‰æ‹©çš„å•†å“æ€»æ•°
selectedListCount ():number {
  return this.selectedList.reduce((sum, item) => sum + item.count, 0)
},
// å·²é€‰æ‹©çš„åˆ—è¡¨æ€»ä»·
selectedListPrice ():string {
  return this.selectedList.reduce((sum, item) => sum + item.count * Number(item.nowPrice), 0).toFixed(2)
}
```

```vue
<!-- æ“ä½œæ  -->
<div class="action">
  <div class="total">
    å…± {{ cart.effectiveListCount }} ä»¶æœ‰æ•ˆå•†å“ï¼Œå·²é€‰æ‹© {{ cart.selectedListCount }} ä»¶ï¼Œæœ‰æ•ˆå•†å“åˆè®¡ï¼š
    <span class="red">Â¥{{ cart.selectedListPrice }}</span>
    <XtxButton type="primary">ä¸‹å•ç»“ç®—</XtxButton>
  </div>
</div>
```



## ã€è½¬æŠ˜ç‚¹ã€‘é€€å‡ºç™»å½•

> `æœ¬èŠ‚ç›®æ ‡:`  é€€å‡ºç™»å½•ï¼Œä¸ºå®ç°æœªç™»å½•ç‰ˆè´­ç‰©è½¦åšå‡†å¤‡ã€‚

![](./media/01.png)

### é—®é¢˜æ€è€ƒ

- æ€è€ƒ1ï¼šé€€å‡ºç™»å½•åï¼Œç›´æ¥è°ƒç”¨è´­ç‰©è½¦ç³»åˆ—æ¥å£ä¼šæŠ¥é”™ï¼Œæ€ä¹ˆåŠï¼Ÿ
  - è°ƒç”¨æ¥å£å‰ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç™»å½•ã€‚
- æ€è€ƒ2ï¼šé€€å‡ºç™»å½•åï¼Œä¸ºä»€ä¹ˆè¿˜èƒ½çœ‹åˆ°è´­ç‰©è½¦æ•°æ®ï¼Œè¦æ€ä¹ˆå¤„ç†ï¼Ÿ
  - æ•°æ®å­˜å‚¨åˆ° `Pinia` ä¸­ï¼Œé€€å‡ºç™»å½•åè¦æ¸…ç©ºè´­ç‰©è½¦åˆ—è¡¨ã€‚

- æ€è€ƒ3ï¼šå¦‚ä½•åˆ¤æ–­ç”¨æˆ·ç™»å½•è¿˜æ˜¯æœªç™»å½•ï¼Œè¦å¦‚ä½•å¤„ç†ï¼Ÿï¼Ÿ
  - è·å– `member` æ¨¡å—çš„ `æ˜¯å¦æœ‰ token` å³å¯ã€‚
- æ€è€ƒ4ï¼šæ ¹æ®ä¸Šé¢éœ€æ±‚ï¼Œè¯¥å¦‚ä½•è®¾è®¡ç¨‹åºï¼Ÿ
  - ç»™æ“ä½œè´­ç‰©è½¦æ•°æ®çš„ `actions` å†…éƒ¨éƒ½æ·»åŠ åˆ¤æ–­ï¼Œå·²ç™»å½•è°ƒç”¨æ¥å£ï¼Œæœªç™»å½•æœ¬åœ°æ“ä½œã€‚

### é€€å‡ºç™»å½•æ¸…ç©ºè´­ç‰©è½¦

è´­ç‰©è½¦æ¨¡å—ï¼š`src\store\modules\cart.ts`

```diff
const useCartStore = defineStore("cart", {
  // æ–¹æ³•
  actions: {
    ...
+    // æ¸…ç©ºè´­ç‰©è½¦
+    clearCart() {
+      // é€€å‡ºç™»å½•éœ€æ¸…ç©ºè´­ç‰©è½¦
+      this.list = [];
+    },
  },
});
```

ä¼šå‘˜ä¸­å¿ƒæ¨¡å—ï¼š`src\store\modules\member.ts`

```diff
const useMemberStore = defineStore("member",{
  ...
  actions: {
    ...
    // é€€å‡ºç™»å½•
    async logout() {
      this.profile = {} as Profile;
      clearStorageProfile();
      router.push("/login");
+      // é€€å‡ºç™»å½•-ä¸»åŠ¨æ¸…ç©ºè´­ç‰©è½¦æ•°æ®
+      const { cart } = useStore();
+      cart.clearCart();
    },
  },
});
```

### å·²ç™»å½•å’Œæœªç™»å½•ç¨‹åºè®¾è®¡


```diff
const useCartStore = defineStore("cart",{
  ...
  // è®¡ç®—
  getters: {
+    // ğŸ”‘ç™»å½•çŠ¶æ€ï¼Œè´­ç‰©è½¦æ¨¡å—ç¼“å­˜ member.isLogin ç™»å½•çŠ¶æ€
+    isMemberLogin(): boolean {
+      const { member } = useStore();
+      return member.isLogin;
+    },
    ...
  },
  // æ–¹æ³•
  actions: {
    // åŠ å…¥è´­ç‰©è½¦
    async addCart(data: CartItem) {
+      // ğŸš¨åˆ¤æ–­ç™»å½•çŠ¶æ€
+      if (this.isMemberLogin) {
+        // 1ï¸âƒ£å·²ç™»å½•æƒ…å†µ - è°ƒç”¨æ¥å£
          const { skuId, count } = data;
          const res = await http("POST", "/member/cart", { skuId, count });
          this.getCartList();
+      } else {
+        // 2ï¸âƒ£æœªç™»å½•æƒ…å†µ - æ“ä½œæœ¬åœ°æ•°æ®(ç›¸å½“äºé«˜çº§ç‰ˆtodos)
+      }
      message({ type: "success", text: "æ·»åŠ æˆåŠŸ~" });
    }
    ...
  },
});

export default useCartStore;

```

é€€å‡ºç™»å½•è¿˜éœ€è¦æ¸…ç©º `Pinia` ä¸­çš„è´­ç‰©è½¦æ•°æ®ã€‚

## è´­ç‰©è½¦æ“ä½œ-æœªç™»å½•

### 1. åŠ å…¥è´­ç‰©è½¦ğŸš¨ğŸš¨ğŸš¨

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°åŠ å…¥è´­ç‰©è½¦ä¸šåŠ¡ã€‚

**å®ç°æ­¥éª¤**

1. ç‚¹å‡»åŠ å…¥è´­ç‰©è½¦çš„æ—¶å€™ï¼Œä»å•†å“è¯¦æƒ…ä¸­æ”¶é›†è´­ç‰©è½¦å•†å“å±•ç¤ºæ‰€éœ€æ•°æ®ã€‚ï¼ˆğŸš¨ğŸš¨å­—æ®µå¾ˆå¤šï¼Œæ“ä½œå°å¿ƒï¼‰
2. actions ä¸­å®Œæˆæ·»åŠ æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**è½åœ°ä»£ç **

å•†å“è¯¦æƒ…é¡µï¼š`src\views\Goods\index.vue`

```vue
<script setup lang="ts">
...
// é€‰ä¸­çš„å•†å“è§„æ ¼æ–‡æœ¬
const attrsText = ref("");
// åŠ å…¥è´­ç‰©æŒ‰é’®ç‚¹å‡»
const addCart = () => {
  // æ²¡æœ‰ skuIdï¼Œæé†’ç”¨æˆ·å¹¶é€€å‡ºå‡½æ•°
  if (!skuId.value) {
    return message({ type: "warn", text: "è¯·é€‰æ‹©å®Œæ•´å•†å“è§„åˆ™~" });
  }

  // ğŸš¨ğŸš¨ é«˜çº§ç‰ˆtodosè€Œå·²ï¼Œä½†æ˜¯æ•°æ®æ”¶é›†å­—æ®µåå¾ˆå¤šå‘ï¼Œå°å¿ƒæ“ä½œï¼Œå®¹æ˜“å‡ºé”™
  if (!goods.value) return;
  const cartItem = {
    // ç¬¬ä¸€éƒ¨åˆ†ï¼šå•†å“è¯¦æƒ…ä¸­æœ‰çš„
    id: goods.value.id, // å•†å“id
    name: goods.value.name, // å•†å“åç§°
    picture: goods.value.mainPictures[0], // å›¾ç‰‡
    price: goods.value.oldPrice, // æ—§ä»·æ ¼
    nowPrice: goods.value.price, // æ–°ä»·æ ¼
    stock: goods.value.inventory, // åº“å­˜
    // ç¬¬äºŒéƒ¨åˆ†ï¼šå•†å“è¯¦æƒ…ä¸­æ²¡æœ‰çš„ï¼Œè‡ªå·±é€šè¿‡å“åº”å¼æ•°æ®æ”¶é›†
    count: count.value, // å•†å“æ•°é‡
    skuId: skuId.value, // skuId
    attrsText: attrsText.value, // å•†å“è§„æ ¼æ–‡æœ¬
    // ç¬¬ä¸‰éƒ¨åˆ†ï¼šè®¾ç½®é»˜è®¤å€¼å³å¯
    selected: true, // é»˜è®¤å•†å“é€‰ä¸­
    isEffective: true, // é»˜è®¤å•†å“æœ‰æ•ˆ
  } as CartItem;  // ğŸ“Œ as æ–­è¨€é˜²æ­¢ç±»å‹æŠ¥é”™
 
  console.log('ğŸ“ŒcartItem æ•°æ®ç»ˆäºå‡†å¤‡å®Œæ¯•äº†', cartItem);

  // è°ƒç”¨åŠ å…¥è´­ç‰©è½¦æ¥å£
  cart.addCart(cartItem);
};
</script>
```

è´­ç‰©è½¦æ¨¡å—ï¼š`src/store/modules/cart.js`

```jsx
actions: {
  // åŠ å…¥è´­ç‰©è½¦
  async addCart(data: CartItem) {
    // è§£æ„å‡ºæ¥å£æ‰€éœ€å‚æ•°
    const { skuId, count } = data;
    if (this.isMemberLogin) {
      // å·²ç™»å½•æƒ…å†µ - è°ƒç”¨æ¥å£
      const res = await http("POST", "/member/cart", { skuId, count });
      this.getCartList();
    } else {
      // æœªç™»å½•æƒ…å†µ - æ“ä½œæœ¬åœ°æ•°æ®(ç›¸å½“äºé«˜çº§ç‰ˆtodos)
      // æ·»åŠ å•†å“åˆ†ä¸¤ç§æƒ…å†µï¼š
      const cartItem = this.list.find((item) => item.skuId === skuId);
      if (cartItem) {
        // æƒ…å†µ1ï¼šå·²æ·»åŠ è¿‡çš„çš„å•†å“ï¼Œç´¯åŠ æ•°é‡å³å¯
        cartItem.count += count;
      } else {
        // æƒ…å†µ2ï¼šæ–°æ·»åŠ çš„å•†å“ï¼Œå‰æ·»åŠ åˆ°æ•°ç»„ä¸­
        this.list.unshift(data);
      }
    }
    message({ type: "success", text: "æ·»åŠ æˆåŠŸ~" });
  },
}
```



### 2. åˆ é™¤è´­ç‰©è½¦

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°åˆ é™¤æ“ä½œã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆåˆ é™¤æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**è½åœ°ä»£ç **

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.js`

```diff
actions: {    
    // åˆ é™¤è´­ç‰©è½¦å•†å“
    async deleteCart(data: { ids: string[] }) {
      // æ˜¯å¦ç™»å½•ä¸¤ç§æƒ…å†µ
      if (this.isMemberLogin) {
        // å·²ç™»å½•ï¼Œè°ƒç”¨æ¥å£
        const res = await http('DELETE', '/member/cart', data);
        console.log('DELETE', '/member/cart', res.data.result);
        // ä¸»åŠ¨è·å–æœ€æ–°åˆ—è¡¨
        this.getCartList();
        // æˆåŠŸæç¤º
        message({ type: 'success', text: 'åˆ é™¤æˆåŠŸ' });
      } else {
        // æœªç™»å½•ï¼Œæ“ä½œæœ¬åœ°æ•°æ®(ç›¸å½“äºé«˜çº§ç‰ˆtodos)
+        this.list = this.list.filter((v) => !data.ids.includes(v.skuId));
      }
    },
}
```

### 3. è´­ç‰©è½¦åˆ—è¡¨æŒä¹…åŒ–å­˜å‚¨

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç° `Pinia` è´­ç‰©è½¦åˆ—è¡¨çš„æŒä¹…åŒ–å­˜å‚¨ã€‚

**å®ç°æ­¥éª¤**

- å‰é¢æˆ‘ä»¬å·²ç»å®‰è£…äº† `Pinia` æŒä¹…åŒ–å­˜å‚¨æ’ä»¶ï¼Œåœ¨æ¨¡å—ä¸­å¼€å¯æ’ä»¶åŠŸèƒ½å³å¯ã€‚

**ä»£ç è½åœ°**

`src/store/modules/cart.js`

```diff
const useCartStore = defineStore("cart", {
+  // ğŸ””è´­ç‰©è½¦å¼€å¯æŒä¹…åŒ–
+  persist: true,
  ...
});
```

æ­¥éª¤éªŒè¯ï¼šå¼€å¯æŒä¹…åŒ–è®¾ç½®åï¼Œæ‰“å¼€æµè§ˆå™¨æœ¬åœ°å­˜å‚¨é¢æ¿æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆã€‚



### 4. é€‰ä¸­çŠ¶æ€åˆ‡æ¢&ä¿®æ”¹æ•°é‡

> `æœ¬èŠ‚ç›®æ ‡:`  å®ç°å•†å“é€‰ä¸­çŠ¶æ€çš„åˆ‡æ¢å’Œä¿®æ”¹å•†å“æ•°é‡ã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆä¿®æ”¹æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚
- æ³¨æ„ç‚¹ï¼šç”±äºä¿®æ”¹æ•°é‡å’Œä¿®æ”¹é€‰æ‹©çŠ¶æ€éƒ½æ˜¯åŒä¸€ä¸ª action å®Œæˆï¼Œæ‰€ä»¥æœ¬åœ°ä¿®æ”¹å‰éœ€è¦åˆ¤æ–­ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.js`

```diff
actions: { 
    // ä¿®æ”¹è´­ç‰©è½¦å•†å“-ä¿®æ”¹é€‰ä¸­-ä¿®æ”¹æ•°é‡
    async updateCart( skuId: string,data: { selected?: boolean; count?: number } ) {
      if (this.isMemberLogin) {
        // å·²ç™»å½•æƒ…å†µ - è°ƒç”¨æ¥å£
        await http("PUT", `/member/cart/${skuId}`, data);
        this.getCartList();
      } else {
        // æœªç™»å½•æƒ…å†µ - æ“ä½œæœ¬åœ°æ•°æ®(ç›¸å½“äºé«˜çº§ç‰ˆtodos)
+        // æ ¹æ® skuId æŸ¥æ‰¾å¾…ä¿®æ”¹çš„å•†å“é¡¹
+        const cartItem = this.list.find((v) => v.skuId === skuId);
+        // å¦‚æœèƒ½æŸ¥æ‰¾åˆ°
+        if (cartItem) {
+          // è§£æ„å‡ºéœ€è¦ä¿®æ”¹çš„å­—æ®µ
+          const { selected, count } = data;
+          // ç”±äºä¿®æ”¹æ•°é‡å’Œä¿®æ”¹é€‰æ‹©çŠ¶æ€éƒ½æ˜¯åŒä¸€ä¸ª action å®Œæˆï¼Œæ‰€ä»¥æœ¬åœ°ä¿®æ”¹å‰éœ€è¦åˆ¤æ–­
+          if (count !== undefined) cartItem.count = count;
+          if (selected !== undefined) cartItem.selected = selected;
+        }
      }
    },
}
```



### 5. å…¨é€‰åˆ‡æ¢-æœ¬åœ°

>  `æœ¬èŠ‚ç›®æ ‡:`  å®ç°å•†å“é€‰ä¸­çŠ¶æ€çš„åˆ‡æ¢ã€‚

**å®ç°æ­¥éª¤**

- actions ä¸­å®Œæˆå…¨é€‰åˆ‡æ¢æ“ä½œï¼ˆæœªç™»å½•ï¼‰ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.js`

```diff
actions: { 
    // è´­ç‰©è½¦å…¨é€‰/å–æ¶ˆå…¨é€‰
    async updateCartAllSelected(data: { selected: boolean; ids?: string[] }) {
      if (this.isMemberLogin) {
        // å·²ç™»å½•æƒ…å†µ - è°ƒç”¨æ¥å£
        await http("PUT", "/member/cart/selected", data);
        this.getCartList();
      } else {
        // æœªç™»å½•æƒ…å†µ - æ“ä½œæœ¬åœ°æ•°æ®(ç›¸å½“äºé«˜çº§ç‰ˆtodos)
+        this.list.forEach((item) => {
+          item.selected = data.selected;
+        });
      }
    },
}
```



### 6. æ›´æ–°æœ¬åœ°è´­ç‰©è½¦å•†å“å…³é”®ä¿¡æ¯ğŸš¨ğŸš¨

> **æœ¬èŠ‚ç›®æ ‡ï¼š** æœªç™»å½•æƒ…å†µä¸‹ï¼Œæ›´æ–°æœ¬åœ°è´­ç‰©è½¦å•†å“å…³é”®ä¿¡æ¯ã€‚
>
> åŸå› è§£é‡Šï¼šæœ¬åœ°å­˜å‚¨çš„åº“å­˜ä¿¡æ¯å’Œä»·æ ¼**ä¸æ˜¯æœåŠ¡å™¨æœ€æ–°çš„**ï¼Œæ‰€ä»¥éœ€**è¦ä¸»åŠ¨æ›´æ–°**æœ€æ–°å•†å“å…³é”®ä¿¡æ¯ã€‚
>
> å…³é”®ä¿¡æ¯ä¸»è¦åŒ…æ‹¬ï¼šå•†å“æœ€æ–°ä»·æ ¼ï¼Œå•†å“æœ€æ–°åº“å­˜ï¼Œå•†å“æ˜¯å¦è¿˜æœ‰æ•ˆã€‚

#### æ¥å£ï¼šæŸ¥è¯¢å•†å“åº“å­˜ä»·æ ¼ä¿¡æ¯

**Pathï¼š** /goods/stock/:id

**Methodï¼š** GET

**è¯·æ±‚å‚æ•°**

**è·¯å¾„å‚æ•°**

| å‚æ•°åç§° | ç¤ºä¾‹                | å¤‡æ³¨   |
| -------- | ------------------- | ------ |
| id       | 1352956998412406785 | SKU_ID |

**å®ç°æ€è·¯**

1. è·å–è´­ç‰©è½¦åˆ—è¡¨çš„ action ä¸­ï¼Œ**æœªç™»å½•æƒ…å†µ** ä¸‹ä¸»åŠ¨è·å–å•†å“åº“å­˜ä»·æ ¼ã€‚
1. è´­ç‰©è½¦çš„å•†å“åº“å­˜ï¼Œä»·æ ¼ï¼Œæ˜¯å¦æœ‰æ•ˆï¼Œæ›´æ–°æˆæœ€æ–°çš„ã€‚

**ä»£ç è½åœ°**

å®Œå–„ä¸šåŠ¡ï¼š`src/store/modules/cart.js`

```diff
actions: { 
    // è·å–è´­ç‰©è½¦åˆ—è¡¨
    async getCartList() {
      if (this.isMemberLogin) {
        // å·²ç™»å½•æƒ…å†µ - è°ƒç”¨æ¥å£
        const res = await http<CartList>("GET", "/member/cart");
        this.list = res.data.result;
      } else {
+        // ğŸš¨æœªç™»å½•æƒ…å†µï¼Œé¦–æ¬¡æ‰“å¼€æ—¶éœ€æŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡¨å•†å“æœ€æ–°ä»·æ ¼ï¼Œåº“å­˜ï¼Œæ˜¯å¦æœ‰æ•ˆ
+        this.list.forEach(async (item) => {
+          // æ ¹æ® skuId è·å–æœ€æ–°å•†å“ä¿¡æ¯
+          const res = await http<CartItem>("GET", `/goods/stock/${item.skuId}`);
+          // ä¿å­˜æœ€æ–°å•†å“ä¿¡æ¯
+          const newCartItemInfo = res.data.result;
+          // æ›´æ–°å•†å“ç°ä»·
+          item.nowPrice = newCartItemInfo.nowPrice;
+          // æ›´æ–°å•†å“åº“å­˜
+          item.stock = newCartItemInfo.stock;
+          // æ›´æ–°å•†å“æ˜¯å¦æœ‰æ•ˆ
+          item.isEffective = newCartItemInfo.isEffective;
+        });
      }
    },
}
```



## ä¸¤ä¸ªç‰ˆæœ¬è´­ç‰©è½¦åŒæ­¥

### 1. ç™»å½•ååˆå¹¶è´­ç‰©è½¦ğŸš¨ğŸš¨

`æœ¬èŠ‚ç›®æ ‡:`  ç™»å½•åæŠŠæœ¬åœ°çš„è´­ç‰©è½¦æ•°æ®åˆå¹¶åˆ°åç«¯æœåŠ¡

> æœ¬åœ°å·²ç»å­˜å¥½çš„æ‰€æœ‰è´­ç‰©è½¦åˆ—è¡¨æ•°æ®éƒ½éœ€è¦å’ŒæœåŠ¡å™¨åˆå¹¶ä¸€ä¸‹ã€‚

**å®ç°æ€è·¯**

1. ç¼–å†™å¹¶è°ƒç”¨  åˆå¹¶è´­ç‰©è½¦çš„ `action` å‡½æ•° ï¼ˆå°†å¯¹äºè´­ç‰©è½¦çš„å¤„ç†ï¼Œç»Ÿä¸€åˆ° `Pinia` ä¸­ï¼‰

   æ€è€ƒï¼šåœ¨å“ªè°ƒç”¨ åˆå¹¶è´­ç‰©è½¦çš„ `action` å‡½æ•°ï¼Ÿ

   ç­”ï¼šç™»å½•å®Œæˆåã€‚

### æ¥å£ï¼šåˆå¹¶è´­ç‰©è½¦

**åŸºæœ¬ä¿¡æ¯**

**Pathï¼š** /member/cart/merge

**Methodï¼š** POST

è¯·æ±‚å‚æ•°

**Body**

| åç§°        | ç±»å‹      | æ˜¯å¦å¿…é¡» | é»˜è®¤å€¼ | å¤‡æ³¨          | å…¶ä»–ä¿¡æ¯          |
| ----------- | --------- | -------- | ------ | ------------- | ----------------- |
|             | object [] | å¿…é¡»     |        | è´­ç‰©è½¦skué›†åˆ | item ç±»å‹: object |
| â”œâ”€ skuId    | string    | å¿…é¡»     |        | skuId         |                   |
| â”œâ”€ selected | boolean   | å¿…é¡»     |        | æ˜¯å¦é€‰ä¸­      |                   |
| â”œâ”€ count    | integer   | å¿…é¡»     |        | æ•°é‡          |                   |

### ç™»å½•ååˆå¹¶è´­ç‰©è½¦

**è½åœ°ä»£ç **

1ï¼‰ç¼–å†™åˆå¹¶è´­ç‰©è½¦çš„ `actions` å‡½æ•°

- æ˜ å°„æ¥å£æ‰€éœ€å‚æ•°
- è°ƒç”¨åˆå¹¶è´­ç‰©è½¦çš„æ¥å£
- ä¸»åŠ¨è·å–æœ€æ–°åˆ—è¡¨

è´­ç‰©è½¦æ¨¡å—ï¼š`src/store/modules/cart.js`

```js
actions: {
    // åˆå¹¶è´­ç‰©è½¦
    async mergeLocalCart() {
      // æ˜ å°„æ¥å£æ‰€éœ€å‚æ•°
      const data = this.list.map(({ skuId, selected, count }) => ({
        skuId,
        selected,
        count,
      }));
      // è°ƒç”¨åˆå¹¶è´­ç‰©è½¦çš„æ¥å£
      await http("POST", "/member/cart/merge", data);
      // åˆå¹¶æˆåŠŸï¼Œé‡æ–°è·å–è´­ç‰©è½¦åˆ—è¡¨
      this.getCartList();
    },
}
```

2ï¼‰åœ¨ç™»å½•å®ŒæˆåŠŸåï¼Œè°ƒç”¨åˆå¹¶è´­ç‰©è½¦ `actions`  å‡½æ•°

ç”¨æˆ·æ¨¡å—ï¼š`src\store\modules\member.ts`

```diff
const useMemberStore = defineStore("member", {
  ...
  // æ–¹æ³•
  actions: {
    // ç™»å½•æˆåŠŸé€šç”¨ä¸šåŠ¡
    loginSuccess(profile: Profile) {
      // ç™»å½•æˆåŠŸåçš„ä¸šåŠ¡
      // 1. æˆåŠŸæç¤º
      message({ type: 'success', text: 'ç™»å½•æˆåŠŸ~' });
      // 2. å­˜å‚¨æ•°æ®
      this.profile = profile;
      // è·å–ç›®æ ‡é¡µé¢ targetï¼Œå¦‚æœæ²¡æœ‰ç›®æ ‡é¡µï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ '/' å»é¦–é¡µ
      const { target = '/' } = router.currentRoute.value.query;
      // 3. è·³è½¬é¡µé¢
      router.push(target as string);
+      // 4. åˆå¹¶è´­ç‰©è½¦
+      const { cart } = useStore();
+      cart.mergeLocalCart();
    },
  },
});

```


